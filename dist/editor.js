/**
 * Pixelite: Real-time collaborative pixel art editor with animation support
 * Copyright (C) RETORA 2026
 * Licensed under the Pixelite License (see LICENSE file for full terms)
 * 
 * Source: https://github.com/RetoraDev/pixelite
 * Version: v1.0.0
 * Built: 2/28/2026, 3:08:11 PM
 * Platform: Web
 * Debug: false
 * Minified: true
 */

const COPYRIGHT="(C) RETORA 2026",VERSION="v1.0.0",HOST="wss://pixelite.onrender.com",DEBUG=!1;window.__=function(e){if("string"!=typeof e)return e;const t=window.settings?.getLanguage?.()||0;return e=(e=e.replace(/([^|(]+\|\|[^|)]+)/g,e=>{const i=e.split("||");return i[t]||i[0]})).replace(/\(([^)|]+)\|([^)]+)\)/g,(e,i,s)=>0===t?i:s)},window.openExternalUrl=e=>{const t=encodeURI(e);if(null!=typeof window.cordova)navigator.app.loadUrl(t,{openExternal:!0});else{const e=document.createElement("a");e.href=t,e.target="_blank",e.click()}};class SettingsManager{constructor(e){this.editor=e,this.categories=[],this.settings=new Map,this.values=new Map,this.listeners=new Map,this.initialized=!1,this.language=0,this.load()}addCategory(e){const t={id:e.id||`category-${this.categories.length}`,title:e.title||"Category",icon:e.icon||"icon-settings",settings:[],addSetting:t=>this.addSetting(e.id,t)};return this.categories.push(t),t}addSetting(e,t){const i=this.categories.find(t=>t.id===e);if(!i)throw new Error(`Category ${e} not found`);const s={id:t.id||`setting-${Date.now()}-${Math.random()}`,label:t.label||"Setting",description:t.description||"",type:t.type||"boolean",defaultValue:t.defaultValue,value:t.defaultValue,options:t.options||[],min:t.min,max:t.max,step:t.step,needsReload:t.needsReload||!1,onInit:t.onInit||null,onUpdate:t.onUpdate||null,visible:!1!==t.visible,disabled:t.disabled||!1};i.settings.push(s),this.settings.set(s.id,s);const a=this.values.get(s.id);return void 0!==a?s.value=a:this.values.set(s.id,s.defaultValue),s}get(e){return this.values.get(e)}getLanguage(){return this.language}set(e,t,i=!1){const s=this.settings.get(e);if(!s)return!1;const a=this.values.get(e);return a!==t&&(this.values.set(e,t),s.value=t,s.onUpdate&&s.onUpdate(t,a,this.editor),this.listeners.has(e)&&this.listeners.get(e).forEach(e=>e(t,a)),i||this.save(),s.needsReload&&(this.pendingReload=!0),!0)}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{const i=this.listeners.get(e),s=i.indexOf(t);s>-1&&i.splice(s,1)}}init(){this.initialized||(this.settings.forEach(e=>{e.onInit&&e.onInit(this.get(e.id),this.editor)}),this.initialized=!0)}save(){const e={language:this.language,values:{}};this.values.forEach((t,i)=>{e.values[i]=t}),localStorage.setItem("app_settings",JSON.stringify(e))}load(){try{const e=localStorage.getItem("app_settings");if(e){const t=JSON.parse(e);this.language=t.language||0,t.values&&Object.entries(t.values).forEach(([e,t])=>{this.values.set(e,t)})}}catch(e){console.warn("Failed to load settings:",e)}}reset(e){const t=this.settings.get(e);t&&this.set(e,t.defaultValue)}resetAll(){this.settings.forEach(e=>{this.set(e.id,e.defaultValue,!0)}),this.save()}isRestartNeeded(){return this.pendingReload||!1}}class SettingsUI{constructor(e,t){this.settings=e,this.editor=t,this.visible=!1,this.initUI()}initUI(){this.overlay=document.createElement("div"),this.overlay.className="settings-overlay",this.overlay.style.display="none",this.container=document.createElement("div"),this.container.className="settings-container",this.overlay.appendChild(this.container),this.header=document.createElement("div"),this.header.className="settings-header",this.container.appendChild(this.header),this.title=document.createElement("div"),this.title.className="settings-title",this.title.textContent=__("Ajustes||Settings"),this.header.appendChild(this.title),this.closeBtn=document.createElement("button"),this.closeBtn.className="settings-close",this.closeBtn.innerHTML="&times;",this.closeBtn.addEventListener("click",()=>this.hide()),this.header.appendChild(this.closeBtn),this.mainContent=document.createElement("div"),this.mainContent.className="settings-main",this.container.appendChild(this.mainContent),this.sidebar=document.createElement("div"),this.sidebar.className="settings-sidebar",this.mainContent.appendChild(this.sidebar),this.content=document.createElement("div"),this.content.className="settings-content",this.mainContent.appendChild(this.content),this.footer=document.createElement("div"),this.footer.className="settings-footer",this.container.appendChild(this.footer),this.resetAllBtn=document.createElement("button"),this.resetAllBtn.className="settings-btn secondary",this.resetAllBtn.textContent=__("Restablecer todo||Reset all"),this.resetAllBtn.addEventListener("click",()=>this.showResetConfirm()),this.footer.appendChild(this.resetAllBtn),this.doneBtn=document.createElement("button"),this.doneBtn.className="settings-btn primary",this.doneBtn.textContent=__("Hecho||Done"),this.doneBtn.addEventListener("click",()=>this.hide()),this.footer.appendChild(this.doneBtn),document.body.appendChild(this.overlay),this.buildCategories(),this.settings.categories.length>0&&this.showCategory(this.settings.categories[0].id)}buildCategories(){this.sidebar.innerHTML="",this.settings.categories.forEach(e=>{const t=document.createElement("div");t.className="settings-category-item",t.dataset.category=e.id;const i=document.createElement("span");i.className=`icon ${e.icon}`;const s=document.createElement("span");s.textContent=__(e.title),t.appendChild(i),t.appendChild(s),t.addEventListener("click",()=>this.showCategory(e.id)),this.sidebar.appendChild(t)})}showCategory(e){document.querySelectorAll(".settings-category-item").forEach(t=>{t.classList.toggle("active",t.dataset.category===e)});const t=this.settings.categories.find(t=>t.id===e);if(!t)return;this.content.innerHTML="";const i=document.createElement("h3");i.className="settings-category-title",i.textContent=__(t.title),this.content.appendChild(i),t.settings.forEach(e=>{if(!e.visible)return;const t=this.createSettingElement(e);this.content.appendChild(t)})}createSettingElement(e){const t=document.createElement("div");t.className="setting-item "+(e.disabled?"disabled":""),t.dataset.setting=e.id;const i=document.createElement("div");i.className="setting-info";const s=document.createElement("div");s.className="setting-label",s.textContent=__(e.label);const a=document.createElement("div");a.className="setting-description",a.textContent=__(e.description),i.appendChild(s),i.appendChild(a);const o=document.createElement("div");switch(o.className="setting-control",e.type){case"boolean":this.createBooleanControl(o,e);break;case"number":case"range":this.createRangeControl(o,e);break;case"select":this.createSelectControl(o,e);break;case"text":this.createTextControl(o,e);break;case"color":this.createColorControl(o,e)}return t.appendChild(i),t.appendChild(o),t}createBooleanControl(e,t){const i=document.createElement("label");i.className="switch";const s=document.createElement("input");s.type="checkbox",s.checked=this.settings.get(t.id),s.disabled=t.disabled;const a=document.createElement("span");a.className="slider",i.appendChild(s),i.appendChild(a),e.appendChild(i),s.addEventListener("change",e=>{this.settings.set(t.id,e.target.checked),t.needsReload&&this.showRestartWarning()}),this.settings.subscribe(t.id,e=>{s.checked=e})}createRangeControl(e,t){const i=document.createElement("div");i.className="range-wrapper";const s=document.createElement("input");s.type="range",s.min=t.min||0,s.max=t.max||100,s.step=t.step||1,s.value=this.settings.get(t.id),s.disabled=t.disabled;const a=document.createElement("input");a.className="range-value",a.type="number",a.min=t.min||0,a.max=t.max||100,a.value=s.value,a.disabled=t.disabled,i.appendChild(s),i.appendChild(a),e.appendChild(i),s.addEventListener("input",e=>{a.value=e.target.value}),a.addEventListener("input",e=>{s.value=e.target.value});const o=e=>{this.settings.set(t.id,parseInt(e.target.value)),t.needsReload&&this.showRestartWarning()};s.addEventListener("change",e=>o(e)),a.addEventListener("change",e=>o(e)),this.settings.subscribe(t.id,e=>{s.value=e,a.value=e})}createSelectControl(e,t){const i=document.createElement("select");i.disabled=t.disabled,t.options.forEach(e=>{const s=document.createElement("option");s.value=e.value,s.textContent=__(e.label),s.selected=e.value===this.settings.get(t.id),i.appendChild(s)}),e.appendChild(i),i.addEventListener("change",e=>{this.settings.set(t.id,e.target.value),t.needsReload&&this.showRestartWarning()}),this.settings.subscribe(t.id,e=>{i.value=e})}createTextControl(e,t){const i=document.createElement("input");i.type="text",i.value=this.settings.get(t.id),i.disabled=t.disabled,i.placeholder=t.placeholder||"",e.appendChild(i),i.addEventListener("change",e=>{this.settings.set(t.id,e.target.value),t.needsReload&&this.showRestartWarning()}),this.settings.subscribe(t.id,e=>{i.value=e})}createColorControl(e,t){const i=document.createElement("div");i.className="color-wrapper";const s=document.createElement("input");s.type="color",s.value=this.settings.get(t.id),s.disabled=t.disabled;const a=document.createElement("input");a.type="text",a.value=this.settings.get(t.id),a.disabled=t.disabled,i.appendChild(s),i.appendChild(a),e.appendChild(i),s.addEventListener("input",e=>{a.value=e.target.value}),a.addEventListener("input",e=>{/^#[0-9A-F]{6}$/i.test(e.target.value)&&(s.value=e.target.value)}),s.addEventListener("change",e=>{this.settings.set(t.id,e.target.value),t.needsReload&&this.showRestartWarning()}),a.addEventListener("change",e=>{/^#[0-9A-F]{6}$/i.test(e.target.value)&&this.settings.set(t.id,e.target.value)}),this.settings.subscribe(t.id,e=>{s.value=e,a.value=e})}showRestartWarning(){if(this.restartWarningShown)return;this.restartWarningShown=!0;const e=document.createElement("div");e.className="settings-restart-warning";const t=document.createElement("span");t.textContent=__("Algunos cambios requieren reiniciar||Some changes require restart");const i=document.createElement("button");i.className="settings-btn small",i.textContent=__("Reiniciar||Restart"),i.addEventListener("click",()=>{this.editor?this.editor.showPopup(__("Reiniciar aplicación||Restart app"),__("¿Reiniciar la app? Los cambios sin guardar se perderán||Restart the app? Unsaved changes will be lost"),[{text:__("No||No"),class:"cancel",action:()=>{this.editor.hidePopup()}},{text:__("Sí||Yes"),action:()=>{window.location.reload()}}]):window.location.reload()}),e.appendChild(t),e.appendChild(i),this.container.appendChild(e),setTimeout(()=>{e.parentNode&&(e.remove(),this.restartWarningShown=!1)},5e3)}showResetConfirm(){this.editor&&this.editor.showPopup(__("Restablecer ajustes||Reset settings"),__("¿Estás seguro?||Are you sure?"),[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.editor.hidePopup()},{text:__("Restablecer||Reset"),action:()=>{this.settings.resetAll(),this.showCategory(this.settings.categories[0].id),this.editor.hidePopup()}}])}show(){this.overlay.style.display="flex",this.visible=!0,this.buildCategories(),this.settings.categories.length>0&&this.showCategory(this.settings.categories[0].id)}hide(){this.overlay.style.display="none",this.visible=!1}toggle(){this.visible?this.hide():this.show()}}class GridManager{constructor(e){this.editor=e,this.grids=[],this.panelVisible=!1,this.initOverlay(),this.initUI()}initOverlay(){this.overlay=document.querySelector(".grid-overlay"),this.overlay||(this.overlay=document.createElement("div"),this.overlay.className="grid-overlay",this.editor.canvasContainer.appendChild(this.overlay))}initUI(){this.panel=document.createElement("div"),this.panel.className="grid-panel";const e=document.createElement("div");e.className="grid-panel-header";const t=document.createElement("div");t.className="grid-panel-title",t.textContent=__("Cuadrículas||Grids");const i=document.createElement("button");i.className="grid-panel-close",i.innerHTML="&times;",i.addEventListener("click",()=>this.hide()),e.appendChild(t),e.appendChild(i),this.panel.appendChild(e);const s=document.createElement("div");s.className="grid-toolbar";const a=document.createElement("button");a.className="grid-btn primary",a.innerHTML=`\n      <span class="icon icon-add"></span>\n      <span>${__("Añadir cuadrícula||Add grid")}</span>\n    `,a.addEventListener("click",()=>this.addGrid()),s.appendChild(a),this.panel.appendChild(s),this.listContainer=document.createElement("div"),this.listContainer.className="grid-list",this.panel.appendChild(this.listContainer),this.editor.uiLayer.appendChild(this.panel)}addGrid(){const e={id:"grid_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),name:__("Cuadrícula||Grid")+" "+(this.grids.length+1),size:8,color:"#ff0000",opacity:.3,enabled:!0,type:"square"};this.grids.push(e),this.renderList(),this.renderGrids()}removeGrid(e){this.grids=this.grids.filter(t=>t.id!==e),this.renderList(),this.renderGrids()}updateGrid(e,t){const i=this.grids.find(t=>t.id===e);i&&(Object.assign(i,t),this.renderList(),this.renderGrids())}renderList(){if(this.listContainer.innerHTML="",0===this.grids.length){const e=document.createElement("div");return e.className="grid-empty",e.textContent=__("Sin cuadrículas||No grids"),void this.listContainer.appendChild(e)}this.grids.forEach(e=>{const t=document.createElement("div");t.className="grid-item",t.dataset.id=e.id;const i=document.createElement("div");i.className="grid-preview",i.style.backgroundColor=e.color+Math.floor(255*e.opacity).toString(16).padStart(2,"0");const s=document.createElement("div");s.className="grid-info";const a=document.createElement("div");a.className="grid-name-row";const o=document.createElement("input");o.type="text",o.className="grid-name-input",o.value=e.name,o.addEventListener("change",()=>{this.updateGrid(e.id,{name:o.value})});const n=document.createElement("label");n.className="grid-toggle";const r=document.createElement("input");r.type="checkbox",r.checked=e.enabled,r.addEventListener("change",()=>{this.updateGrid(e.id,{enabled:r.checked})});const l=document.createElement("span");l.className="grid-toggle-slider",n.appendChild(r),n.appendChild(l),a.appendChild(o),a.appendChild(n);const c=document.createElement("div");c.className="grid-controls";const h=document.createElement("div");h.className="grid-control";const d=document.createElement("span");d.className="grid-control-label",d.textContent=__("Tamaño||Size")+":";const p=document.createElement("input");p.type="number",p.className="grid-number-input",p.min=1,p.max=128,p.step=1,p.value=e.size,p.addEventListener("change",()=>{let t=parseInt(p.value);isNaN(t)&&(t=e.size),t=Math.max(1,Math.min(128,t)),p.value=t,this.updateGrid(e.id,{size:t})});const m=document.createElement("span");m.className="grid-unit",m.textContent="px",h.appendChild(d),h.appendChild(p),h.appendChild(m);const u=document.createElement("div");u.className="grid-control";const g=document.createElement("span");g.className="grid-control-label",g.textContent=__("Color||Color")+":";const v=document.createElement("input");v.type="color",v.className="grid-color-input",v.value=e.color,v.addEventListener("change",()=>{this.updateGrid(e.id,{color:v.value})}),u.appendChild(g),u.appendChild(v);const y=document.createElement("div");y.className="grid-control";const f=document.createElement("span");f.className="grid-control-label",f.textContent=__("Opacidad||Opacity")+":";const C=document.createElement("input");C.type="number",C.className="grid-number-input",C.min=0,C.max=100,C.step=1,C.value=Math.round(100*e.opacity),C.addEventListener("change",()=>{let t=parseInt(C.value);isNaN(t)&&(t=Math.round(100*e.opacity)),t=Math.max(0,Math.min(100,t)),C.value=t,this.updateGrid(e.id,{opacity:t/100})});const b=document.createElement("span");b.className="grid-unit",b.textContent="%",y.appendChild(f),y.appendChild(C),y.appendChild(b);const w=document.createElement("button");w.className="grid-remove-btn",w.innerHTML="&times;",w.title=__("Eliminar||Remove"),w.addEventListener("click",()=>this.removeGrid(e.id)),c.appendChild(h),c.appendChild(u),c.appendChild(y),s.appendChild(a),s.appendChild(c),t.appendChild(i),t.appendChild(s),t.appendChild(w),this.listContainer.appendChild(t)})}renderGrids(){this.overlay.innerHTML="";const e=this.editor.canvasContainer.getBoundingClientRect(),t=e.width/2+this.editor.posX-this.editor.project.width/2*this.editor.scale,i=e.height/2+this.editor.posY-this.editor.project.height/2*this.editor.scale,s=this.editor.project.width*this.editor.scale,a=this.editor.project.height*this.editor.scale;Object.assign(this.overlay.style,{position:"absolute",left:t+"px",top:i+"px",width:s+"px",height:a+"px",pointerEvents:"none",zIndex:"5"}),this.grids.forEach(e=>{if(!e.enabled)return;const t=document.createElement("div");t.className="grid-layer";const i=`linear-gradient(to bottom, \n        ${e.color} 1px, \n        transparent 1px\n      )`,s=`linear-gradient(to right, \n        ${e.color} 1px, \n        transparent 1px\n      )`,a=Math.max(1,e.size*this.editor.scale);Object.assign(t.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",backgroundImage:`${s}, ${i}`,backgroundSize:`${a}px ${a}px`,backgroundPosition:"0 0",backgroundRepeat:"repeat",opacity:e.opacity,pointerEvents:"none",zIndex:"10"}),this.overlay.appendChild(t)})}show(){this.editor.animationPanel&&this.editor.animationPanel.classList.remove("visible"),this.editor.layersPanel&&this.editor.layersPanel.classList.remove("visible"),this.editor.animationButton&&this.editor.animationButton.classList.remove("active"),this.editor.layersButton&&this.editor.layersButton.classList.remove("active"),this.panel.classList.add("visible"),this.panelVisible=!0,this.renderList(),this.renderGrids()}hide(){this.panel.classList.remove("visible"),this.panelVisible=!1}toggle(){this.panelVisible?this.hide():this.show()}updateTransform(){this.renderGrids()}}class HistoryManager{constructor(e){this.editor=e,this.history=[],this.historyIndex=-1,this.maxHistoryLength=1/0,this.currentBatch=null}startBatch(e,t){this.currentBatch&&this.endBatch(),this.currentBatch={type:e,description:t,timestamp:Date.now(),operations:[]}}endBatch(){this.currentBatch&&this.currentBatch.operations.length>0&&this.addToHistory(this.currentBatch),this.currentBatch=null}addChange(e){this.currentBatch?this.currentBatch.operations.push(e):this.addToHistory({type:e.type,description:e.description,timestamp:Date.now(),operations:[e]})}addToHistory(e){this.history=this.history.slice(0,this.historyIndex+1),this.history.push(e),this.historyIndex++,this.history.length>this.maxHistoryLength&&(this.history.shift(),this.historyIndex--)}undo(){if(this.historyIndex<0)return null;const e=this.history[this.historyIndex];return this.applyHistoryEntry(e,!0),this.historyIndex--,{entry:e,message:`Undo '${e.description}'`}}redo(){if(this.historyIndex>=this.history.length-1)return null;this.historyIndex++;const e=this.history[this.historyIndex];return this.applyHistoryEntry(e,!1),{entry:e,message:`Redo '${e.description}'`}}applyHistoryEntry(e,t){(t?[...e.operations].reverse():e.operations).forEach(e=>{switch(e.type){case"draw":this.applyDrawOperation(e,t);break;case"add_frame":this.applyAddFrameOperation(e,t);break;case"remove_frame":this.applyRemoveFrameOperation(e,t);break;case"edit_frame":this.applyEditFrameOperation(e,t);break;case"move_frame":this.applyMoveFrameOperation(e,t);break;case"change_animation_fps":this.applyChangeFPSOperation(e,t);break;case"add_layer":this.applyAddLayerOperation(e,t);break;case"remove_layer":this.applyRemoveLayerOperation(e,t);break;case"change_layer_visibility":this.applyLayerVisibilityOperation(e,t);break;case"move_layer":this.applyMoveLayerOperation(e,t);break;case"transform":this.applyTransformOperation(e,t);break;case"color_adjustment":this.applyColorAdjustmentOperation(e,t)}}),this.editor.updateFramesUI(),this.editor.updateLayersUI(),this.editor.render()}applyDrawAction(e){const{data:t}=e,i=this.editor.project?.frames[t.frame];if(!i)return;const s=i.layers[t.layer];if(!s)return;const a=s.ctx;switch(t.type){case"fillRect":a.fillStyle=t.color,a.fillRect(t.x,t.y,t.w,t.h);break;case"clearRect":a.clearRect(t.x,t.y,t.w,t.h)}}applyDrawOperation(e,t){const{frameIndex:i,layerIndex:s,pixels:a}=e,o=this.editor.project.frames[i].layers[s].ctx;a.forEach(e=>{const{x:i,y:s,oldColor:a,newColor:n}=e,r=t?a:n;"transparent"===r?o.clearRect(i,s,1,1):(o.fillStyle=r,o.fillRect(i,s,1,1))})}applyAddFrameOperation(e,t){if(t)this.editor.project.frames.splice(e.index,1),this.editor.frameTimes.splice(e.index,1);else{const t={layers:e.layers.map(e=>{const t=this.editor.createBlankLayer(this.editor.project.width,this.editor.project.height,e.name);if(t.visible=e.visible,e.imageData){const i=t.ctx,s=new ImageData(new Uint8ClampedArray(e.imageData),this.editor.project.width,this.editor.project.height);i.putImageData(s,0,0)}return t})};this.editor.project.frames.splice(e.index,0,t),this.editor.frameTimes.splice(e.index,0,e.frameTime)}}applyRemoveFrameOperation(e,t){if(t){const t={layers:e.layers.map(e=>{const t=this.editor.createBlankLayer(this.editor.project.width,this.editor.project.height,e.name);if(t.visible=e.visible,e.imageData){const i=t.ctx,s=new ImageData(new Uint8ClampedArray(e.imageData),this.editor.project.width,this.editor.project.height);i.putImageData(s,0,0)}return t})};this.editor.project.frames.splice(e.index,0,t),this.editor.frameTimes.splice(e.index,0,e.frameTime)}else this.editor.project.frames.splice(e.index,1),this.editor.frameTimes.splice(e.index,1)}applyEditFrameOperation(e,t){const{frameIndex:i,property:s,oldValue:a,newValue:o}=e;"time"===s&&(this.editor.frameTimes[i]=t?a:o)}applyMoveFrameOperation(e,t){const{fromIndex:i,toIndex:s}=e;if(t){const e=this.editor.project.frames.splice(s,1)[0],t=this.editor.frameTimes.splice(s,1)[0];this.editor.project.frames.splice(i,0,e),this.editor.frameTimes.splice(i,0,t)}else{const e=this.editor.project.frames.splice(i,1)[0],t=this.editor.frameTimes.splice(i,1)[0];this.editor.project.frames.splice(s,0,e),this.editor.frameTimes.splice(s,0,t)}}applyChangeFPSOperation(e,t){this.editor.animationFPS=t?e.oldFPS:e.newFPS,this.editor.currentFrameTime=1e3/this.editor.animationFPS,this.editor.fpsInput.value=this.editor.animationFPS}applyAddLayerOperation(e,t){const{frameIndex:i,layerIndex:s,layerData:a}=e,o=this.editor.project.frames[i];if(t)o.layers.splice(s,1);else{const e=this.editor.createBlankLayer(this.editor.project.width,this.editor.project.height,a.name);if(e.visible=a.visible,a.imageData){const t=e.ctx,i=new ImageData(new Uint8ClampedArray(a.imageData),this.editor.project.width,this.editor.project.height);t.putImageData(i,0,0)}o.layers.splice(s,0,e)}}applyRemoveLayerOperation(e,t){const{frameIndex:i,layerIndex:s,layerData:a}=e,o=this.editor.project.frames[i];if(t){const e=this.editor.createBlankLayer(this.editor.project.width,this.editor.project.height,a.name);if(e.visible=a.visible,a.imageData){const t=e.ctx,i=new ImageData(new Uint8ClampedArray(a.imageData),this.editor.project.width,this.editor.project.height);t.putImageData(i,0,0)}o.layers.splice(s,0,e)}else o.layers.splice(s,1)}applyLayerVisibilityOperation(e,t){const{frameIndex:i,layerIndex:s,visible:a}=e;this.editor.project.frames[i].layers[s].visible=t?!a:a}applyMoveLayerOperation(e,t){const{frameIndex:i,fromIndex:s,toIndex:a}=e,o=this.editor.project.frames[i];if(t){const e=o.layers.splice(a,1)[0];o.layers.splice(s,0,e)}else{const e=o.layers.splice(s,1)[0];o.layers.splice(a,0,e)}}applyTransformOperation(e,t){const{frameIndex:i,layerIndex:s,transformType:a,transformData:o}=e,n=this.editor.project.frames[i].layers[s].ctx,r=new ImageData(new Uint8ClampedArray(t?o.oldImageData:o.newImageData),this.editor.project.width,this.editor.project.height);n.putImageData(r,0,0)}applyColorAdjustmentOperation(e,t){const{frameIndex:i,layerIndex:s,adjustmentType:a,adjustmentData:o}=e,n=this.editor.project.frames[i].layers[s].ctx,r=new ImageData(new Uint8ClampedArray(t?o.oldImageData:o.newImageData),this.editor.project.width,this.editor.project.height);n.putImageData(r,0,0)}async generateTimelapse(e,t,i){const s=this.editor.getNewProjectData(this.editor.project.width,this.editor.project.height),a=[...this.editor.frameTimes],{canvas:o,ctx:n}=this.editor.getTempCanvas(s.width*t,s.height*t),r=o.captureStream(),l=new MediaRecorder(r,{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:8e6}),c=[];return l.ondataavailable=e=>{e.data.size>0&&c.push(e.data)},new Promise(r=>{l.onstop=()=>{const e=new Blob(c,{type:"video/webm"});r(e)},l.start(),this.replayHistoryForTimelapse(s,a,o,n,t,e,i,()=>{setTimeout(()=>l.stop(),1e3/e)})})}async replayHistoryForTimelapse(e,t,i,s,a,o,n,r){const l=1e3/o;let c=0,h=e.currentFrame||0;const d=async()=>{if(c>=this.history.length)return void r();const a=this.history[c];this.applyHistoryEntryToProject(a,e,t,!1);const o=e.currentFrame||0;h=o,s.clearRect(0,0,i.width,i.height),this.editor.transparentBackground?(s.fillStyle="#ffffff",s.fillRect(0,0,i.width,i.height)):(s.fillStyle=this.editor.secondaryColor,s.fillRect(0,0,i.width,i.height));const p=document.createElement("canvas");p.width=e.width,p.height=e.height;const m=this.editor.getCanvasContext(p),u=e.frames[o];for(let t=0;t<u.layers.length;t++){const a=u.layers[t];if(a.visible){if(m.clearRect(0,0,e.width,e.height),a.imageData){const t=new ImageData(new Uint8ClampedArray(a.imageData),e.width,e.height);m.putImageData(t,0,0)}else a.canvas&&m.drawImage(a.canvas,0,0);s.imageSmoothingEnabled=!1,s.drawImage(p,0,0,e.width,e.height,0,0,i.width,i.height)}}n(Math.floor(c/this.history.length*100),i.toDataURL()),c++,c<this.history.length?setTimeout(d,l):setTimeout(()=>{r()},l)};d()}applyHistoryEntryToProject(e,t,i,s){(s?[...e.operations].reverse():e.operations).forEach(e=>{switch(e.type){case"add_frame":this.applyAddFrameToProject(e,t,i,s);break;case"remove_frame":this.applyRemoveFrameToProject(e,t,i,s);break;case"edit_frame":"time"===e.property&&(i[e.frameIndex]=s?e.oldValue:e.newValue);break;case"move_frame":this.applyMoveFrameToProject(e,t,i,s);break;case"change_animation_fps":break;case"add_layer":this.applyAddLayerToProject(e,t,s);break;case"remove_layer":this.applyRemoveLayerToProject(e,t,s);break;case"change_layer_visibility":t.frames[e.frameIndex].layers[e.layerIndex].visible=s?!e.visible:e.visible;break;case"move_layer":this.applyMoveLayerToProject(e,t,s)}})}applyHistoryEntryToProject(e,t,i,s){(s?[...e.operations].reverse():e.operations).forEach(e=>{switch(e.type){case"add_frame":this.applyAddFrameToProject(e,t,i,s);break;case"remove_frame":this.applyRemoveFrameToProject(e,t,i,s);break;case"edit_frame":"time"===e.property&&(i[e.frameIndex]=s?e.oldValue:e.newValue);break;case"move_frame":this.applyMoveFrameToProject(e,t,i,s);break;case"change_animation_fps":break;case"add_layer":this.applyAddLayerToProject(e,t,s);break;case"remove_layer":this.applyRemoveLayerToProject(e,t,s);break;case"change_layer_visibility":const a=t.frames[e.frameIndex];a&&a.layers[e.layerIndex]&&(a.layers[e.layerIndex].visible=s?!e.visible:e.visible);break;case"move_layer":this.applyMoveLayerToProject(e,t,s);break;case"transform":this.applyTransformToProject(e,t,s);break;case"color_adjustment":this.applyColorAdjustmentToProject(e,t,s);break;case"draw":this.applyDrawToProject(e,t,s)}})}applyAddFrameToProject(e,t,i,s){if(s)t.frames.splice(e.index,1),i.splice(e.index,1);else{const s={layers:e.layers.map(e=>{const i=document.createElement("canvas"),s={canvas:i,ctx:this.getCanvasContext(i),visible:e.visible,name:e.name};if(s.canvas.width=t.width,s.canvas.height=t.height,e.imageData){const i=s.ctx,a=new ImageData(new Uint8ClampedArray(e.imageData),t.width,t.height);i.putImageData(a,0,0)}return s})};t.frames.splice(e.index,0,s),i.splice(e.index,0,e.frameTime)}}applyRemoveFrameToProject(e,t,i,s){if(s){const s={layers:e.layers.map(e=>{const i=document.createElement("canvas"),s={canvas:i,ctx:this.getCanvasContext(i),visible:e.visible,name:e.name};if(s.canvas.width=t.width,s.canvas.height=t.height,e.imageData){s.ctx.putImageData(new ImageData(new Uint8ClampedArray(e.imageData),t.width,t.height),0,0)}return s})};t.frames.splice(e.index,0,s),i.splice(e.index,0,e.frameTime)}else t.frames.splice(e.index,1),i.splice(e.index,1)}applyMoveFrameToProject(e,t,i,s){const{fromIndex:a,toIndex:o}=e;if(s){const e=t.frames.splice(o,1)[0],s=i.splice(o,1)[0];t.frames.splice(a,0,e),i.splice(a,0,s)}else{const e=t.frames.splice(a,1)[0],s=i.splice(a,1)[0];t.frames.splice(o,0,e),i.splice(o,0,s)}}applyAddLayerToProject(e,t,i){const{frameIndex:s,layerIndex:a,layerData:o}=e,n=t.frames[s];if(i)n.layers.splice(a,1);else{const e=document.createElement("canvas"),i={canvas:e,ctx:this.getCanvasContext(e),visible:o.visible,name:o.name};if(i.canvas.width=t.width,i.canvas.height=t.height,o.imageData){const e=i.ctx,s=new ImageData(new Uint8ClampedArray(o.imageData),t.width,t.height);e.putImageData(s,0,0)}n.layers.splice(a,0,i)}}applyRemoveLayerToProject(e,t,i){const{frameIndex:s,layerIndex:a,layerData:o}=e,n=t.frames[s];if(i){const e=document.createElement("canvas"),i={canvas:e,ctx:this.getCanvasContext(e),visible:o.visible,name:o.name};if(i.canvas.width=t.width,i.canvas.height=t.height,o.imageData){i.ctx.putImageData(new ImageData(new Uint8ClampedArray(o.imageData),t.width,t.height),0,0)}n.layers.splice(a,0,i)}else n.layers.splice(a,1)}applyMoveLayerToProject(e,t,i){const{frameIndex:s,fromIndex:a,toIndex:o}=e,n=t.frames[s];if(i){const e=n.layers.splice(o,1)[0];n.layers.splice(a,0,e)}else{const e=n.layers.splice(a,1)[0];n.layers.splice(o,0,e)}}applyTransformToProject(e,t,i){const{frameIndex:s,layerIndex:a,transformData:o}=e,n=t.frames[s].layers[a];n.canvas||(n.canvas=document.createElement("canvas"),n.canvas.width=t.width,n.canvas.height=t.height);const r=n.ctx,l=new ImageData(new Uint8ClampedArray(i?o.oldImageData:o.newImageData),o.oldWidth||t.width,o.oldHeight||t.height);r.putImageData(l,0,0),o.newWidth&&o.newHeight&&(n.canvas.width=i?o.oldWidth:o.newWidth,n.canvas.height=i?o.oldHeight:o.newHeight)}applyColorAdjustmentToProject(e,t,i){const{frameIndex:s,layerIndex:a,adjustmentData:o}=e,n=t.frames[s].layers[a];n.canvas||(n.canvas=document.createElement("canvas"),n.canvas.width=t.width,n.canvas.height=t.height);const r=n.ctx,l=new ImageData(new Uint8ClampedArray(i?o.oldImageData:o.newImageData),t.width,t.height);r.putImageData(l,0,0)}applyDrawToProject(e,t,i){const{frameIndex:s,layerIndex:a,pixels:o}=e,n=t.frames[s].layers[a];t.currentFrame=s,t.currentLayer=a,n.canvas||(n.canvas=document.createElement("canvas"),n.canvas.width=t.width,n.canvas.height=t.height);const r=n.ctx;o.forEach(e=>{const{x:t,y:s,oldColor:a,newColor:o}=e,n=i?a:o;"transparent"===n?r.clearRect(t,s,1,1):(r.fillStyle=n,r.fillRect(t,s,1,1))})}serialize(){return JSON.stringify({history:this.history,historyIndex:this.historyIndex})}deserialize(e){try{const t=JSON.parse(e);return this.history=t.history||[],this.historyIndex=t.historyIndex||-1,!0}catch(e){return console.error("Error deserializing history:",e),!1}}clear(){this.history=[],this.historyIndex=-1,this.currentBatch=null}}class CollabManager{constructor(e){this.editor=e,this.ws=null,this.host=HOST,this.sessionId=null,this.sessionName="",this.memberId=null,this.memberName=this.editor.collabMemberName,this.memberColor=this.editor.collabMemberColor,this.isHost=!1,this.isConnected=!1,this.manualDisconnect=!1,this.chatVisible=!1,this.members=new Map,this.permissions={undoRedo:"host",addRemoveFrames:"everyone",addRemoveLayers:"everyone",draw:"everyone",chat:"everyone"},this.cursors=new Map,this.cursorContainer=null,this.currentTrace=null,this.tracePoints=[],this.chatMessages=[],this.lastCursorSend=0,this.CURSOR_THROTTLE=50,this.initUI()}getColorHex(e){return{red:"#ff4444",blue:"#4444ff",green:"#44ff44",yellow:"#ffff44",orange:"#ff5722",purple:"#aa44ff",pink:"#ff44aa",cyan:"#44ffff",brown:"#8b4513",gray:"#888888",lime:"#aaff44",indigo:"#4b0082"}[e]||"#ffffff"}wrapMemberName(e,t){return`<span style="color:${this.getColorHex(e.color)}">${t||e.name}</span>`}initUI(){this.cursorContainer=document.createElement("div"),this.cursorContainer.className="collab-cursor-container",this.editor.uiLayer.appendChild(this.cursorContainer),this.chatButton=document.createElement("button"),this.chatButton.className="collab-chat-button",this.chatButton.textContent="Chat",this.chatButton.addEventListener("click",()=>this.openChat()),this.editor.animationPanel.appendChild(this.chatButton),this.chatContainer=document.createElement("div"),this.chatContainer.className="collab-chat-container",this.chatMessagesDiv=document.createElement("div"),this.chatMessagesDiv.className="collab-chat-messages",this.chatContainer.appendChild(this.chatMessagesDiv);const e=document.createElement("div");e.className="panel-close collab-chat-close",e.innerHTML="&times;",e.addEventListener("click",()=>this.closeChat()),this.chatContainer.appendChild(e);const t=document.createElement("div");t.className="collab-chat-input-container",this.chatInput=document.createElement("input"),this.chatInput.type="text",this.chatInput.placeholder=__("Escribe un mensaje...||Type a message..."),this.chatInput.className="collab-chat-input",this.chatInput.addEventListener("keydown",e=>{"Enter"===e.key&&this.chatInput.value.trim()&&(this.sendChatMessage(this.chatInput.value.trim()),this.chatInput.value="")});const i=document.createElement("button");i.innerHTML='\n      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">\n        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2"/>\n      </svg>\n    ',i.className="collab-chat-send",i.addEventListener("click",()=>{this.chatInput.value.trim()&&(this.sendChatMessage(this.chatInput.value.trim()),this.chatInput.value="")}),t.appendChild(this.chatInput),t.appendChild(i),this.chatContainer.appendChild(t),this.editor.animationPanel.appendChild(this.chatContainer),this.pingIndicator=document.createElement("div"),this.pingIndicator.className="collab-ping-indicator",this.pingIndicator.innerHTML='\n      <span class="ping-dot" style="background-color: #44ff44;"></span>\n      <span class="ping-value">---</span>\n    ',this.editor.uiLayer.appendChild(this.pingIndicator),this.createSessionOverlay()}createSessionOverlay(){this.sessionOverlay=document.createElement("div"),this.sessionOverlay.className="collab-session-overlay";const e=document.createElement("div");e.className="collab-session-header";const t=document.createElement("h2");t.className="collab-session-title",t.textContent=__("Sesión Colaborativa||Collaborative Session");const i=document.createElement("button");i.className="collab-close-btn",i.innerHTML="&times;",i.addEventListener("click",()=>{this.sessionOverlay.style.display="none"}),e.appendChild(t),e.appendChild(i),this.sessionContent=document.createElement("div"),this.sessionContent.className="collab-session-content",this.sessionOverlay.appendChild(e),this.sessionOverlay.appendChild(this.sessionContent),document.body.appendChild(this.sessionOverlay)}hookEditorMethods(){const e=this,t=this.editor.addFrame,i=this.editor.removeFrame,s=this.editor.moveFrame,a=this.editor.addLayer,o=this.editor.removeLayer,n=this.editor.moveLayer,r=this.editor.setLayerVisibility,l=this.editor.undo,c=this.editor.redo;this.editor._originalAddFrame=t,this.editor._originalRemoveFrame=i,this.editor._originalMoveFrame=s,this.editor._originalAddLayer=a,this.editor._originalRemoveLayer=o,this.editor._originalMoveLayer=n,this.editor._originalSetLayerVisibility=r,this.editor._originalUndo=l,this.editor._originalRedo=c,this.hookToolMethods(),this.editor.addFrame=function(...i){const s=t.call(this,...i);return e.isConnected&&e.canPerformAction("addRemoveFrames")&&e.sendFullState(),s},this.editor.removeFrame=function(...t){const s=i.call(this,...t);return e.isConnected&&e.canPerformAction("addRemoveFrames")&&e.sendFullState(),s},this.editor.moveFrame=function(...t){const i=s.call(this,...t);return e.isConnected&&e.canPerformAction("addRemoveFrames")&&e.sendFullState(),i},this.editor.addLayer=function(...t){const i=a.call(this,...t);return e.isConnected&&e.canPerformAction("addRemoveLayers")&&e.sendFullState(),i},this.editor.removeLayer=function(...t){const i=o.call(this,...t);return e.isConnected&&e.canPerformAction("addRemoveLayers")&&e.sendFullState(),i},this.editor.moveLayer=function(...t){const i=n.call(this,...t);return e.isConnected&&e.canPerformAction("addRemoveLayers")&&e.sendFullState(),i},this.editor.setLayerVisibility=function(...t){const i=r.call(this,...t);return e.isConnected&&e.canPerformAction("addRemoveLayers")&&e.sendFullState(),i},this.editor.undo=function(){if(e.isConnected&&!e.isHost&&!e.canPerformAction("undoRedo"))return void e.editor.showNotification(__("No tienes permiso para deshacer"),1e3);const t=l.call(this);return e.isConnected&&e.isHost&&e.sendFullState(),t},this.editor.redo=function(){if(e.isConnected&&!e.isHost&&!e.canPerformAction("undoRedo"))return void e.editor.showNotification(__("No tienes permiso para rehacer"),1e3);const t=c.call(this);return e.isConnected&&e.isHost&&e.sendFullState(),t}}hookToolMethods(){const e=this,t=this.editor.tools;Object.keys(t).forEach(i=>{const s=t[i],a=s.onDown,o=s.onMove,n=s.onUp;s.originalOnDown=a,s.originalOnMove=o,s.originalOnUp=n,s.onDown=function(t,s){e.isConnected&&e.canPerformAction("draw")&&(e.currentTrace={tool:i,brushSize:e.editor.brushSize,color:e.editor.getColor(),points:[{x:t,y:s}],frame:e.editor.project.currentFrame,layer:e.editor.project.currentLayer},e.tracePoints=[{x:t,y:s}]),a&&a.call(e.editor,t,s)},s.onMove=function(t,i){e.isConnected&&e.canPerformAction("draw")&&e.currentTrace&&(e.currentTrace.points.push({x:t,y:i}),e.sendCursorUpdate(t,i,!0)),o&&o.call(e.editor,t,i)},s.onUp=function(t,i,s,a){if(e.isConnected&&e.canPerformAction("draw")&&e.currentTrace){const s=e.currentTrace.points[e.currentTrace.points.length-1];s.x===t&&s.y===i||e.currentTrace.points.push({x:t,y:i}),e.sendTraceComplete(e.currentTrace),e.currentTrace=null,e.sendCursorUpdate(0,0,!1)}n&&n.call(e.editor,t,i,s,a)}})}restoreEditorMethods(){this.editor.addFrame=this.editor._originalAddFrame,this.editor.removeFrame=this.editor._originalRemoveFrame,this.editor.moveFrame=this.editor._originalMoveFrame,this.editor.addLayer=this.editor._originalAddLayer,this.editor.removeLayer=this.editor._originalRemoveLayer,this.editor.moveLayer=this.editor._originalMoveLayer,this.editor.setLayerVisibility=this.editor._originalSetLayerVisibility,this.editor.undo=this.editor._originalUndo,this.editor.redo=this.editor._originalRedo;const e=this.editor.tools;Object.keys(e).forEach(t=>{const i=e[t];i.onDown=i.originalOnDown,i.onMove=i.originalOnMove,i.onUp=i.originalOnUp})}updateMemberName(e){this.sendMessage({type:"name_update",oldName:this.memberName,newName:e}),this.memberName=e}updateMemberColor(e){this.sendMessage({type:"color_update",oldColor:this.memberColor,newColor:e}),this.memberColor=e}connectWebSocket(){this.ws&&this.ws.readyState===WebSocket.OPEN||(this.editor.showLoadingScreen(__("Conectando...||Connecting...")),this.ws=new WebSocket(this.host),this.ws.onopen=()=>{console.log("WebSocket connected"),this.editor.hideLoadingScreen(),this.manualDisconnect=!1,this.startPingInterval()},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleMessage(t)}catch(e){console.error("Error parsing message:",e)}},this.ws.onclose=()=>{console.log("WebSocket disconnected"),this.handleDisconnect()},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.editor.hideLoadingScreen(),this.editor.showNotification(__("Error de conexión||Connection error"),3e3)})}sendMessage(e){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(e))}handleMessage(e){switch(e.type){case"session_created":this.handleSessionCreated(e);break;case"session_joined":this.handleSessionJoined(e);break;case"member_joined":this.handleMemberJoined(e.member);break;case"member_left":this.handleMemberLeft(e.memberId,e.memberName);break;case"member_kicked":this.handleMemberKicked(e.memberId,e.memberName);break;case"you_were_kicked":this.handleYouWereKicked();break;case"trace_complete":this.handleTraceComplete(e);break;case"cursor_update":this.handleRemoteCursor(e);break;case"name_update":this.handleNameUpdate(e);break;case"color_update":this.handleColorUpdate(e);break;case"chat_message":this.handleChatMessage(e);break;case"full_state":this.handleFullState(e);break;case"session_ended":this.handleSessionEnded(e.reason);break;case"pong":this.handlePong(e.timestamp)}}handleSessionCreated(e){this.sessionId=e.sessionId,this.sessionName=e.sessionName,this.memberId=e.memberId,this.isHost=!0,this.isConnected=!0,this.clearChatMessages(),this.members.clear(),this.members.set(this.memberId,{id:this.memberId,name:this.memberName,color:this.memberColor,isHost:!0}),this.chatButton.style.display="flex",this.pingIndicator.style.display="flex",this.sendFullState(),this.renderSessionMenu(),this.sessionOverlay.style.display="flex",this.hookEditorMethods(),this.editor.showNotification(__("Sesión creada||Session created"),2e3)}handleSessionJoined(e){this.sessionId=e.sessionId,this.sessionName=e.sessionName,this.memberId=e.memberId,this.isHost=e.isHost,this.isConnected=!0,this.members.clear(),e.members.forEach(e=>{this.members.set(e.id,e)}),this.clearChatMessages(),e.projectData&&this.applyFullState(e.projectData),this.chatButton.style.display="flex",this.pingIndicator.style.display="flex",this.renderSessionMenu(),this.sessionOverlay.style.display="flex",this.hookEditorMethods(),this.editor.showNotification(__("Conectado a la sesión||Connected to the session"),2e3)}handleMemberJoined(e){e.id!==this.memberId&&(this.members.set(e.id,e),this.editor.showNotification(`${this.wrapMemberName(e)} ${__("se unió||joined")}`,2e3),this.isHost&&this.sendFullState(e.id),this.renderSessionMenu())}handleMemberLeft(e,t){const i=this.members.get(e);i&&(this.members.delete(e),this.removeUserCursor(e),this.editor.showNotification(`${this.wrapMemberName(i,i.name||t)} ${__("salió||left")}`,2e3),this.renderSessionMenu())}handleMemberKicked(e,t){const i=this.members.get(e);i&&(this.members.delete(e),this.removeUserCursor(e),this.editor.showNotification(`${i.name||t} ${__("fue expulsado")}`,3e3),this.renderSessionMenu())}handleYouWereKicked(){this.manualDisconnect=!1,this.disconnect(),this.editor.showNotification(__("Has sido expulsado de la sesión"),4e3)}handleTraceComplete(e){const{memberId:t,data:i}=e,s=this.members.get(t);if(!s||t===this.memberId)return;const a=i.points[i.points.length-1];this.showCursor(t,s.name,s.color,a.x,a.y),this.applyTrace(i)}applyTrace(e){const{tool:t,brushSize:i,color:s,points:a,frame:o,layer:n}=e,r=this.editor.project?.frames[o];if(!r)return;const l=r.layers[n];if(!l)return;l.ctx;const c=this.editor.brushSize,h=this.editor.selectedColor,d=this.editor.primaryColor;this.editor.brushSize=i,this.editor.selectedColor="primary",this.editor.primaryColor=s;const p=this.editor.tools[t];if(p){if(1===a.length)p.originalOnDown&&p.originalOnDown.call(this.editor,a[0].x,a[0].y),p.originalOnUp&&p.originalOnUp.call(this.editor,a[0].x,a[0].y);else{p.originalOnDown&&p.originalOnDown.call(this.editor,a[0].x,a[0].y);for(let e=1;e<a.length;e++)p.originalOnMove&&p.originalOnMove.call(this.editor,a[e].x,a[e].y);p.originalOnUp&&p.originalOnUp.call(this.editor,a[a.length-1].x,a[a.length-1].y)}this.editor.brushSize=c,this.editor.selectedColor=h,this.editor.primaryColor=d,this.editor.render()}}handleRemoteCursor(e){const{memberId:t,x:i,y:s,active:a}=e,o=this.members.get(t);o&&t!==this.memberId&&(a?this.showCursor(t,o.name,o.color,i,s):this.hideCursor(t))}handleNameUpdate(e){const{memberId:t,oldName:i,newName:s}=e,a=this.members.get(t);a&&t!==this.memberId&&(a.name=s,this.editor.showNotification(`${this.wrapMemberName(a,i)}</span> ${__("(ha cambiado su nombre a|has changed name to)")} ${this.wrapMemberName(a,s)}`))}handleColorUpdate(e){const{memberId:t,oldColor:i,newColor:s}=e,a=this.members.get(t);a&&t!==this.memberId&&(a.color=s,this.editor.showNotification(`${this.wrapMemberName(a)}</span> ${__("(ha cambiado su color|has changed color)")}`))}handleChatMessage(e){this.chatMessages.push(e),this.addMessageHtml(e),this.chatVisible||this.chatButton.classList.add("new-message"),this.scrollMessagesToBottom()}handleFullState(e){e.memberId!==this.memberId&&(this.applyFullState(e.state),this.editor.showNotification(__("Proyecto sincronizado||Project synchronized"),1e3))}handleSessionEnded(e){this.disconnect(!1),this.editor.showNotification(e||__("La sesión ha terminado"),3e3)}handlePong(e){const t=Date.now()-e;this.updatePingIndicator(t)}handleDisconnect(){this.isConnected=!1,this.stopPingInterval(),this.cleanupDisconnect()}cleanupDisconnect(){this.isConnected=!1,this.sessionId=null,this.sessionName="",this.isHost=!1,this.members.clear(),this.removeAllCursors(),this.currentTrace=null,this.chatButton.style.display="none",this.chatContainer.style.display="none",this.pingIndicator.style.display="none",this.sessionOverlay.style.display="none",this.restoreEditorMethods(),this.manualDisconnect||this.editor.showNotification(__("Desconectado"),2e3)}sendTraceComplete(e){this.sendMessage({type:"trace_complete",data:e})}sendCursorUpdate(e,t,i){const s=Date.now();s-this.lastCursorSend<this.CURSOR_THROTTLE||(this.lastCursorSend=s,this.sendMessage({type:"cursor_update",x:Math.round(e),y:Math.round(t),active:i}))}sendChatMessage(e){this.sendMessage({type:"chat_message",message:e})}sendFullState(e){if(!this.isHost||!this.isConnected)return;const t=this.getFullState();this.sendMessage({type:"full_state",state:t,toMemberId:e||null})}getFullState(){const e={width:this.editor.project.width,height:this.editor.project.height,frames:[],currentFrame:this.editor.project.currentFrame,currentLayer:this.editor.project.currentLayer};for(let t=0;t<this.editor.project.frames.length;t++){const i=this.editor.project.frames[t],s={layers:[]};for(let t=0;t<i.layers.length;t++){const a=i.layers[t],o=a.ctx.getImageData(0,0,e.width,e.height);s.layers.push({name:a.name,visible:a.visible,imageData:Array.from(o.data)})}e.frames.push(s)}return e}applyFullState(e){const t={width:e.width,height:e.height,frames:[],currentFrame:e.currentFrame,currentLayer:e.currentLayer};for(let i=0;i<e.frames.length;i++){const s=e.frames[i],a={layers:[]};for(let t=0;t<s.layers.length;t++){const i=s.layers[t],o=document.createElement("canvas");o.width=e.width,o.height=e.height;const n=o.getContext("2d");if(i.imageData){const t=new ImageData(new Uint8ClampedArray(i.imageData),e.width,e.height);n.putImageData(t,0,0)}a.layers.push({canvas:o,ctx:n,name:i.name,visible:i.visible})}t.frames.push(a)}this.editor.project=t,this.editor.resizeCanvas(),this.editor.render()}createSession(e,t){this.memberName=this.editor.collabMemberName,this.memberColor=this.editor.collabMemberColor,this.connectWebSocket();const i=setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&(clearInterval(i),this.sendMessage({type:"create_session",sessionName:e,password:t||void 0,userName:this.memberName,userColor:this.memberColor}))},100)}joinSession(e,t){this.memberName=this.editor.collabMemberName,this.memberColor=this.editor.collabMemberColor,this.connectWebSocket();const i=setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&(clearInterval(i),this.sendMessage({type:"join_session",sessionId:e,password:t||void 0,userName:this.memberName,userColor:this.memberColor}))},100)}disconnect(e=!0){this.manualDisconnect=e,this.ws&&(this.sendMessage({type:"leave_session"}),this.ws.close()),this.cleanupDisconnect()}kickMember(e){this.isHost&&this.sendMessage({type:"kick_member",memberId:e})}showCursor(e,t,i,s,a){const o=this.canvasToScreen(s,a);if(!o)return;let n=this.cursors.get(e);n||(n=document.createElement("div"),n.className="collab-cursor-item",n.innerHTML='\n        <div class="collab-cursor-ping"></div>\n        <div class="collab-cursor-name"></div>\n      ',this.cursorContainer.appendChild(n),this.cursors.set(e,n)),n.style.left=`${o.x}px`,n.style.top=`${o.y}px`,n.querySelector("div:first-child").style.borderColor=this.getColorHex(i),n.querySelector("div:last-child").textContent=t,n.querySelector("div:last-child").style.backgroundColor=this.getColorHex(i),n.style.opacity="1",n.isVisible=!0,n.lastUpdate=Date.now(),n._interval||(n._interval=setInterval(()=>{n.isVisible&&Date.now()-n.lastUpdate>=2e3&&this.hideCursor(e)},200))}hideCursor(e){const t=this.cursors.get(e);t&&(t.style.opacity="0",t.lastUpdate=Date.now(),t.isVisible=!1)}removeUserCursor(e){const t=this.cursors.get(e);t&&(t.remove(),clearInterval(t._interval),this.cursors.delete(e))}removeAllCursors(){this.cursors.forEach(e=>e.remove()),this.cursors.clear()}openChat(){this.chatButton.style.display="none",this.chatButton.classList.remove("new-message"),this.chatContainer.style.display="flex",this.chatVisible=!0}closeChat(){this.chatButton.style.display="block",this.chatContainer.style.display="none",this.chatVisible=!1}canvasToScreen(e,t){if(!this.editor.project)return null;const i=this.editor.canvasContainer.getBoundingClientRect();return{x:i.left+i.width/2+(e-this.editor.project.width/2)*this.editor.scale+this.editor.posX,y:i.top+i.height/2+(t-this.editor.project.height/2)*this.editor.scale+this.editor.posY}}renderSessionMenu(){this.sessionContent.innerHTML="";const e=document.createElement("div");e.style.cssText="\n      background-color: var(--ui-color);\n      border-radius: 8px;\n      padding: 16px;\n      margin-bottom: 20px;\n    ",e.innerHTML=`\n      <div style="margin-bottom: 12px;">\n        <span style="color: var(--text-dim);">${__("Sala||Room")}:</span>\n        <span style="color: var(--text-color); font-weight: bold; margin-left: 8px;">${this.sessionName||__("Sala sin nombre||Unnamed room")}</span>\n      </div>\n      <div style="margin-bottom: 12px;">\n        <span style="color: var(--text-dim);">${__("Miembros||Members")}:</span>\n        <span style="color: var(--text-color); font-weight: bold; margin-left: 8px;">${this.members.size}</span>\n      </div>\n      <div style="display: flex; align-items: center; gap: 8px;">\n        <span style="color: var(--text-dim);">${__("ID||ID")}:</span>\n        <span style="color: var(--text-color); font-family: monospace; background: var(--bg-color); padding: 4px 8px; border-radius: 4px; flex: 1; font-size: 12px;">${this.sessionId||"Unknown"}</span>\n        <button id="copyIdBtn" style="background: var(--ui-highlight); border: none; border-radius: 4px; color: var(--text-color); padding: 4px 8px; cursor: pointer;">\n          ${__("Copiar||Copy")}\n        </button>\n      </div>\n    `;e.querySelector("#copyIdBtn").addEventListener("click",()=>{navigator.clipboard.writeText(this.sessionId),this.editor.showNotification(__("ID copiado||ID copied"),1e3)}),this.sessionContent.appendChild(e);const t=document.createElement("div");t.style.cssText="\n      background-color: var(--ui-color);\n      border-radius: 8px;\n      padding: 16px;\n      margin-bottom: 20px;\n    ",t.innerHTML=`<h3 style="margin: 0 0 12px 0;">${__("Miembros||Members")}</h3>`;const i=document.createElement("div");i.style.cssText="display: flex; flex-direction: column; gap: 8px;",this.members.forEach(e=>{const t=document.createElement("div");t.style.cssText=`\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 10px;\n        background-color: ${e.id===this.memberId?"var(--primary-color)":"var(--bg-color)"};\n        border-radius: 6px;\n        color: ${e.id===this.memberId?"white":"var(--text-color)"};\n      `;const s=document.createElement("span");s.style.cssText="font-weight: bold; display: flex; align-items: center; gap: 8px;",s.style.color=e.id===this.memberId?"white":this.getColorHex(e.color);const a=document.createElement("span");if(a.textContent=e.name,s.appendChild(a),e.isHost){const e=document.createElement("span");e.style.cssText="\n          background-color: gold;\n          color: black;\n          font-size: 10px;\n          font-weight: bold;\n          padding: 2px 6px;\n          border-radius: 3px;\n        ",e.textContent="HOST",s.appendChild(e)}if(e.id===this.memberId){const e=document.createElement("span");e.style.cssText="\n          background-color: rgba(255,255,255,0.3);\n          color: white;\n          font-size: 10px;\n          font-weight: bold;\n          padding: 2px 6px;\n          border-radius: 3px;\n        ",e.textContent=__("TÚ||YOU"),s.appendChild(e)}if(t.appendChild(s),this.isHost&&e.id!==this.memberId){const i=document.createElement("button");i.textContent=__("Expulsar||Kick"),i.style.cssText="\n          background-color: #ff4444;\n          border: none;\n          border-radius: 4px;\n          color: white;\n          padding: 6px 12px;\n          font-size: 12px;\n          font-weight: bold;\n          cursor: pointer;\n          transition: filter 0.2s;\n        ",i.addEventListener("mouseenter",()=>{i.style.filter="brightness(1.2)"}),i.addEventListener("mouseleave",()=>{i.style.filter="none"}),i.addEventListener("click",t=>{t.stopPropagation(),this.confirmKickMember(e)}),t.appendChild(i)}i.appendChild(t)}),t.appendChild(i),this.sessionContent.appendChild(t);const s=document.createElement("button");s.style.cssText=`\n      width: 100%;\n      padding: 12px;\n      background-color: ${this.isHost?"#ff4444":"var(--ui-highlight)"};\n      border: none;\n      border-radius: 6px;\n      color: white;\n      font-size: 14px;\n      font-weight: bold;\n      cursor: pointer;\n      transition: filter 0.2s;\n    `,s.textContent=this.isHost?__("Terminar sesión||End Session"):__("Desconectar||Disconnect"),s.addEventListener("mouseenter",()=>{s.style.filter="brightness(1.2)"}),s.addEventListener("mouseleave",()=>{s.style.filter="none"}),s.addEventListener("click",()=>{this.editor.showPopup(this.isHost?__("Terminar sesión||End Session"):__("Desconectar||Disconnect"),this.isHost?__("¿Terminar la sesión para todos?||End session for everyone?"):__("¿Desconectarse de la sesión?||Disconnect from session?"),[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.editor.hidePopup()},{text:__("Sí||Yes"),action:()=>{this.disconnect(),this.sessionOverlay.style.display="none",this.editor.hidePopup()}}])}),this.sessionContent.appendChild(s)}renderSessionMenu(){this.sessionContent.innerHTML="";const e=document.createElement("div");e.className="collab-info-card",e.innerHTML=`\n      <div class="collab-info-item">\n        <span class="collab-info-label">${__("Sala||Room")}:</span>\n        <span class="collab-info-value">${this.sessionName||__("Sala sin nombre||Unnamed room")}</span>\n      </div>\n      <div class="collab-info-item">\n        <span class="collab-info-label">${__("Miembros||Members")}:</span>\n        <span class="collab-info-value">${this.members.size}</span>\n      </div>\n      <div class="collab-info-item">\n        <span style="collab-info-label">${__("ID||ID")}:</span>\n        <span class="collab-info-value token">${this.sessionId||"Unknown"}</span>\n        <button id="copyIdBtn" class="collab-copy-btn">\n          ${__("Copiar||Copy")}\n        </button>\n      </div>\n    `;e.querySelector("#copyIdBtn").addEventListener("click",()=>{navigator.clipboard.writeText(this.sessionId),this.editor.showNotification(__("ID copiado||ID copied"),1e3)}),this.sessionContent.appendChild(e);const t=document.createElement("div");t.className="collab-members-section",t.innerHTML=`<h3>${__("Miembros||Members")}</h3>`;const i=document.createElement("div");i.className="collab-members-list",this.members.forEach(e=>{const t=document.createElement("div");t.className=e.id===this.memberId?"collab-member-item current-user":"collab-member-item";const s=document.createElement("span");s.className="collab-member-name",s.style.color=e.id===this.memberId?"white":this.getColorHex(e.color);const a=document.createElement("span");if(a.textContent=e.name,s.appendChild(a),e.isHost){const e=document.createElement("span");e.className="collab-host-badge",e.textContent="HOST",s.appendChild(e)}if(e.id===this.memberId){const e=document.createElement("span");e.className="collab-you-badge",e.textContent=__("TÚ||YOU"),s.appendChild(e)}if(t.appendChild(s),this.isHost&&e.id!==this.memberId){const i=document.createElement("button");i.textContent=__("Expulsar||Kick"),i.className="collab-kick-button",i.addEventListener("click",t=>{t.stopPropagation(),this.confirmKickMember(e)}),t.appendChild(i)}i.appendChild(t)}),t.appendChild(i),this.sessionContent.appendChild(t);const s=document.createElement("button");s.className=this.isHost?"collab-disconnect-btn danger":"collab-disconnect-btn",s.textContent=this.isHost?__("Terminar sesión||End Session"):__("Desconectar||Disconnect"),s.addEventListener("click",()=>{this.editor.showPopup(this.isHost?__("Terminar sesión||End Session"):__("Desconectar||Disconnect"),this.isHost?__("¿Terminar la sesión para todos?||End session for everyone?"):__("¿Desconectarse de la sesión?||Disconnect from session?"),[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.editor.hidePopup()},{text:__("Sí||Yes"),action:()=>{this.disconnect(),this.sessionOverlay.style.display="none",this.editor.hidePopup()}}])}),this.sessionContent.appendChild(s)}confirmKickMember(e){this.editor.showPopup(__("Expulsar miembro||Kick member"),`${__("¿Expulsar a||Kick")} ${this.wrapMemberName(e)}?`,[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.editor.hidePopup()},{text:__("Expulsar||Kick"),action:()=>{this.kickMember(e.id),this.editor.hidePopup()}}])}clearChatMessages(){this.chatMessages=[],this.renderChatMessages()}renderChatMessages(){this.chatMessagesDiv.innerHTML="",this.chatMessages.forEach(e=>this.addMessageHtml(e)),this.scrollMessagesToBottom()}addMessageHtml(e){const t=document.createElement("div");t.className="collab-chat-message",t.innerHTML=`\n      <span class="collab-chat-name" style="color: ${this.getColorHex(e.memberColor)};">${this.escapeHtml(e.memberName||"Unknown")}:</span>\n      <span class="collab-chat-text"> ${this.escapeHtml(e.message)}</span>\n    `,this.chatMessagesDiv.appendChild(t)}scrollMessagesToBottom(){this.chatMessagesDiv.scrollTop=this.chatMessagesDiv.scrollHeight}updatePingIndicator(e){const t=this.pingIndicator.querySelector(".ping-dot"),i=this.pingIndicator.querySelector(".ping-value");let s="#44ff44";e>100&&(s="#ffff44"),e>200&&(s="#ff8844"),e>300&&(s="#ff4444"),t&&(t.style.backgroundColor=s),i&&(i.textContent=`${e}ms`)}startPingInterval(){this.pingInterval=setInterval(()=>{this.sendMessage({type:"ping",timestamp:Date.now()})},5e3)}stopPingInterval(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null)}canPerformAction(e){return!this.isConnected||(!!this.isHost||this.permissions&&"everyone"===this.permissions[e])}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class FileBrowser{constructor(e={}){this.options={container:document.body,onConfirm:null,onCancel:null,onError:null,fileTypes:["pxl","png","jpg","jpeg"],defaultType:"pxl",allowMultiple:!1,mode:"open",defaultName:"untitled"},this.mimeMap={pxl:"text/*",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",txt:"text/plain",default:"*"},Object.assign(this.options,e),this.selectedFile=null,this.selectedType=this.options.defaultType,this.isCordova=void 0!==window.cordova,this.isFilePluginAvailable=this.isCordova&&void 0!==window.File,this.currentDirectory=null,this.currentPath=null,this.workingDirectory="",this.lastMode=null,this.visible=!1,this.initUI()}initUI(){this.overlay=document.createElement("div"),this.overlay.className="file-browser-overlay",this.overlay.style.display="none",this.dialog=document.createElement("div"),this.dialog.className="file-browser-dialog",this.overlay.appendChild(this.dialog),this.title=document.createElement("div"),this.title.className="file-browser-title",this.title.textContent=this.options.title?this.options.title:"save"===this.options.mode||"saveAs"===this.options.mode?__("Guardar Archivo||Save File"):__("Abrir Archivo||Open File"),this.dialog.appendChild(this.title),this.contentArea=document.createElement("div"),this.contentArea.className="file-browser-content",this.dialog.appendChild(this.contentArea),this.buttonContainer=document.createElement("div"),this.buttonContainer.className="file-browser-buttons",this.dialog.appendChild(this.buttonContainer),this.initContentArea(),this.initButtons(),this.options.container.appendChild(this.overlay)}initContentArea(){this.contentArea.innerHTML="";const e=this.filenameInput,t=this.typeSelect;this.fileList;this.isCordova&&this.isFilePluginAvailable?this.initCordovaUI():this.initBrowserUI(),e&&this.filenameInput&&e.value&&(this.filenameInput.value=e.value),t&&this.typeSelect&&t.value&&(this.typeSelect.value=t.value,this.selectedType=t.value)}initCordovaUI(){this.pathDisplay=this.pathDisplay||document.createElement("div"),this.fileList=this.fileList||document.createElement("div"),this.pathDisplay.className="cordova-path",this.fileList.className="file-browser-list cordova-file-list",this.contentArea.innerHTML="",this.contentArea.appendChild(this.pathDisplay),this.contentArea.appendChild(this.fileList),"save"!==this.options.mode&&"saveAs"!==this.options.mode||(this.filenameInput=this.filenameInput||document.createElement("input"),this.filenameInput.type="text",this.filenameInput.className="file-browser-filename",this.filenameInput.value=this.options.defaultName||"untitled",this.contentArea.appendChild(this.filenameInput),this.typeSelect=this.typeSelect||document.createElement("select"),this.typeSelect.className="file-browser-type",this.typeSelect.innerHTML="",this.options.fileTypes.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e.toUpperCase(),e===this.options.defaultType&&(t.selected=!0),this.typeSelect.appendChild(t)}),this.contentArea.appendChild(this.typeSelect))}initBrowserUI(){if(this.contentArea.innerHTML="","open"===this.options.mode){this.fileInput=this.fileInput||document.createElement("input"),this.fileInput.type="file",this.fileInput.style.display="none",this.fileInput.accept=this.getAccept(),this.fileInput.multiple=this.options.allowMultiple;const e=this.fileInput.cloneNode();this.fileInput=e,this.fileInput.addEventListener("change",e=>this.handleFileSelect(e)),this.contentArea.appendChild(this.fileInput);const t=document.createElement("button");t.className="file-browser-browse",t.textContent=__("Escoger Archivos||Browse Files"),t.addEventListener("click",()=>this.fileInput.click()),this.contentArea.appendChild(t)}else this.filenameInput=this.filenameInput||document.createElement("input"),this.filenameInput.type="text",this.filenameInput.className="file-browser-filename",this.filenameInput.value=this.options.defaultName||"untitled",this.contentArea.appendChild(this.filenameInput),this.typeSelect=this.typeSelect||document.createElement("select"),this.typeSelect.className="file-browser-type",this.typeSelect.innerHTML="",this.options.fileTypes.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e.toUpperCase(),e===this.options.defaultType&&(t.selected=!0),this.typeSelect.appendChild(t)}),this.contentArea.appendChild(this.typeSelect)}initButtons(){this.buttonContainer.innerHTML="",this.cancelButton=document.createElement("button"),this.cancelButton.className="file-browser-cancel",this.cancelButton.textContent=__("Cancelar||Cancel"),this.cancelButton.addEventListener("click",()=>this.handleCancel()),this.buttonContainer.appendChild(this.cancelButton),"save"!==this.options.mode&&"saveAs"!==this.options.mode||(this.confirmButton=document.createElement("button"),this.confirmButton.className="file-browser-confirm",this.confirmButton.textContent=__("Guardar||Save"),this.confirmButton.addEventListener("click",()=>this.handleConfirm()),this.buttonContainer.appendChild(this.confirmButton))}updateExistingUI(){this.filenameInput&&this.options.defaultName&&(this.filenameInput.value=this.options.defaultName),this.title&&(this.title.textContent=this.options.title?this.options.title:"save"===this.options.mode||"saveAs"===this.options.mode?"Save File":"Open File"),this.initContentArea(),this.initButtons()}async loadCordovaFiles(e=this.currentPath){try{let t;if(this.fileList.innerHTML='<div class="loading">Loading files...</div>',e)t=await new Promise((t,i)=>{window.resolveLocalFileSystemURL(e.endsWith("/")?e:e+"/",t,i)});else try{t=await new Promise((e,t)=>{window.resolveLocalFileSystemURL(cordova.file.externalDataDirectory||cordova.file.dataDirectory,e,t)})}catch(e){t=await new Promise((e,t)=>{window.requestFileSystem(window.PERSISTENT||1,0,t=>e(t.root),t)})}const i=t.createReader(),s=await new Promise((e,t)=>{i.readEntries(e,t)});this.currentDirectory=t,this.currentPath=t.toURL(),this.workingDirectory=t.fullPath,this.updatePathDisplay(t),this.renderFileList(s,t)}catch(e){throw this.showError(`Error loading files: ${e.message}`),this.options.onError&&this.options.onError(e),e}}async getDirectoryEntry(e){return new Promise((t,i)=>{window.resolveLocalFileSystemURL(e,t,i)})}async getRootDirectory(){return window.PERSISTENT?new Promise((e,t)=>{window.requestFileSystem(window.PERSISTENT,0,t=>e(t.root),t)}):window.cordova.file.dataDirectory}updatePathDisplay(e){const t=e.fullPath||e.nativeURL;this.pathDisplay.textContent=t}renderFileList(e,t){this.fileList.innerHTML="",e.sort((e,t)=>e.isDirectory&&!t.isDirectory?-1:!e.isDirectory&&t.isDirectory?1:e.name.toLowerCase().localeCompare(t.name.toLowerCase())),this.isRootPath(t)?"open"===this.options.mode&&this.addListItem({text:"[File Selector]",icon:"folder",onClick:()=>{const i=document.createElement("input");i.type="file",i.style.display="none",i.accept=this.getAccept(),i.multiple=this.options.allowMultiple,i.addEventListener("change",e=>this.handleFileSelect(e)),i.addEventListener("cancel",i=>this.renderFileList(e,t)),i.click(),this.fileList.innerHTML=""}}):this.addParentDirectoryItem(t),e.forEach(e=>{e.isDirectory?this.addDirectoryItem(e):this.addFileItem(e)}),0===this.fileList.children.length&&(this.fileList.innerHTML='<div class="empty">No files found</div>')}addListItem({text:e="",type:t="directory",icon:i="folder",onClick:s=null}){const a=document.createElement("div");a.className=`file-item ${t}`;const o=document.createElement("span");o.className=`icon ${i}`;const n=document.createElement("span");n.textContent=e,a.appendChild(o),a.appendChild(n),a.addEventListener("click",()=>s?.(a)),a.addEventListener("touchend",()=>a.scrollTo({left:0,behavior:"smooth"})),this.fileList.appendChild(a)}addParentDirectoryItem(e){const t=document.createElement("div");t.className="file-item directory";const i=document.createElement("span");i.className="icon folder";const s=document.createElement("span");s.textContent=".. (Parent Directory)",t.appendChild(i),t.appendChild(s),t.addEventListener("click",()=>this.goUp()),this.fileList.appendChild(t)}addDirectoryItem(e){const t=document.createElement("div");t.className="file-item directory";const i=document.createElement("span");i.className="icon folder";const s=document.createElement("span");s.textContent=e.name,t.appendChild(i),t.appendChild(s),t.addEventListener("click",()=>{this.loadCordovaFiles(e.toURL())}),t.addEventListener("touchend",()=>t.scrollTo({left:0,behavior:"smooth"})),this.fileList.appendChild(t)}addFileItem(e){const t=e.name.split(".").pop().toLowerCase();if(!this.options.fileTypes.includes(t))return;const i=document.createElement("div");i.className="file-item file";const s=document.createElement("span");["png","gif","jpg","jpeg"].includes(t)?s.className="icon image-file":s.className="pxl"===t?"icon project-file":"icon text-file";const a=document.createElement("span");a.textContent=e.name,i.appendChild(s),i.appendChild(a),i.addEventListener("click",()=>{this.selectedFile=e,this.selectedType=t,"open"===this.options.mode&&this.options.onConfirm?(this.options.onConfirm({name:e.name,type:t,entry:e,fullPath:e.toURL()}),this.hide()):this.filenameInput.value=e.name}),this.fileList.appendChild(i)}handleFileSelect(e){const t=e.target.files;if(!t||0===t.length)return;const i=t[0],s=i.name.split(".").pop().toLowerCase();this.options.onConfirm&&this.options.onConfirm({name:i.name,type:s,file:i}),this.hide()}show(){this.lastMode!==this.options.mode&&(this.contentArea.innerHTML="",this.initContentArea()),this.overlay.style.display="flex",this.selectedFile=null,this.visible=!0,this.filenameInput&&(this.filenameInput.value=this.options.defaultName||"untitled"),this.typeSelect&&this.options.defaultType&&(this.typeSelect.value=this.options.defaultType,this.selectedType=this.options.defaultType),this.isCordova&&this.isFilePluginAvailable&&this.loadCordovaFiles()}hide(){this.overlay.style.display="none",this.visible=!1}refresh(){this.contentArea.innerHTML="",this.initContentArea(),this.isCordova&&this.isFilePluginAvailable&&this.loadCordovaFiles()}goUp(){this.isRootPath(this.currentDirectory)?this.hide():this.loadCordovaFiles(this.currentDirectory.toURL().split("/").slice(0,-2).join("/")||"/")}isRootPath(e){return"/"==e.fullPath||e.fullPath==cordova.file.dataDirectory}getAccept(){const e=[];return this.options.fileTypes.forEach(t=>{(this.mimeMap[t]||this.mimeMap.default).split(",").map(e=>e.trim()).forEach(t=>{e.includes(t)||e.push(t)})}),e.join(", ")}updateOptions(e){const t=this.options.mode;Object.assign(this.options,e),this.selectedFile=null,this.selectedType=this.options.defaultType||"pxl",t!==this.options.mode||"saveAs"===this.options.mode&&!this.filenameInput||"open"===this.options.mode&&this.isCordova&&!this.fileList?(this.contentArea.innerHTML="",this.initContentArea(),this.updateExistingUI()):this.updateExistingUI(),this.lastMode=this.options.mode}handleConfirm(){if("save"!==this.options.mode&&"saveAs"!==this.options.mode)return;let e=this.filenameInput?this.filenameInput.value.trim():this.options.defaultName;e||(e=this.options.defaultName);const t=this.typeSelect?this.typeSelect.value:this.options.defaultType,i=e.endsWith(`.${t}`)?e:`${e}.${t}`;if(this.options.onConfirm){const e={name:i,type:t};this.isCordova&&this.isFilePluginAvailable&&this.currentDirectory&&(e.directory=this.currentDirectory),this.options.onConfirm(e)}this.hide()}handleCancel(){this.options.onCancel&&this.options.onCancel(),this.hide()}showError(e){this.fileList.innerHTML=`<div class="error">${e}</div>`}destroy(){if(this.fileInput){const e=this.fileInput.cloneNode(!1);this.fileInput.parentNode?.replaceChild(e,this.fileInput),this.fileInput=e}this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.fileBrowser=null}}class PixelArtEditor{constructor(e){this.container=e||document.createElement("div"),this.container.classList.add("app-container"),document.body.appendChild(this.container),this.version=VERSION,this.tools={},this.currentTool=null,this.lastTool=null,this.isDrawing=!1,this.isPanning=!1,this.brushSize=localStorage.getItem("brushSize")?parseInt(localStorage.getItem("brushSize")):1,this.maxBrushSize=8,this.minBrushSize=1,this.lastBrushDistance=this.brushSize,this.defaultWidth=32,this.defaultHeight=32,this.startX=0,this.startY=0,this.scale=1,this.offsetX=0,this.offsetY=0,this.primaryColor=localStorage.getItem("primaryColor")||"#000000",this.secondaryColor=localStorage.getItem("secondaryColor")||"#ff00ff",this.selectedColor="primary",this.transparentBackground=!0,this.project=null,this.historyManager=new HistoryManager(this),this.touchDistance=0,this.touchCenterX=0,this.touchCenterY=0,this.minScale=1,this.maxScale=35,this.menuPanelOpen=!1,this.layersPanelOpen=!1,this.animationPanelOpen=!1,this.popupOpen=!1,this.colorPickerOpen=!1,this.toolDropdownOpen=!1,this.toolSettingsOpen=!1,this.recentColors=JSON.parse(localStorage.getItem("recentColors"))||[],this.lastPalette=JSON.parse(localStorage.getItem("lastPalette"))||null,this.colorPickerPreviewColor=null,this.isColorPicking=!1,this.colorPickStartX=0,this.colorPickStartY=0,this.colorPickLine=null,this.animationFPS=12,this.isPlaying=!1,this.animationInterval=null,this.frameTimes=[],this.currentFrameTime=1e3/this.animationFPS,this.showMiniView=!1,this.useCordova=window.location.href.startsWith("file"),this.deviceReady=!1,this.isFilePluginAvailable=!1,this.fileBrowser=null,this.defaultFileBrowserPathUrl=null,this.referenceImage=null,this.referenceOpacity=.5,this.renderReferenceImageOnTop=!1,this.timelapseFPS=30,this.referenceGrids=[],this.floatingColors=new Map,this.collabMemberName=localStorage.getItem("collab_username")||"user_"+Math.floor(1e4*Math.random()),this.collabMemberColor=localStorage.getItem("collab_user_color")||["red","blue","green","yellow","orange","purple"][Math.floor(6*Math.random())],this.tempLine=null,this.tempRect=null,this.tempEllipse=null,this.tempCanvas=null,this.tempCtx=null,this.tempColor=null;try{this.initSettings(),this.initUI(),this.initCollab(),this.initReferenceImageUI(),this.initBrushUI(),this.initCanvas(),this.initTools(),this.initColorPicker(),this.initEventListeners(),this.updateColorSlidersFromHex(this.primaryColor),this.initColorPickerDrag(),this.loadFloatingColors(JSON.parse(localStorage.getItem("floatingColors"))||[]),this.gridManager=new GridManager(this),this.useCordova&&this.initCordova(),this.newProject(),this.showMiniView&&this.animationPreview.classList.add("visible")}catch(e){throw console.error("Editor initialization error:",e),this.showError(e),e}}initSettings(){this.settings=new SettingsManager(this),window.settings=this.settings;const e=this.settings.addCategory({id:"general",title:"General||General",icon:"icon-general"});e.addSetting({id:"language",label:"Idioma||Language",description:"Selecciona el idioma de la interfaz||Select interface language",type:"select",defaultValue:"0",options:[{value:"0",label:"Español"},{value:"1",label:"English"}],needsReload:!0,onInit:(e,t)=>{t.settings.language=e},onUpdate:(e,t,i)=>{i.settings.language=e,i.settings.save()}}),e.addSetting({id:"theme",label:"Tema||Theme",description:"Oscuro / Claro||Dark / Light",type:"select",defaultValue:"dark",options:[{value:"dark",label:"Oscuro||Dark"},{value:"light",label:"Claro||Light"}],needsReload:!1,onInit:(e,t)=>{document.body.classList.add(`theme-${e}`)},onUpdate:(e,t,i)=>{document.body.classList.remove(`theme-${t}`),document.body.classList.add(`theme-${e}`)}});const t=this.settings.addCategory({id:"editor",title:"Editor||Editor",icon:"icon-editor"});t.addSetting({id:"autoSave",label:"Auto-guardado||Auto-save",description:"Guardar automáticamente cada 5 minutos||Auto-save every 5 minutes",type:"boolean",defaultValue:!1,onInit:(e,t)=>{e?t.startAutoSave():t.stopAutoSave()},onUpdate:(e,t,i)=>{e?i.startAutoSave():i.stopAutoSave()}}),t.addSetting({id:"showPreview",label:"Mostrar Vista Previa por defecto||Show Preview by default",description:"Mostrar recuadro de vista previa al iniciar la app||Show preview window at startup",type:"boolean",defaultValue:!1,onInit:(e,t)=>{t.showMiniView=e}});const i=this.settings.addCategory({id:"canvas",title:"Lienzo||Canvas",icon:"icon-canvas"});i.addSetting({id:"defaultWidth",label:"Ancho predeterminado||Default width",description:"Ancho por defecto para nuevos proyectos||Default width for new projects",type:"number",defaultValue:32,min:8,max:512,step:8,onInit:(e,t)=>{t.defaultWidth=e},onUpdate:(e,t,i)=>{i.defaultWidth=e}}),i.addSetting({id:"defaultHeight",label:"Alto predeterminado||Default height",description:"Alto por defecto para nuevos proyectos||Default height for new projects",type:"number",defaultValue:32,min:8,max:512,step:8,onInit:(e,t)=>{t.defaultHeight=e},onUpdate:(e,t,i)=>{i.defaultHeight=e}}),i.addSetting({id:"smooth-panning",label:"Paneo Suave||Smooth Panning",description:"Movimiento suave del lienzo||Smooth movement of the canvas",type:"boolean",defaultValue:!1,onInit:(e,t)=>{e?t.setSmoothPanning(!0):t.setSmoothPanning(!1)},onUpdate:(e,t,i)=>{e?i.setSmoothPanning(!0):i.setSmoothPanning(!1)}});this.settings.addCategory({id:"animation",title:"Animación||Animation",icon:"icon-animation"}).addSetting({id:"defaultFPS",label:"FPS predeterminado||Default FPS",description:"Fotogramas por segundo para nuevas animaciones||Frames per second for new animations",type:"number",defaultValue:12,min:1,max:60,step:1,onInit:(e,t)=>{t.animationFPS=e,t.currentFrameTime=1e3/e}});const s=this.settings.addCategory({id:"performance",title:"Rendimiento||Performance",icon:"icon-performance"});s.addSetting({id:"zoomLimit",label:"Limité de Zoom||Zoom Limit",description:"Límitar el zoom hasta cierto punto||Limit zoom to certain point",type:"boolean",defaultValue:!0,step:10,onInit:(e,t)=>{t.minScale=e?1:0},onUpdate:(e,t,i)=>{i.minScale=e?1:0}}),s.addSetting({id:"maxUndoSteps",label:"Pasos de deshacer máximos||Max undo steps",description:"Límite de historial de deshacer||Undo history limit",type:"number",defaultValue:50,min:10,max:200,step:10,onInit:(e,t)=>{t.historyManager.maxHistoryLength=e},onUpdate:(e,t,i)=>{i.historyManager.maxHistoryLength=e}}),s.addSetting({id:"maxBrushSize",label:"Tamaño máximo del pincel||Max brush size",description:"Límite del tamaño del pincel, Pinceles muy anchos pueden ralentizar la app||Brush size limit, wide brushes can slow down the app",type:"number",defaultValue:8,min:3,max:32,step:1,onInit:(e,t)=>{t.maxBrushSize=e},onUpdate:(e,t,i)=>{i.maxBrushSize=e}});const a=this.settings.addCategory({id:"collab",title:"Colaboración||Collaboration",icon:"icon-collab"});a.addSetting({id:"memberName",label:"Nombre en pantalla||Display name",description:"Nombre a mostrar en sesiones colaborativas||Name to show in collaborative sessions",type:"text",defaultValue:this.collabMemberName,needsReload:!1,onInit:(e,t)=>{t.collabMemberName=e.length>3?e:`user_${Math.floor(1e4*Math.random())}`},onUpdate:(e,t,i)=>{i.collabMemberName=e.length>3?e:`user_${Math.floor(1e4*Math.random())}`,this.collabManager.updateMemberName(i.collabMemberName),localStorage.setItem("collab_username",e)}}),a.addSetting({id:"memberColor",label:"Color||Color",description:"Color con el que se muestra tu nombre||Color with which your name is shown",type:"select",defaultValue:this.collabMemberColor,options:[{value:"red",label:"Rojo||Red"},{value:"blue",label:"Azul||Blue"},{value:"green",label:"Verde||Green"},{value:"yellow",label:"Amarillo||Yellow"},{value:"orange",label:"Naranja||Orange"},{value:"purple",label:"Púrpura||Purple"},{value:"pink",label:"Rosa||Pink"},{value:"cyan",label:"Cian||Cyan"},{value:"brown",label:"Marrón||Brown"},{value:"gray",label:"Gris||Gray"},{value:"lime",label:"Lima||Lime"},{value:"indigo",label:"Indigo||Indigo"}],needsReload:!1,onInit:(e,t)=>{this.collabMemberColor=e},onUpdate:(e,t,i)=>{this.collabMemberColor=e,this.collabManager.memberColor=e,this.collabManager.updateMemberColor(e),localStorage.setItem("collab_user_color",e)}}),this.settings.init(),this.settingsUI=new SettingsUI(this.settings,this)}initCollab(){this.collabManager=new CollabManager(this)}startAutoSave(){this.autoSaveInterval||(this.autoSaveInterval=setInterval(()=>{this.project&&(this.saveProject(!0),this.showNotification(__("Proyecto auto-guardado||Project auto-saved")))},3e5))}stopAutoSave(){this.autoSaveInterval&&(clearInterval(this.autoSaveInterval),this.autoSaveInterval=null)}setSmoothPanning(e){document.body.style.setProperty("--transform-transition",e?"0.2s":"none")}initCordova(){const e=document.createElement("script");e.src="cordova/cordova.js",document.head.appendChild(e),document.addEventListener("deviceready",()=>this.onDeviceReady(),!1)}onDeviceReady(){this.deviceReady=!0,window.requestFileSystem&&window.requestFileSystem(window.PERSISTENT||1,0,e=>{this.isCordova=!0,this.isFilePluginAvailable=!0,window.resolveLocalFileSystemURL(cordova.file.externalRootDirectory,e=>{this.defaultFileBrowserPathUrl=e.toURL()},e=>{console.warn("File system access denied:",e.code),this.isFilePluginAvailable=!1})},e=>{console.warn("File system access denied:",e.code),this.isFilePluginAvailable=!1}),document.addEventListener("backbutton",()=>this.onBackButtonDown())}onBackButtonDown(){this.popupOpen?this.hidePopup():this.fileBrowser&&this.fileBrowser.visible?this.isFilePluginAvailable?this.fileBrowser.goUp():this.fileBrowser.hide():this.colorPickerOpen?this.hideColorPicker():this.menuPanel.classList.contains("visible")?this.toggleMenu():this.animationPanel.classList.contains("visible")?this.togglePanel("animation"):this.layersPanel.classList.contains("visible")?this.togglePanel("layers"):this.gridManager.panelVisible?this.gridManager.hide():this.settingsUI.visible?this.settingsUI.hide():this.exitApp()}showError(e){this.errorElement.innerHTML="",this.errorElement.style.display="flex";const t=document.createElement("h2");t.textContent="App crash",this.errorElement.appendChild(t);const i=document.createElement("p");i.className="error-message",this.errorElement.appendChild(i),i.textContent=e.message||"An unknown error occurred",this.loadingElement.style.display="none";const s=document.createElement("button");s.className="error-reload",s.textContent="Reload",this.errorElement.appendChild(s),s.addEventListener("click",()=>{window.location.reload()})}showCollabDialog(){this.collabManager.isConnected?(this.collabManager.sessionOverlay.style.display="flex",this.collabManager.renderSessionMenu()):this.showCollabConnectDialog()}showCollabConnectDialog(){const e=document.createElement("div");e.className="collab-connect-dialog",e.style.cssText="\n      min-width: 300px;\n    ";const t=document.createElement("div");t.style.cssText="\n      display: flex;\n      gap: 8px;\n      margin-bottom: 20px;\n      border-bottom: 1px solid var(--border-color);\n    ";const i=document.createElement("div");i.style.cssText="\n      padding: 8px 16px;\n      cursor: pointer;\n      border-bottom: 2px solid var(--primary-color);\n      color: var(--primary-color);\n    ",i.textContent=__("Crear Sala||Create Room");const s=document.createElement("div");s.style.cssText="\n      padding: 8px 16px;\n      cursor: pointer;\n      border-bottom: 2px solid transparent;\n    ",s.textContent=__("Unirse||Join"),t.appendChild(i),t.appendChild(s),e.appendChild(t);const a=document.createElement("div");a.style.display="block",a.innerHTML=`\n      <div style="margin-bottom: 16px;">\n        <label style="display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 12px;">${__("Nombre de sala||Room name")}</label>\n        <input type="text" id="collab-room-name" value="${localStorage.getItem("collab_default_room")||"Mi Sala"}" \n               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 2px solid var(--border-color); border-radius: 4px; color: var(--text-color);">\n      </div>\n      <div style="margin-bottom: 16px;">\n        <label style="display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 12px;">${__("Contraseña||Password")}</label>\n        <input type="password" id="collab-room-password" value="${localStorage.getItem("collab_default_password")||""}" \n               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 2px solid var(--border-color); border-radius: 4px; color: var(--text-color);">\n      </div>\n      <div style="margin-bottom: 16px;">\n        <label style="display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 12px;">${__("Permisos||Permissions")}</label>\n        <select id="collab-permissions" style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 2px solid var(--border-color); border-radius: 4px; color: var(--text-color);">\n          <option value="strict">${__("Estricto||Strict")}</option>\n          <option value="balanced" selected>${__("Equilibrado||Balanced")}</option>\n          <option value="open">${__("Abierto||Open")}</option>\n        </select>\n      </div>\n    `,e.appendChild(a);const o=document.createElement("div");o.style.display="none",o.innerHTML=`\n      <div style="margin-bottom: 16px;">\n        <label style="display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 12px;">${__("ID de sala||Room ID")}</label>\n        <input type="text" id="collab-join-id" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" \n               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 2px solid var(--border-color); border-radius: 4px; color: var(--text-color);">\n      </div>\n      <div style="margin-bottom: 16px;">\n        <label style="display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 12px;">${__("Contraseña||Password")}</label>\n        <input type="password" id="collab-join-password" \n               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 2px solid var(--border-color); border-radius: 4px; color: var(--text-color);">\n      </div>\n    `,e.appendChild(o),i.addEventListener("click",()=>{i.style.borderBottomColor="var(--primary-color)",i.style.color="var(--primary-color)",s.style.borderBottomColor="transparent",s.style.color="var(--text-color)",a.style.display="block",o.style.display="none"}),s.addEventListener("click",()=>{s.style.borderBottomColor="var(--primary-color)",s.style.color="var(--primary-color)",i.style.borderBottomColor="transparent",i.style.color="var(--text-color)",o.style.display="block",a.style.display="none"}),this.showPopup(__("Colaboración||Collaboration"),e,[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.hidePopup()},{text:__("Conectar||Connect"),action:()=>{if("none"===a.style.display){const e=document.getElementById("collab-join-id").value,t=document.getElementById("collab-join-password").value;return e?void this.showPopup(__("Unirse a sala||Join Room"),__("¿Unirse a la sala? Los cambios no guardados se perderán||Join room? Unsaved changes will be lost"),[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.hidePopup()},{text:__("Unirse||Join"),action:()=>{this.collabManager.joinSession(e,t),this.hidePopup()}}]):void this.showNotification(__("ID de sala requerido||Room ID required"),2e3)}{const e=document.getElementById("collab-room-name").value,t=document.getElementById("collab-room-password").value;let i;switch(document.getElementById("collab-permissions").value){case"strict":i={undoRedo:"host",addRemoveFrames:"host",addRemoveLayers:"host",draw:"host",chat:"everyone"};break;case"open":i={undoRedo:"everyone",addRemoveFrames:"everyone",addRemoveLayers:"everyone",draw:"everyone",chat:"everyone"};break;default:i={undoRedo:"host",addRemoveFrames:"everyone",addRemoveLayers:"everyone",draw:"everyone",chat:"everyone"}}this.collabManager.createSession(e,t,i)}this.hidePopup()}}])}initUI(){this.loadingElement=document.createElement("div"),this.loadingElement.className="loading-overlay",this.container.appendChild(this.loadingElement),this.loadingSpinner=document.createElement("div"),this.loadingSpinner.className="loading-spinner",this.loadingElement.appendChild(this.loadingSpinner),this.loadingText=document.createElement("div"),this.loadingText.className="loading-text",this.loadingText.innerHTML="Loading...",this.loadingElement.appendChild(this.loadingText),this.errorElement=document.createElement("div"),this.errorElement.className="editor-error",this.errorElement.style.display="none",this.container.appendChild(this.errorElement),this.editorElement=document.createElement("div"),this.editorElement.className="pixel-art-editor",this.container.appendChild(this.editorElement),this.canvasContainer=document.createElement("div"),this.canvasContainer.className="editor-canvas-container",this.editorElement.appendChild(this.canvasContainer),this.overlayLayer=document.createElement("div"),this.overlayLayer.className="editor-overlay-layer",this.editorElement.appendChild(this.overlayLayer),this.floatingColorsDeleteZone=document.createElement("div"),this.overlayLayer.appendChild(this.floatingColorsDeleteZone),setTimeout(()=>{this.floatingColorsDeleteZone.className="palette-delete-zone",this.floatingColorsDeleteZone.innerHTML='\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n        </svg>\n      '}),this.floatingColorsDeleteZone.addEventListener("dragover",e=>{e.preventDefault(),this.floatingColorsDeleteZone.classList.add("drag-over")}),this.floatingColorsDeleteZone.addEventListener("dragleave",()=>{this.floatingColorsDeleteZone.classList.remove("drag-over")}),this.floatingColorsDeleteZone.addEventListener("drop",e=>{this.floatingColorsDeleteZone.classList.remove("drag-over");const t=e.dataTransfer.getData("text/plain");this.removeFloatingPaletteColor(t)}),this.uiLayer=document.createElement("div"),this.uiLayer.className="editor-ui",this.editorElement.appendChild(this.uiLayer),this.topBar=document.createElement("div"),this.topBar.className="ui-top-bar",this.uiLayer.appendChild(this.topBar),this.menuButton=this.createButton("menu","icon-menu",()=>this.toggleMenu()),this.topBar.appendChild(this.menuButton),this.colorIndicator=document.createElement("div"),this.colorIndicator.className="color-indicator",this.topBar.appendChild(this.colorIndicator),this.colorPrimary=document.createElement("div"),this.colorPrimary.className="color-primary",this.colorIndicator.appendChild(this.colorPrimary),this.colorSecondary=document.createElement("div"),this.colorSecondary.className="color-secondary",this.colorIndicator.appendChild(this.colorSecondary),this.colorSelector=document.createElement("div"),this.colorSelector.className="color-selector",this.colorIndicator.appendChild(this.colorSelector),this.colorIndicator.addEventListener("click",()=>this.toggleSelectedColor()),this.colorPickerButton=this.createButton("color-picker","icon-palette",()=>this.showColorPicker()),this.topBar.appendChild(this.colorPickerButton),this.bottomBar=document.createElement("div"),this.bottomBar.className="ui-bottom-bar",this.uiLayer.appendChild(this.bottomBar),this.toolSelectionContainer=document.createElement("div"),this.toolSelectionContainer.className="tool-selection-container",this.bottomBar.appendChild(this.toolSelectionContainer),this.toolButtonContainer=document.createElement("div"),this.toolButtonContainer.className="tool-button-container",this.toolSelectionContainer.appendChild(this.toolButtonContainer),this.currentToolButton=this.createButton("current-tool","tool-pencil",()=>this.toggleToolDropdown()),this.toolButtonContainer.appendChild(this.currentToolButton),this.currentToolButton.title=__("Herramienta Actual||Current Tool"),this.toolDropdown=document.createElement("div"),this.toolDropdown.className="tool-dropdown",this.toolButtonContainer.appendChild(this.toolDropdown),this.toolSettingsButton=this.createButton("tool-settings","icon-settings",()=>this.showToolSettings()),this.toolSettingsButton.title=__("Opciones de herramienta||Tool settings"),this.toolSettingsButton.style.display="none",this.toolSelectionContainer.appendChild(this.toolSettingsButton),this.toolSettingsPopup=document.createElement("div"),this.toolSettingsPopup.className="tool-settings-popup",this.toolSettingsPopup.style.display="none",this.uiLayer.appendChild(this.toolSettingsPopup),this.toolSettingsPopup.addEventListener("click",e=>e.stopPropagation()),this.toolSwitcher=this.createButton("switch-tool","icon-switch-tool",()=>this.switchLastTool()),this.toolSelectionContainer.appendChild(this.toolSwitcher),this.animationButton=this.createButton("animation","icon-animation",()=>this.togglePanel("animation")),this.bottomBar.appendChild(this.animationButton),this.layersButton=this.createButton("layers","icon-layers",()=>this.togglePanel("layers")),this.bottomBar.appendChild(this.layersButton),this.undoRedoButtons=document.createElement("div"),this.undoRedoButtons.className="undo-redo-buttons",this.bottomBar.appendChild(this.undoRedoButtons),this.undoButton=this.createButton("undo","icon-undo",()=>this.undo()),this.undoRedoButtons.appendChild(this.undoButton),this.redoButton=this.createButton("redo","icon-redo",()=>this.redo()),this.undoRedoButtons.appendChild(this.redoButton),this.menuPanel=document.createElement("div"),this.menuPanel.className="menu-panel",this.uiLayer.appendChild(this.menuPanel),this.menuTabs=document.createElement("div"),this.menuTabs.className="menu-tabs",this.menuPanel.appendChild(this.menuTabs),this.menuContent=document.createElement("div"),this.menuContent.className="menu-content",this.menuPanel.appendChild(this.menuContent),this.createMenuTab("File"),this.createMenuTab("Edit"),this.createMenuTab("View"),this.createMenuTab("Color"),this.createMenuTab("Help"),this.animationPanel=document.createElement("div"),this.animationPanel.className="animation-timeline",this.uiLayer.appendChild(this.animationPanel);const e=document.createElement("div");e.className="timeline-header",this.animationPanel.appendChild(e),this.playPauseButton=this.createButton("play-pause","icon-play",()=>this.togglePlayback()),e.appendChild(this.playPauseButton),this.prevFrameButton=this.createButton("prev-frame","icon-prev",()=>this.prevFrame()),e.appendChild(this.prevFrameButton),this.nextFrameButton=this.createButton("next-frame","icon-next",()=>this.nextFrame()),e.appendChild(this.nextFrameButton);const t=document.createElement("div");t.className="fps-control",e.appendChild(t);const i=document.createElement("span");i.textContent="FPS:",t.appendChild(i),this.fpsInput=document.createElement("input"),this.fpsInput.type="number",this.fpsInput.min="1",this.fpsInput.max="60",this.fpsInput.value=this.animationFPS,this.fpsInput.addEventListener("change",()=>this.updateFPS()),t.appendChild(this.fpsInput);const s=document.createElement("div");s.className="panel-close timeline-close",s.innerHTML="&times;",s.addEventListener("click",()=>this.togglePanel("animation")),e.appendChild(s),this.timelineContent=document.createElement("div"),this.timelineContent.className="timeline-content",this.animationPanel.appendChild(this.timelineContent),this.animationPreview=document.createElement("canvas"),this.animationPreview.className="animation-preview",this.animationPreview.addEventListener("click",()=>{this.animationPanel.classList.add("visible"),this.animationButton.classList.add("active")}),this.animationPanel.appendChild(this.animationPreview),this.layersPanel=document.createElement("div"),this.layersPanel.className="layers-panel",this.uiLayer.appendChild(this.layersPanel);const a=document.createElement("div");a.className="panel-header",this.layersPanel.appendChild(a);const o=document.createElement("div");o.className="panel-title",o.textContent="Layers",a.appendChild(o);const n=document.createElement("div");n.className="panel-close",n.innerHTML="&times;",n.addEventListener("click",()=>this.togglePanel("layers")),a.appendChild(n),this.layersContainer=document.createElement("div"),this.layersContainer.className="layers-container",this.layersPanel.appendChild(this.layersContainer);const r=document.createElement("div");r.className="layer-actions",this.layersPanel.appendChild(r),this.addLayerButton=this.createButton("add-layer","+",()=>this.addLayer()),r.appendChild(this.addLayerButton),this.removeLayerButton=this.createButton("remove-layer","-",()=>this.removeLayer()),r.appendChild(this.removeLayerButton),this.notificationElement=document.createElement("div"),this.notificationElement.className="notification",document.body.appendChild(this.notificationElement),this.operationMessageElement=document.createElement("div"),this.operationMessageElement.className="operation-message",document.body.appendChild(this.operationMessageElement),this.popupOverlay=document.createElement("div"),this.popupOverlay.className="popup-overlay",document.body.appendChild(this.popupOverlay),this.popupContent=document.createElement("div"),this.popupContent.className="popup-content",this.popupOverlay.appendChild(this.popupContent),this.updateColorIndicator()}initReferenceImageUI(){this.referenceControls=document.createElement("div"),this.referenceControls.className="reference-controls",this.referenceControls.style.display="none",this.uiLayer.appendChild(this.referenceControls);const e=document.createElement("div");e.className="opacity-control",this.referenceControls.appendChild(e);const t=document.createElement("span");t.textContent="Ref Opacity:",t.className="opacity-label",e.appendChild(t),this.opacitySlider=document.createElement("input"),this.opacitySlider.type="range",this.opacitySlider.min="0",this.opacitySlider.max="100",this.opacitySlider.value=100*this.referenceOpacity,this.opacitySlider.className="opacity-slider",this.opacitySlider.addEventListener("input",e=>{this.referenceOpacity=parseInt(e.target.value)/100,this.render()}),e.appendChild(this.opacitySlider);const i=document.createElement("span");i.textContent="50%",i.className="opacity-value",e.appendChild(i),this.opacitySlider.addEventListener("input",e=>{i.textContent=`${e.target.value}%`}),this.toggleTopBottomReferenceButton=this.createButton("toggle-reference-layer","icon-switch-tool",()=>this.toggleReferenceTopBottom()),this.toggleTopBottomReferenceButton.title="Toggle Top/Bottom",this.referenceControls.appendChild(this.toggleTopBottomReferenceButton),this.closeReferenceButton=this.createButton("close-reference","icon-close",()=>this.removeReferenceImage()),this.closeReferenceButton.title="Remove Reference",this.referenceControls.appendChild(this.closeReferenceButton),this.updateReferenceControlsPosition()}initBrushUI(){this.brushSizeIndicator=document.createElement("div"),this.brushSizeIndicator.className="brush-size-indicator",this.brushSizeIndicator.style.display="none",this.uiLayer.appendChild(this.brushSizeIndicator),this.brushSizeText=document.createElement("div"),this.brushSizeText.className="brush-size-text",this.brushSizeText.textContent=`${__("Brocha||Brush")}: ${this.brushSize}px`,this.brushSizeIndicator.appendChild(this.brushSizeText),this.brushSizeBar=document.createElement("progress"),this.brushSizeBar.className="brush-size-bar",this.brushSizeIndicator.appendChild(this.brushSizeBar),this.updateBrushSizeIndicator()}initCanvas(){if(this.canvas=document.createElement("canvas"),this.canvas.className="editor-canvas",this.canvasContainer.appendChild(this.canvas),this.canvasWrapper=document.createElement("div"),this.canvasWrapper.className="canvas-wrapper",this.canvasWrapper.style.position="absolute",this.canvasWrapper.style.transformOrigin="0 0",this.canvasContainer.insertBefore(this.canvasWrapper,this.canvas),this.canvasWrapper.appendChild(this.canvas),this.gridOverlay=document.createElement("div"),this.gridOverlay.classList.add("grid-overlay"),this.gridOverlay.style.position="absolute",this.gridOverlay.style.top="0",this.gridOverlay.style.left="0",this.gridOverlay.style.pointerEvents="none",this.canvasContainer.appendChild(this.gridOverlay),this.ctx=this.getCanvasContext(this.canvas),this.scale=4,this.posX=0,this.posY=0,this.debugCanvas=document.getElementById("debug-canvas"),this.debugCanvas){const e=window.innerWidth,t=window.innerHeight;this.debugCanvas.width=e,this.debugCanvas.height=t,this.debugCtx=this.getCanvasContext(this.debugCanvas),this.debug={point:(i,s,a,o)=>{this.debugCtx.clearRect(0,0,e,t),this.drawBrushCircle(this.debugCtx,i,s,a||1,o||"#ffffff")},text:(i,s,a,o)=>{this.debugCtx.clearRect(0,0,e,t),this.debugCtx.fillStyle=o,this.debugCtx.fillText(a,i,s)}}}}getCanvasContext(e){const t=e.getContext("2d",{willReadFrequently:!0});return t.imageSmoothingEnabled=!1,t}getTempCanvas(e,t){return this.tempCanvas=this.tempCanvas||document.createElement("canvas"),this.tempCanvas.width=e||this.project.width,this.tempCanvas.height=t||this.project.height,this.tempCtx=this.tempCtx||this.getCanvasContext(this.tempCanvas),this.tempCtx.clearRect(0,0,this.tempCanvas.width,this.tempCanvas.height),{canvas:this.tempCanvas,ctx:this.tempCtx}}initEventListeners(){this.canvasContainer.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvasContainer.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvasContainer.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvasContainer.addEventListener("mouseleave",this.handleMouseUp.bind(this)),this.canvasContainer.addEventListener("wheel",this.handleMouseWheel.bind(this)),this.canvasContainer.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.canvasContainer.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.canvasContainer.addEventListener("touchend",this.handleTouchEnd.bind(this)),document.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("resize",this.handleResize.bind(this))}initTools(){this.addTool({name:"Pencil",displayName:__("Lápiz||Pencil"),icon:"tool-pencil",cursor:"crosshair",onDown:(e,t,i)=>{this.isDrawing=!0,this._previousPencilPosition={x:e,y:t},this.historyManager.startBatch("draw","Draw Pixels"),this.drawPixel(e,t)},onMove:(e,t)=>{this.isDrawing&&(this._previousPencilPosition&&this.distance(e,t,this._previousPencilPosition.x,this._previousPencilPosition.y)>=2?(this.startLine(this._previousPencilPosition.x,this._previousPencilPosition.y),this.finishLine(e,t)):this.drawPixel(e,t),this._previousPencilPosition={x:e,y:t})},onUp:(e,t)=>{this.isDrawing&&(this.isDrawing=!1,this.historyManager.endBatch()),this._previousPencilPosition=null}}),this.addTool({name:"Eraser",displayName:__("Borrador||Eraser"),icon:"tool-eraser",cursor:"crosshair",onDown:(e,t)=>{this.isDrawing=!0,this._previousPencilPosition={x:e,y:t},this.historyManager.startBatch("draw","Eraser Pixels"),this.drawPixel(e,t,{color:"transparent"})},onMove:(e,t)=>{this.isDrawing&&(this._previousPencilPosition&&this.distance(e,t,this._previousPencilPosition.x,this._previousPencilPosition.y)>=2?(this.startLine(this._previousPencilPosition.x,this._previousPencilPosition.y,"transparent"),this.finishLine(e,t)):this.drawPixel(e,t,{color:"transparent"}),this._previousPencilPosition={x:e,y:t})},onUp:(e,t)=>{this.isDrawing&&(this.isDrawing=!1,this.historyManager.endBatch()),this._previousPencilPosition=null}}),this.addTool({name:"Line",displayName:__("Línea||Line"),icon:"tool-line",cursor:"crosshair",onDown:(e,t)=>{this.startLine(e,t)},onMove:(e,t)=>{this.tempLine&&this.previewLine(e,t)},onUp:(e,t)=>{this.tempLine&&(this.finishLine(e,t),this.saveToHistory())}}),this.addTool({name:"Rectangle",displayName:__("Rectángulo||Rectangle"),icon:"tool-rect",cursor:"crosshair",settings:{filled:{type:"boolean",default:!1},perfect:{type:"boolean",default:!1}},onDown:(e,t)=>{this.startRect(e,t)},onMove:(e,t)=>{this.tempRect&&this.previewRect(e,t)},onUp:(e,t)=>{this.tempRect&&(this.finishRect(e,t),this.saveToHistory())}}),this.addTool({name:"Ellipse",displayName:__("Elipse||Ellipse"),icon:"tool-ellipse",cursor:"crosshair",settings:{filled:{type:"boolean",default:!1},perfect:{type:"boolean",default:!1}},onDown:(e,t)=>{this.startEllipse(e,t)},onMove:(e,t)=>{this.tempEllipse&&this.previewEllipse(e,t)},onUp:(e,t)=>{this.tempEllipse&&(this.finishEllipse(e,t),this.saveToHistory())}}),this.addTool({name:"Paint Bucket",displayName:__("Cubeta||Paint Bucket"),icon:"tool-bucket",cursor:"crosshair",onDown:(e,t)=>{this.fillArea(e,t),this.saveToHistory()}}),this.addTool({name:"Pipette",displayName:__("Pipeta||Pipette"),icon:"tool-pipette",cursor:"crosshair",onDown:(e,t)=>{this.pickColor(e,t)}}),this.setTool("Pencil"),this.lastTool="Eraser"}initColorPicker(){this.colorPickerOverlay=document.createElement("div"),this.colorPickerOverlay.className="color-picker-overlay",this.colorPickerOverlay.style.display="none",document.body.appendChild(this.colorPickerOverlay),this.colorPicker=document.createElement("div"),this.colorPicker.className="color-picker",this.colorPickerOverlay.appendChild(this.colorPicker),this.colorPicker.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation()}),this.colorPicker.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation()}),this.colorPicker.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation()}),this.colorPickerOverlay.addEventListener("dragover",e=>{e.preventDefault(),this.colorPickerOverlay.classList.add("drag-over")}),this.colorPickerOverlay.addEventListener("dragleave",()=>{this.colorPickerOverlay.classList.remove("drag-over")}),this.colorPickerOverlay.addEventListener("drop",e=>{e.preventDefault(),this.deleteZone.classList.remove("drag-over");const t=parseInt(e.dataTransfer.getData("text/plain")),i=this.lastPalette.colors[t];i&&this.addFloatingPaletteColor(i,event.clientX,event.clientY)});const e=document.createElement("div");e.className="color-picker-header",this.colorPicker.appendChild(e),this.colorPickerTitle=document.createElement("div"),this.colorPickerTitle.className="color-picker-title",this.colorPickerTitle.textContent=__("Recoge Color||Color Picker"),e.appendChild(this.colorPickerTitle);const t=document.createElement("div");t.className="panel-close color-picker-close",t.innerHTML="&times;",t.addEventListener("click",()=>this.hideColorPicker()),e.appendChild(t),this.colorPickerTabs=document.createElement("div"),this.colorPickerTabs.className="color-picker-tabs",this.colorPicker.appendChild(this.colorPickerTabs),this.rgbTab=this.createColorPickerTab("RGB",()=>this.showColorPickerTab("rgb")),this.hsvTab=this.createColorPickerTab("HSV",()=>this.showColorPickerTab("hsv")),this.paletteTab=this.createColorPickerTab(__("Paleta||Palette"),()=>this.showColorPickerTab("palette")),this.colorPickerContent=document.createElement("div"),this.colorPickerContent.className="color-picker-content",this.colorPicker.appendChild(this.colorPickerContent),this.rgbContent=document.createElement("div"),this.rgbContent.className="color-picker-tab-content rgb-content",this.colorPickerContent.appendChild(this.rgbContent),this.createColorSlider("r",__("Rojo||Red"),0,255,this.rgbContent),this.createColorSlider("g",__("Verde||Green"),0,255,this.rgbContent),this.createColorSlider("b",__("Azul||Blue"),0,255,this.rgbContent),this.hsvContent=document.createElement("div"),this.hsvContent.className="color-picker-tab-content hsv-content",this.colorPickerContent.appendChild(this.hsvContent),this.createColorSlider("h",__("Tono||Hue"),0,360,this.hsvContent),this.createColorSlider("s",__("Saturación||Saturation"),0,100,this.hsvContent,"%"),this.createColorSlider("v",__("Valor||Value"),0,100,this.hsvContent,"%"),this.paletteContent=document.createElement("div"),this.paletteContent.className="color-picker-tab-content palette-content",this.colorPickerContent.appendChild(this.paletteContent);const i=document.createElement("div");i.className="palette-actions",this.paletteContent.appendChild(i),this.loadPaletteButton=this.createButton("load-palette","icon-folder",()=>this.loadPalette()),this.loadPaletteButton.textContent=__("Cargar||Load"),i.appendChild(this.loadPaletteButton),this.savePaletteButton=this.createButton("save-palette","icon-save",()=>this.savePalette()),this.savePaletteButton.textContent=__("Guardar||Save"),i.appendChild(this.savePaletteButton),this.paletteGrid=document.createElement("div"),this.paletteGrid.className="palette-grid",this.paletteContent.appendChild(this.paletteGrid),this.recentColorsContainer=document.createElement("div"),this.recentColorsContainer.className="recent-colors",this.colorPicker.appendChild(this.recentColorsContainer);const s=document.createElement("div");s.className="recent-colors-title",s.textContent=__("Colores Recientes||Recent Colors"),this.recentColorsContainer.appendChild(s),this.recentColorsGrid=document.createElement("div"),this.recentColorsGrid.className="recent-colors-grid",this.recentColorsContainer.appendChild(this.recentColorsGrid);const a=document.createElement("div");a.className="color-picker-footer",this.colorPicker.appendChild(a),this.currentColorPreview=document.createElement("div"),this.currentColorPreview.className="current-color-preview",this.currentColorPreview.addEventListener("click",()=>this.showHexColorInputDialog().then(e=>this.updateColorSlidersFromHex(e))),a.appendChild(this.currentColorPreview),this.confirmColorButton=this.createButton("confirm-color",null,()=>this.confirmColorSelection()),this.confirmColorButton.textContent=__("Usar color||Pick color"),a.appendChild(this.confirmColorButton),this.showColorPickerTab("rgb");const o=document.querySelector(".palette-delete-zone");o&&o.remove(),this.deleteZone=document.createElement("div"),this.deleteZone.className="palette-delete-zone",this.deleteZone.innerHTML='\n      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n      </svg>\n    ',this.deleteZone.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation(),this.deleteZone.classList.add("drag-over")}),this.deleteZone.addEventListener("dragleave",()=>{this.deleteZone.classList.remove("drag-over")}),this.deleteZone.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation(),this.deleteZone.classList.remove("drag-over");const t=parseInt(e.dataTransfer.getData("text/plain"));this.removeColorFromPalette(t)}),this.colorPickerOverlay.appendChild(this.deleteZone)}initColorPickerDrag(){this.colorPickLine=document.createElement("div"),this.colorPickLine.className="color-pick-line",this.colorPickLine.style.display="none",document.body.appendChild(this.colorPickLine),this.colorIndicator.addEventListener("mousedown",this.handleColorPickStart.bind(this)),this.colorIndicator.addEventListener("touchstart",this.handleColorPickStart.bind(this),{passive:!1}),this.colorIndicator.addEventListener("touchcancel",this.handleTouchCancel.bind(this))}updateBrushSizeIndicator(){this.brushSizeText.textContent=__(`(Pincel|Brush): ${this.brushSize}px`),this.brushSizeBar.min=0,this.brushSizeBar.max=this.maxBrushSize,this.brushSizeBar.value=this.brushSize}showLoadingScreen(e="Loading"){this.loadingElement.style.display="flex",this.loadingText.innerHTML=e}hideLoadingScreen(){this.loadingElement.style.display="none"}handleColorPickStart(e){this.isDrawing||this.isPanning||(this.colorPickStartTime=Date.now(),this.colorPickStartPos={x:"touchstart"===e.type?e.touches[0].clientX:e.clientX,y:"touchstart"===e.type?e.touches[0].clientY:e.clientY},this.colorPickTimeout=setTimeout(()=>{this.isColorPicking=!0,this.colorIndicator.classList.add("dragging");const e=this.colorIndicator.getBoundingClientRect();this.colorPickStartX=e.left+e.width/2,this.colorPickStartY=e.top+e.height/2,this.colorPickLine.style.display="block",this.updateColorPickLine(this.colorPickStartX,this.colorPickStartY,this.colorPickStartPos.x,this.colorPickStartPos.y),document.addEventListener("mousemove",this.handleColorPickMove.bind(this)),document.addEventListener("mouseup",this.handleColorPickEnd.bind(this)),document.addEventListener("touchmove",this.handleColorPickMove.bind(this),{passive:!1}),document.addEventListener("touchend",this.handleColorPickEnd.bind(this))},300),e.preventDefault(),e.stopPropagation())}handleColorPickMove(e){if(!this.isColorPicking){const t="touchmove"===e.type?e.touches[0].clientX:e.clientX,i="touchmove"===e.type?e.touches[0].clientY:e.clientY;if(this.distance(t,i,this.colorPickStartPos.x,this.colorPickStartPos.y)>15&&this.colorPickTimeout){clearTimeout(this.colorPickTimeout),this.isColorPicking=!0,this.colorIndicator.classList.add("dragging");const e=this.colorIndicator.getBoundingClientRect();this.colorPickStartX=e.left+e.width/2,this.colorPickStartY=e.top+e.height/2,this.colorPickLine.style.display="block",this.updateColorPickLine(this.colorPickStartX,this.colorPickStartY,t,i)}return}let t,i;"touchmove"===e.type?(t=e.touches[0].clientX,i=e.touches[0].clientY):(t=e.clientX,i=e.clientY),this.updateColorPickLine(this.colorPickStartX,this.colorPickStartY,t,i),e.preventDefault()}handleColorPickEnd(e){if(this.colorPickTimeout&&(clearTimeout(this.colorPickTimeout),this.colorPickTimeout=null),!this.isColorPicking){const t=Date.now()-this.colorPickStartTime<200,i=this.colorPickStartPos?this.distance("touchend"===e.type?e.changedTouches[0].clientX:e.clientX,"touchend"===e.type?e.changedTouches[0].clientY:e.clientY,this.colorPickStartPos.x,this.colorPickStartPos.y):0;return void(t&&i<10&&this.toggleSelectedColor())}let t,i;"touchend"===e.type?(t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY):(t=e.clientX,i=e.clientY);const s=this.canvasContainer.getBoundingClientRect();if(t>=s.left&&t<=s.right&&i>=s.top&&i<=s.bottom){const e=this.getCanvasPosition(t,i);e&&this.pickColor(e.x,e.y)}this.cleanupColorPicking(),e.preventDefault()}updateColorPickLine(e,t,i,s){const a=Math.sqrt(Math.pow(i-e,2)+Math.pow(s-t,2)),o=180*Math.atan2(s-t,i-e)/Math.PI;this.colorPickLine.style.width=`${a}px`,this.colorPickLine.style.left=`${e}px`,this.colorPickLine.style.top=`${t}px`,this.colorPickLine.style.transform=`rotate(${o}deg)`,this.colorPickLine.style.transformOrigin="0 0"}cleanupColorPicking(){this.isColorPicking=!1,this.colorPickLine.style.display="none",this.colorIndicator.classList.remove("dragging"),this.colorPickTimeout&&(clearTimeout(this.colorPickTimeout),this.colorPickTimeout=null),document.removeEventListener("mousemove",this.handleColorPickMove.bind(this)),document.removeEventListener("mouseup",this.handleColorPickEnd.bind(this)),document.removeEventListener("touchmove",this.handleColorPickMove.bind(this)),document.removeEventListener("touchend",this.handleColorPickEnd.bind(this))}createColorPickerTab(e,t){const i=document.createElement("div");return i.className="color-picker-tab",i.textContent=e,i.addEventListener("click",t),this.colorPickerTabs.appendChild(i),i}createColorSlider(e,t,i,s,a,o=""){const n=document.createElement("div");n.className="color-slider-container";const r=document.createElement("label");r.textContent=t,n.appendChild(r);const l=document.createElement("div");l.className="slider-controls",n.appendChild(l);const c=document.createElement("button");c.className="slider-btn decrease",c.innerHTML="&minus;",c.addEventListener("click",()=>this.adjustColorChannel(e,-1)),l.appendChild(c);const h=document.createElement("input");h.type="range",h.min=i,h.max=s,h.value="r"===e?255:0,h.className=`color-slider ${e}-slider`,h.addEventListener("input",t=>this.handleColorSliderChange(e,t.target.value)),l.appendChild(h);const d=document.createElement("button");d.className="slider-btn increase",d.innerHTML="+",d.addEventListener("click",()=>this.adjustColorChannel(e,1)),l.appendChild(d);const p=document.createElement("input");p.type="number",p.min=i,p.max=s,p.value="r"===e?255:0,p.className=`color-value ${e}-value`,p.addEventListener("keyup",t=>this.handleColorValueChange(e,t.target.value)),l.appendChild(p);const m=document.createElement("span");m.className="suffix",m.textContent=o,l.appendChild(m),a.appendChild(n)}showColorPickerTab(e){this.colorPickerContent.querySelectorAll(".color-picker-tab-content").forEach(e=>e.style.display="none");this.colorPickerTabs.querySelectorAll(".color-picker-tab").forEach(e=>e.classList.remove("active")),"rgb"===e?(this.rgbContent.style.display="block",this.rgbTab.classList.add("active"),this.updateColorSlidersFromHex(this.colorPickerPreviewColor)):"hsv"===e?(this.hsvContent.style.display="block",this.hsvTab.classList.add("active"),this.updateColorSlidersFromHex(this.colorPickerPreviewColor)):"palette"===e&&(this.paletteContent.style.display="block",this.paletteTab.classList.add("active"),this.updatePaletteGrid())}updateColorSlidersFromHex(e){if(!e)return;const{r:t,g:i,b:s}=this.hexToRgb(e);this.updateColorSlider("r",t),this.updateColorSlider("g",i),this.updateColorSlider("b",s);const a=this.rgbToHsv(t,i,s);this.updateColorSlider("h",a.h),this.updateColorSlider("s",a.s),this.updateColorSlider("v",a.v),this.currentColorPreview.style.backgroundColor=e,this.colorPickerPreviewColor=e}updateColorSlider(e,t){const i=this.colorPicker.querySelector(`.${e}-slider`),s=this.colorPicker.querySelector(`.${e}-value`);i&&(i.value=t),s&&(s.value=t)}handleColorSliderChange(e,t){this.updateColorSlider(e,t),this.updateColorFromSliders("r"==e||"g"==e||"b"==e)}handleColorValueChange(e,t){const i=this.colorPicker.querySelector(`.${e}-slider`),s=parseInt(i.min),a=parseInt(i.max);t=Math.max(s,Math.min(a,parseInt(t)||0)),this.updateColorSlider(e,t),this.updateColorFromSliders()}adjustColorChannel(e,t){const i=this.colorPicker.querySelector(`.${e}-value`),s=this.colorPicker.querySelector(`.${e}-slider`),a=parseInt(s.min),o=parseInt(s.max);let n=parseInt(i.value)+t;n=Math.max(a,Math.min(o,n)),this.updateColorSlider(e,n),this.updateColorFromSliders()}updateColorFromSliders(e=!0){if(e){const e=parseInt(this.colorPicker.querySelector(".r-value").value),t=parseInt(this.colorPicker.querySelector(".g-value").value),i=parseInt(this.colorPicker.querySelector(".b-value").value),s=this.rgbToHex(e,t,i);this.colorPickerPreviewColor=s,this.currentColorPreview.style.backgroundColor=s}else{const e=parseInt(this.colorPicker.querySelector(".h-value").value),t=parseInt(this.colorPicker.querySelector(".s-value").value),i=parseInt(this.colorPicker.querySelector(".v-value").value),s=this.hsvToRgb(e,t,i),a=this.rgbToHex(s.r,s.g,s.b);this.colorPickerPreviewColor=a,this.currentColorPreview.style.backgroundColor=a}}rgbToHex(e,t,i){return`#${((1<<24)+(e<<16)+(t<<8)+i).toString(16).slice(1)}`}hexToRgb(e){return{r:parseInt(e.slice(1,3),16),g:parseInt(e.slice(3,5),16),b:parseInt(e.slice(5,7),16)}}rgbToHsv(e,t,i){e/=255,t/=255,i/=255;const s=Math.max(e,t,i),a=Math.min(e,t,i);let o,n,r=s;const l=s-a;if(n=0===s?0:l/s,s===a)o=0;else{switch(s){case e:o=(t-i)/l+(t<i?6:0);break;case t:o=(i-e)/l+2;break;case i:o=(e-t)/l+4}o/=6}return{h:Math.round(360*o),s:Math.round(100*n),v:Math.round(100*r)}}hsvToRgb(e,t,i){let s,a,o;e/=360,t/=100,i/=100;const n=Math.floor(6*e),r=6*e-n,l=i*(1-t),c=i*(1-r*t),h=i*(1-(1-r)*t);switch(n%6){case 0:s=i,a=h,o=l;break;case 1:s=c,a=i,o=l;break;case 2:s=l,a=i,o=h;break;case 3:s=l,a=c,o=i;break;case 4:s=h,a=l,o=i;break;case 5:s=i,a=l,o=c}return{r:Math.round(255*s),g:Math.round(255*a),b:Math.round(255*o)}}showColorPicker(){const e="primary"===this.selectedColor?this.primaryColor:this.secondaryColor;this.updateColorSlidersFromHex(e),this.updateRecentColorsGrid(),this.colorPickerOverlay.style.display="flex",this.colorPickerOpen=!0}hideColorPicker(){this.colorPickerOverlay.style.display="none",this.colorPickerOpen=!1}confirmColorSelection(){const e=this.colorPickerPreviewColor;e&&("primary"===this.selectedColor?this.primaryColor=e:this.secondaryColor=e,this.updateColorIndicator(),this.addToRecentColors(e),this.hideColorPicker())}addToRecentColors(e){this.recentColors=this.recentColors.filter(t=>t!==e),this.recentColors.unshift(e),this.recentColors.length>20&&this.recentColors.pop(),localStorage.setItem("recentColors",JSON.stringify(this.recentColors)),this.updateRecentColorsGrid()}updateRecentColorsGrid(){this.recentColorsGrid.innerHTML="",this.recentColors.forEach(e=>{const t=document.createElement("div");t.className="recent-color",t.style.backgroundColor=e,t.addEventListener("click",()=>{this.updateColorSlidersFromHex(e)}),this.recentColorsGrid.appendChild(t)})}updatePaletteGrid(){this.paletteGrid.innerHTML="",this.lastPalette||(this.lastPalette={name:"Custom Palette",colors:[]});for(let e=0;e<this.lastPalette.colors.length;e++){const t=this.lastPalette.colors[e],i=document.createElement("div");i.className="palette-color",i.style.backgroundColor=t,i.draggable=!0,i.dataset.index=e,i.addEventListener("click",()=>{this.updateColorSlidersFromHex(t)}),i.addEventListener("dragstart",t=>{t.dataTransfer.setData("text/plain",e.toString()),i.classList.add("dragging"),this.deleteZone.classList.add("visible")}),i.addEventListener("dragend",()=>{i.classList.remove("dragging"),this.deleteZone.classList.remove("visible"),this.colorPickerOverlay.classList.remove("drag-over")}),i.addEventListener("dragover",e=>{e.preventDefault()}),i.addEventListener("drop",t=>{t.preventDefault();const i=parseInt(t.dataTransfer.getData("text/plain")),s=e;i!==s&&this.moveColor(i,s)}),this.paletteGrid.appendChild(i)}const e=document.createElement("div");e.className="palette-add-button",e.innerHTML="+",e.title="Add new color",e.addEventListener("click",()=>{this.showHexColorInputDialog().then(e=>this.addColorToPalette(e))}),this.paletteGrid.appendChild(e)}addColorToPalette(e){this.lastPalette||(this.lastPalette={name:"Custom Palette",colors:[]}),this.lastPalette.colors||(this.lastPalette.colors=[]),this.lastPalette.colors.push(e),this.updatePaletteGrid(),this.showNotification("Color added to palette")}removeColorFromPalette(e){this.lastPalette&&this.lastPalette.colors&&(this.lastPalette.colors.splice(e,1),this.updatePaletteGrid(),this.showNotification("Color removed from palette"))}moveColor(e,t){if(this.lastPalette&&this.lastPalette.colors){const i=this.lastPalette.colors.splice(e,1)[0];this.lastPalette.colors.splice(t,0,i),this.updatePaletteGrid()}}removeColor(e,t){e.splice(t,1),e===this.recentColors?(this.updateRecentColorsGrid(),this.showNotification("Color removed from recent colors")):(this.updatePaletteGrid(),this.showNotification("Color removed from palette")),this.hideColorMenu()}loadPalette(){this.getFileBrowser({title:__("Cargar paleta||Load palette"),mode:"open",fileTypes:["pal"],onConfirm:async e=>{try{const t=await this.readFile(e);this.parsePalFile(t),this.updatePaletteGrid(),this.showNotification(__("Paleta cargada||Palette loaded successfully"))}catch(e){this.showNotification(`Error loading palette: ${e.message}`,5e3),console.error(e)}}}).show()}savePalette(){if(!this.lastPalette||!this.lastPalette.colors||0===this.lastPalette.colors.length)return void this.showNotification(__("No hay paleta que guardar||No palette to save"),3e3);this.getFileBrowser({title:__("Guardar paleta||Save palette"),mode:"saveAs",fileTypes:["pal"],defaultType:"pal",defaultName:this.lastPalette.name||"palette",onConfirm:async e=>{try{const t=this.generatePalFile();await this.saveFile(e.name,"pal",t),this.showNotification(__("Paleta guardada||Palette saved successfully"))}catch(e){this.showNotification(`Error saving palette: ${e.message}`,5e3),console.error(e)}}}).show()}parsePalFile(e){const t=e.split("\n").map(e=>e.trim()).filter(e=>e.length>0);if(t.length<3||"JASC-PAL"!==t[0])throw new Error("Invalid PAL file format - missing JASC-PAL header");if("0100"!==t[1])throw new Error("Unsupported PAL version - expected 0100");const i=parseInt(t[2]);if(isNaN(i))throw new Error("Invalid color count - not a number");if(t.length<3+i)throw new Error(`File claims to have ${i} colors but only ${t.length-3} found`);const s=[];for(let e=3;e<3+i;e++){const i=t[e].split(/\s+/).filter(e=>e.length>0);if(i.length<3)throw new Error(`Invalid color at line ${e+1} - expected 3 components`);const a=parseInt(i[0]),o=parseInt(i[1]),n=parseInt(i[2]);if(isNaN(a)||isNaN(o)||isNaN(n))throw new Error(`Invalid RGB values at line ${e+1}`);if(a<0||a>255||o<0||o>255||n<0||n>255)throw new Error(`RGB values out of range (0-255) at line ${e+1}`);s.push(this.rgbToHex(a,o,n))}this.lastPalette={name:"Imported Palette",colors:s},localStorage.setItem("lastPalette",JSON.stringify(this.lastPalette))}generatePalFile(){const e=this.lastPalette.colors.map(e=>{const{r:t,g:i,b:s}=this.hexToRgb(e);return`${t} ${i} ${s}`});return["JASC-PAL","0100",e.length.toString(),...e].join("\n")}loadFloatingColors(e){e&&e.length&&e.forEach&&(this.removeAllFloatingPaletteColors(),e.forEach(e=>{this.addFloatingPaletteColor(e.color,e.x,e.y)}))}addFloatingPaletteColor(e,t,i){const s=document.createElement("div");s.className="palette-color floating",s.style.backgroundColor=e;const a=`color_${Date.now()}`;s.dataset.color=e,s.dataset.id=a,s.dataset.x=t,s.dataset.y=i,s.draggable=!0,s.moving=!1,s.style.top=`${i}px`,s.style.left=`${t}px`,s.addEventListener("click",()=>{this.setColor(e)}),s.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",a),s.classList.add("dragging"),this.floatingColorsDeleteZone.classList.add("visible")}),s.addEventListener("dragend",e=>{e.preventDefault(),s.classList.remove("dragging"),this.floatingColorsDeleteZone.classList.remove("visible"),e.clientX&&e.clientY&&(s.style.top=`${e.clientY}px`,s.style.left=`${e.clientX}px`,s.dataset.x=e.clientX,s.dataset.y=e.clientY,this.saveFloatingColors())}),s.addEventListener("dragover",e=>{e.preventDefault()}),this.overlayLayer.appendChild(s),this.floatingColors.set(a,s),this.saveFloatingColors()}removeFloatingPaletteColor(e){const t=this.floatingColors.get(e);t&&(t.remove(),this.floatingColors.delete(e),this.saveFloatingColors())}removeAllFloatingPaletteColors(){this.floatingColors.forEach(e=>e[1]?.remove?.()),this.floatingColors.clear(),this.saveFloatingColors()}saveFloatingColors(){localStorage.setItem("floatingColors",this.getFloatingColorsData())}getFloatingColorsData(){return JSON.stringify(Array.from(this.floatingColors).map(e=>e[1]).map(e=>({color:e.dataset.color,x:e.dataset.x,y:e.dataset.y})))}createButton(e,t,i){const s=document.createElement("button");if(s.className="ui-button",s.id=e,t){const e=document.createElement("div");e.className=`icon ${t}`,s.appendChild(e)}return i&&s.addEventListener("click",i),s}createMenuTab(e){const t={File:__("Archivo||File"),Edit:__("Editar||Edit"),View:__("Ver||View"),Color:"Color",Help:__("Ayuda||Help")},i=document.createElement("div");i.className="menu-tab",i.textContent=t[e]||e,i.name=e,i.addEventListener("click",()=>this.showMenuContent(e)),this.menuTabs.appendChild(i);const s=document.createElement("div");s.className=`menu-content-${e.toLowerCase()}`,s.style.display="none",this.menuContent.appendChild(s),"File"===e?this.createFileMenu(s):"Edit"===e?this.createEditMenu(s):"View"===e?this.createViewMenu(s):"Color"===e?this.createColorMenu(s):"Help"===e&&this.createHelpMenu(s),1===this.menuTabs.children.length&&(i.classList.add("active"),s.style.display="block")}createFileMenu(e){const t=document.createElement("div");t.className="menu-section",e.appendChild(t);const i=document.createElement("div");i.className="menu-item",i.textContent=__("Nuevo Proyecto||New Project"),i.addEventListener("click",()=>this.showNewProjectDialog()),t.appendChild(i);const s=document.createElement("div");s.className="menu-item",s.textContent=__("Abrir...||Open..."),s.addEventListener("click",()=>this.openFile()),t.appendChild(s);const a=document.createElement("div");a.className="menu-item",a.textContent=__("Guardar||Save"),a.addEventListener("click",()=>this.saveProject()),t.appendChild(a);const o=document.createElement("div");o.className="menu-item",o.textContent=__("Guardar Como...||Save As..."),o.addEventListener("click",()=>this.saveAs()),t.appendChild(o);const n=document.createElement("div");n.className="menu-item",n.textContent=__("Cargar Referencia...||Load Reference..."),n.addEventListener("click",()=>this.loadReferenceImage()),t.appendChild(n);const r=document.createElement("div");r.className="menu-item",r.innerHTML=`\n      <span>${__("Modo Colaborativo||Collab Mode")}</span>\n      <span class="collab-status" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: 8px;"></span>\n    `,r.addEventListener("click",()=>this.showCollabDialog()),t.appendChild(r);const l=document.createElement("div");l.className="menu-item",l.textContent=__("Exportar Frame Actual...||Export Current Frame"),l.addEventListener("click",()=>this.exportCurrentFrame()),t.appendChild(l);const c=document.createElement("div");c.className="menu-item",c.textContent=__("Exportar Animación||Export Animation"),c.addEventListener("click",()=>this.exportAnimation()),t.appendChild(c);this.menuContent.querySelector(".menu-content-file");const h=document.createElement("div");h.className="menu-item",h.textContent=__("Exportar Timelapse...||Export Timelapse..."),h.addEventListener("click",()=>this.exportTimelapse()),t.appendChild(h);const d=document.createElement("div");d.className="menu-item",d.textContent=__("Salir de la app||Exit App"),d.addEventListener("click",()=>this.exitApp()),d.style.display="none",t.appendChild(d),document.addEventListener("deviceready",()=>d.style.display="")}createEditMenu(e){const t=document.createElement("div");t.className="menu-section",e.appendChild(t);const i=document.createElement("h3");i.textContent=__("Transformar||Transform"),t.appendChild(i);const s=document.createElement("div");s.className="menu-item",s.textContent=__("Girar Horizontal||Flip Horizontal"),s.addEventListener("click",()=>this.flipHorizontal()),t.appendChild(s);const a=document.createElement("div");a.className="menu-item",a.textContent=__("Girar Vertical||Flip Vertical"),a.addEventListener("click",()=>this.flipVertical()),t.appendChild(a);const o=document.createElement("div");o.className="menu-item",o.textContent=__("(Rotar|Rotate) 90° CW"),o.addEventListener("click",()=>this.rotate(90)),t.appendChild(o);const n=document.createElement("div");n.className="menu-item",n.textContent=__("(Rotar|Rotate) 90° CCW"),n.addEventListener("click",()=>this.rotate(270)),t.appendChild(n);const r=document.createElement("div");r.className="menu-item",r.textContent=__("(Rotar|Rotate) 180°"),r.addEventListener("click",()=>this.rotate(180)),t.appendChild(r);const l=document.createElement("div");l.className="menu-section",e.appendChild(l);const c=document.createElement("h3");c.textContent=__("Animación||Animation"),l.appendChild(c);const h=document.createElement("div");h.className="menu-item",h.textContent=__("Cambiar FPS...||Set FPS..."),h.addEventListener("click",()=>this.showFPSDialog()),l.appendChild(h);const d=document.createElement("div");d.className="menu-item",d.textContent=__("Cambiar Tiempo del Frame...||Set Frame Time..."),d.addEventListener("click",()=>this.showCurrentFrameTimeDialog()),l.appendChild(d);const p=document.createElement("div");p.className="menu-section",e.appendChild(p);const m=document.createElement("h3");m.textContent=__("Cuadrículas||Grids"),p.appendChild(m);const u=document.createElement("div");u.className="menu-item",u.textContent=__("Configurar||Configure"),u.addEventListener("click",()=>{this.gridManager.toggle(),this.menuPanel.classList.remove("visible")}),p.appendChild(u);const g=document.createElement("div");g.className="menu-section",e.appendChild(g);const v=document.createElement("h3");v.textContent=__("Ajustes||Settings"),g.appendChild(v);const y=document.createElement("div");y.className="menu-item",y.textContent=__("Configurar||Configure"),y.addEventListener("click",()=>this.settingsUI.toggle()),g.appendChild(y)}createViewMenu(e){const t=document.createElement("div");t.className="menu-section",e.appendChild(t);const i=document.createElement("h3");i.textContent=__("Visualization||View Options"),t.appendChild(i);const s=document.createElement("div");s.className="menu-item",s.textContent=__("Acercar||Zoom In"),s.addEventListener("click",()=>this.zoom(1.2)),t.appendChild(s);const a=document.createElement("div");a.className="menu-item",a.textContent=__("Alejar||Zoom Out"),a.addEventListener("click",()=>this.zoom(.8)),t.appendChild(a);const o=document.createElement("div");o.className="menu-item",o.textContent=__("Reiniciar zoom||Reset Zoom"),o.addEventListener("click",()=>this.resetZoom()),t.appendChild(o);const n=document.createElement("div");n.className="menu-item",n.textContent=__("Alternar vista previa||Toggle Preview"),n.addEventListener("click",()=>this.togglePreview()),t.appendChild(n)}createColorMenu(e){const t=document.createElement("div");t.className="menu-section",e.appendChild(t);const i=document.createElement("h3");i.textContent=__("Ajustes de Color||Color Adjustments"),t.appendChild(i);const s=document.createElement("div");s.className="menu-item",s.textContent=__("Alternar Transferencia||Toggle Transparency"),s.addEventListener("click",()=>this.toggleTransparency()),t.appendChild(s);const a=document.createElement("div");a.className="menu-item",a.textContent=__("Invertir Colores||Invert Colors"),a.addEventListener("click",()=>this.invertColors()),t.appendChild(a);const o=document.createElement("div");o.className="menu-item",o.textContent=__("Escala de Grises||Grayscale"),o.addEventListener("click",()=>this.grayscale()),t.appendChild(o);const n=document.createElement("div");n.className="menu-item",n.textContent=__("Ajustar Brillo...||Adjust Brightness..."),n.addEventListener("click",()=>this.showBrightnessDialog()),t.appendChild(n)}createHelpMenu(e){const t=document.createElement("div");t.className="menu-section",e.appendChild(t);const i=document.createElement("div");i.className="menu-item",i.textContent=__("Acerca de...||About..."),i.addEventListener("click",()=>this.showAboutDialog()),t.appendChild(i);const s=document.createElement("div");s.className="menu-item",s.textContent="Manual",s.addEventListener("click",()=>this.showManualDialog()),t.appendChild(s)}showMenuContent(e){this.menuContent.querySelectorAll('div[class^="menu-content-"]').forEach(e=>{e.style.display="none"});const t=this.menuTabs.querySelectorAll(".menu-tab");t.forEach(e=>{e.classList.remove("active")});const i=this.menuContent.querySelector(`.menu-content-${e.toLowerCase()}`);i&&(i.style.display="block");const s=Array.from(t).find(t=>t.name===e);s&&s.classList.add("active")}toggleMenu(){this.menuPanel.classList.toggle("visible"),this.menuPanelOpen=!this.menuPanelOpen}togglePanel(e){"animation"===e?(this.animationPanel.classList.toggle("visible"),this.animationButton.classList.toggle("active"),this.layersPanel.classList.remove("visible"),this.layersButton.classList.remove("active"),this.adjustTimelinePosition(),this.isPlaying&&this.stopAnimation(),this.animationPanelOpen=!this.animationPanelOpen):"layers"===e&&(this.layersPanel.classList.toggle("visible"),this.layersButton.classList.toggle("active"),this.animationPanel.classList.remove("visible"),this.animationButton.classList.remove("active"),this.layersPanelOpen=!this.layersPanelOpen)}togglePreview(){this.showMiniView=!this.showMiniView,this.animationPreview.classList.toggle("visible")}blockInputIfPanelsVisible(){return this.menuPanel.classList.contains("visible")?(this.toggleMenu(),!0):!!this.layersPanel.classList.contains("visible")&&(this.togglePanel("layers"),!0)}handleMouseDown(e){if(this.blockInputIfPanelsVisible())return;const t=this.getCanvasPosition(e.clientX,e.clientY);if(t){switch(e.button){case 0:this.isDrawing=!0,this.startX=t.x,this.startY=t.y,this.currentTool&&this.currentTool.onDown&&this.currentTool.onDown(t.x,t.y);break;case 1:this.isDrawing&&this.handleMouseUp(e),this.isPanning=!0,this.panStartX=e.clientX,this.panStartY=e.clientY;break;case 2:this.onMouseUp(e)}e.preventDefault()}}handleMouseMove(e){const t=this.getCanvasPosition(e.clientX,e.clientY);t&&(this.isDrawing&&this.currentTool&&this.currentTool.onMove&&this.currentTool.onMove(t.x,t.y),this.isPanning&&this.pan(e.clientX,e.clientY),e.preventDefault())}handleMouseUp(e){if(this.isPanning=!1,!this.isDrawing)return;const t=this.getCanvasPosition(e.clientX,e.clientY);t&&this.currentTool&&this.currentTool.onUp&&this.currentTool.onUp(t.x,t.y,this.startX,this.startY),this.isDrawing=!1,e.preventDefault()}handleMouseWheel(e){e&&0!=e.deltaY&&(e.deltaY<0?this.zoom(1.2,e.clientX,e.clientY):this.zoom(.8,e.clientX,e.clientY))}handleTouchStart(e){if(!this.blockInputIfPanelsVisible())if(this.isColorPicking)e.preventDefault();else if(e.preventDefault(),1===e.touches.length){const t=e.touches[0],i=this.getCanvasPosition(t.clientX,t.clientY);if(!i)return;this._touchStartTime=Date.now(),this._touchStartPos={x:t.clientX,y:t.clientY},this._touchStartCanvasPos={x:i.x,y:i.y},this._isPotentialTap=!0,this._touchTimer=setTimeout(()=>{!this.isPanning&&this._isPotentialTap&&(this.isDrawing=!0,this.startX=i.x,this.startY=i.y,this.lastX=i.x,this.lastY=i.y,this.currentTool&&this.currentTool.onDown&&this.currentTool.onDown(i.x,i.y)),this._touchTimer=null},50)}else if(2===e.touches.length){this.isPanning=!0,this.isDrawing=!1,this._touchTimer&&(clearTimeout(this._touchTimer),this._touchTimer=null);const t=e.touches[0],i=e.touches[1];this.touchStart1={x:t.clientX,y:t.clientY},this.touchStart2={x:i.clientX,y:i.clientY},this.touchDistance=Math.hypot(i.clientX-t.clientX,i.clientY-t.clientY),this.touchCenterX=(t.clientX+i.clientX)/2,this.touchCenterY=(t.clientY+i.clientY)/2,this.touchStartScale=this.scale,this.touchStartPosX=this.posX,this.touchStartPosY=this.posY;const s=this.getCanvasPosition(this.touchCenterX,this.touchCenterY);s&&(this.touchCenterCanvasX=s.x,this.touchCenterCanvasY=s.y)}else if(3===e.touches.length){e.preventDefault();const t=e.touches[0],i=e.touches[1],s=e.touches[2],a=(t.clientX+i.clientX+s.clientX)/3,o=(t.clientY+i.clientY+s.clientY)/3,n=(Math.hypot(t.clientX-a,t.clientY-o)+Math.hypot(i.clientX-a,i.clientY-o)+Math.hypot(s.clientX-a,s.clientY-o))/3;this.initialBrushSpread=n,this.initialBrushSize=this.brushSize,this.isBrushResizing=!0,this.brushResizingCenter={x:a,y:o},this.brushSizeIndicator.style.display="block",this.updateBrushSizeIndicator(),this._touchTimer&&(clearTimeout(this._touchTimer),this._touchTimer=null),this.isDrawing=!1}}handleTouchMove(e){if(e.preventDefault(),1===e.touches.length&&this.isDrawing){const t=e.touches[0];if(this._isPotentialTap){Math.hypot(t.clientX-this._touchStartPos.x,t.clientY-this._touchStartPos.y)>5&&(this._isPotentialTap=!1)}const i=this.getCanvasPosition(t.clientX,t.clientY);if(!i)return;this.currentTool&&this.currentTool.onMove&&(this.currentTool.onMove(i.x,i.y),this.lastX=i.x,this.lastY=i.y)}else if(2===e.touches.length&&this.isPanning){const t=e.touches[0],i=e.touches[1],s=Math.hypot(i.clientX-t.clientX,i.clientY-t.clientY),a=(t.clientX+i.clientX)/2,o=(t.clientY+i.clientY)/2;if(this.touchDistance>0&&Math.abs(s-this.touchDistance)>1){const e=s/this.touchDistance,t=this.touchStartScale*e;this.scale=Math.max(this.minScale,Math.min(t,this.maxScale));const i=this.canvasContainer.getBoundingClientRect(),n=this.touchCenterCanvasX,r=this.touchCenterCanvasY,l=a-((n-this.project.width/2)*this.scale+i.width/2+this.touchStartPosX),c=o-((r-this.project.height/2)*this.scale+i.height/2+this.touchStartPosY);this.posX=Math.round(this.touchStartPosX+l),this.posY=Math.round(this.touchStartPosY+c)}else{const e=a-this.touchCenterX,t=o-this.touchCenterY;this.posX=Math.round(this.touchStartPosX+e),this.posY=Math.round(this.touchStartPosY+t)}this.updateCanvasTransform()}else if(3===e.touches.length&&this.isBrushResizing){e.preventDefault();const t=e.touches[0],i=e.touches[1],s=e.touches[2],a=(t.clientX+i.clientX+s.clientX)/3,o=(t.clientY+i.clientY+s.clientY)/3,n=(Math.hypot(t.clientX-a,t.clientY-o)+Math.hypot(i.clientX-a,i.clientY-o)+Math.hypot(s.clientX-a,s.clientY-o))/3;if(Math.abs(n-this.initialBrushSpread)>.001){const e=n/this.initialBrushSpread;let t=Math.round(this.initialBrushSize*e);t=Math.max(this.minBrushSize,Math.min(t,this.maxBrushSize)),t!==this.brushSize&&(this.brushSize=t,this.updateBrushSizeIndicator(),localStorage.setItem("brushSize",this.brushSize))}}}handleTouchEnd(e){if(e.preventDefault(),this._touchTimer&&(clearTimeout(this._touchTimer),this._touchTimer=null),0===e.touches.length){if(this.isDrawing){this._isPotentialTap&&(Date.now(),this._touchStartTime);this.currentTool&&this.currentTool.onUp&&this.currentTool.onUp(this.lastX,this.lastY,this.startX,this.startY)}this.isPanning=!1,this.isDrawing=!1,this._isPotentialTap=!1,this.touchDistance=0,this.isBrushResizing&&setTimeout(()=>{this.brushSizeIndicator.style.display="none"},2e3)}else if(1===e.touches.length){this.touchDistance=0,this._isPotentialTap=!0;const t=e.touches[0];this._touchStartPos={x:t.clientX,y:t.clientY},this._touchStartTime=Date.now()}else 2===e.touches.length&&(this.isPanning=!1,this.isDrawing=!1)}handleTouchCancel(e){(this.isColorPicking||this.colorPickTimeout)&&this.cleanupColorPicking()}handleKeyDown(e){switch(e.key){case"z":(e.ctrlKey||e.metaKey)&&(this.undo(),e.preventDefault());break;case"y":(e.ctrlKey||e.metaKey)&&(this.redo(),e.preventDefault());break;case"b":this.setTool("Pencil");break;case"e":this.setTool("Eraser");break;case"l":this.setTool("Line");break;case"r":this.setTool("Rectangle")}}handleResize(){this.updateCanvasTransform(),this.adjustTimelinePosition(),this.updateReferenceControlsPosition()}adjustTimelinePosition(){if(!this.animationPanel)return;const e=this.bottomBar.offsetHeight;this.animationPanel.style.bottom=`${e}px`}getCanvasPosition(e,t){if(!this.project)return null;const i=this.canvasContainer.getBoundingClientRect(),s=e-i.left,a=t-i.top,o=s-i.width/2,n=a-i.height/2,r=o-this.posX,l=n-this.posY,c=Math.floor(r/this.scale+this.project.width/2),h=Math.floor(l/this.scale+this.project.height/2);return c<0||c>=this.project.width||h<0||h>=this.project.height?null:{x:c,y:h}}checkBounds(e,t){return e>=0&&e<this.project.width&&t>=0&&t<this.project.height}pan(e,t,i=1){let s=e-this.panStartX,a=t-this.panStartY;const o=this.canvasContainer.getBoundingClientRect();this.posX=this.panStartX+s-o.width/2,this.posY=this.panStartY+a-o.height/2,this.updateCanvasTransform()}zoom(e,t=this.touchStartPosY,i=this.touchStartPosY){const s=this.scale;if(this.scale*=e,this.scale=Math.max(this.minScale,Math.min(this.scale,this.maxScale)),void 0!==t&&void 0!==i){const e=this.canvasContainer.getBoundingClientRect(),a=t-e.left,o=i-e.top,n=a-this.canvasContainer.clientWidth/2,r=o-this.canvasContainer.clientHeight/2;this.posX=n-(n-this.posX)*(this.scale/s),this.posY=r-(r-this.posY)*(this.scale/s)}this.updateCanvasTransform()}resetZoom(){if(!this.project)return;const e=this.canvasContainer.clientWidth,t=this.canvasContainer.clientHeight,i=e/this.project.width,s=t/this.project.height;this.scale=Math.min(i,s),this.scale=Math.min(this.scale,10),this.posX=0,this.posY=0,this.updateCanvasTransform()}updateCanvasTransform(){if(!this.project)return;this.canvasContainer.clientWidth,this.canvasContainer.clientHeight;const e=this.project.width/2,t=this.project.height/2;this.canvasWrapper.style.transform=`\n      translate(${this.posX}px, ${this.posY}px)\n      translate(${-e*this.scale}px, ${-t*this.scale}px)\n      scale(${this.scale})\n    `;const i=this.canvasContainer.getBoundingClientRect(),s=i.width/2+this.posX-e*this.scale,a=i.height/2+this.posY-t*this.scale;Object.assign(this.gridOverlay.style,{position:"absolute",left:`${s}px`,top:`${a}px`,width:this.project.width*this.scale+"px",height:this.project.height*this.scale+"px",pointerEvents:"none"}),this.gridManager&&this.gridManager.updateTransform()}newProject(e=this.defaultWidth,t=this.defaultHeight,i=null){this.project=this.getNewProjectData(e,t,i),this.saveLastProjectSize(),this.historyManager.clear(),this.frameTimes=[this.currentFrameTime],this.animationPanel.classList.remove("visible"),this.layersPanel.classList.remove("visible"),this.updateFramesUI(),this.updateLayersUI(),this.resizeCanvas(),this.resetZoom(),this.render()}saveLastProjectSize(){localStorage.setItem("lastProjectWidth",this.project.width),localStorage.setItem("lastProjectHeight",this.project.height)}getNewProjectData(e,t,i){const s={width:e,height:t,frames:[{layers:[this.createBlankLayer(e,t,__("Capa Base||Default Layer"))]}],floatingColors:[],currentFrame:0,currentLayer:0};if(i){s.frames[0].layers[0].ctx.drawImage(i,0,0)}return s}resizeCanvas(){this.project&&(this.canvas.width=this.project.width,this.canvas.height=this.project.height)}render(){if(!this.project)return;const e=this.project.frames[this.project.currentFrame];if(e){this.ctx.clearRect(0,0,this.project.width,this.project.height),this.transparentBackground||(this.ctx.fillStyle=this.secondaryColor,this.ctx.fillRect(0,0,this.project.width,this.project.height)),this.referenceImage&&!this.renderReferenceImageOnTop&&(this.ctx.globalAlpha=this.referenceOpacity,this.ctx.drawImage(this.referenceImage,0,0,this.project.width,this.project.height),this.ctx.globalAlpha=1);for(let t=0;t<e.layers.length;t++){const i=e.layers[t];i.visible&&this.ctx.drawImage(i.canvas,0,0)}this.referenceImage&&this.renderReferenceImageOnTop&&(this.ctx.globalAlpha=this.referenceOpacity,this.ctx.drawImage(this.referenceImage,0,0,this.project.width,this.project.height),this.ctx.globalAlpha=1),this.updateFramesUI(),this.updateLayersUI(),this.updateAnimationPreview()}}getProjectSnapshot(){if(!this.project)return null;const e=JSON.parse(JSON.stringify(this.project));for(let t=0;t<e.frames.length;t++){const i=e.frames[t];for(let e=0;e<i.layers.length;e++){const s=i.layers[e];delete s.canvas;const a=this.project.frames[t].layers[e].ctx;s.imageData=a.getImageData(0,0,this.project.width,this.project.height)}}return e}restoreProjectSnapshot(e){if(e){this.project.currentFrame=e.currentFrame,this.project.currentLayer=e.currentLayer,this.project.width=e.width,this.project.height=e.height;for(let t=0;t<this.project.frames.length;t++){const i=this.project.frames[t];for(let s=0;s<i.layers.length;s++){const a=i.layers[s],o=e.frames[t].layers[s],n=o.canvas;a.canvas=n||document.createElement("canvas"),a.canvas.width=this.project.width,a.canvas.height=this.project.height,o.imageData&&a.ctx.putImageData(o.imageData,0,0)}}this.resizeCanvas(),this.render()}}saveToHistory(){this.historyManager.endBatch(),this.render()}recordDrawOperation(e){const t={type:"draw",description:"Draw pixels",frameIndex:this.project.currentFrame,layerIndex:this.project.currentLayer,pixels:e};this.historyManager.addChange(t)}undo(){const e=this.historyManager.undo();e&&(this.render(),this.showOperationMessage(e.message))}redo(){const e=this.historyManager.redo();e&&(this.render(),this.showOperationMessage(e.message))}async loadReferenceImage(){this.getFileBrowser({title:__("Cargar referencia||Load reference image"),mode:"open",fileTypes:["png","jpg","jpeg","gif","webp"],onConfirm:async e=>{try{const t=await this.readFile(e);await this.setReferenceImage(t),this.showNotification(__("Referencia cargada||Reference image loaded"))}catch(e){this.showNotification(`Error loading reference: ${e.message}`,5e3)}}}).show()}async setReferenceImage(e){return new Promise((t,i)=>{const s=new Image;s.onload=()=>{this.referenceImage=s,this.referenceControls.style.display="flex",this.updateReferenceControlsPosition(),this.render(),t()},s.onerror=i,s.src=e})}toggleReferenceTopBottom(){this.renderReferenceImageOnTop=!this.renderReferenceImageOnTop,this.render()}removeReferenceImage(){this.referenceImage=null,this.referenceControls.style.display="none",this.render()}updateReferenceControlsPosition(){if(!this.referenceControls)return;const e=this.bottomBar.offsetHeight;this.referenceControls.style.bottom=`${e+10}px`,this.referenceControls.style.left="10px"}drawPixel(e,t,i={}){if(!this.project||e<0||t<0||e>=this.project.width||t>=this.project.height)return;const s=i.color||("primary"===this.selectedColor?this.primaryColor:this.secondaryColor),a=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx;if(this.brushSize>1){let i=this.drawBrushCircle(a,e,t,this.brushSize,s);i&&i.length&&this.recordDrawOperation(i.filter(e=>e.newColor!=e.oldColor))}else{const i=this.getPixelColorFromCtx(a,e,t);s!=i&&("transparent"===s?a.clearRect(e,t,1,1):(a.fillStyle=s,a.fillRect(e,t,1,1)),this.recordDrawOperation([{x:e,y:t,oldColor:i,newColor:s}]))}this.render()}drawBrushCircle(e,t,i,s,a){return s<=0?[]:this.midpointEllipse(e,t,i,s/2,s/2,a,!0)}startLine(e,t,i){this.tempLine={startX:e,startY:t},this.getTempCanvas(),this.tempColor=i||("primary"===this.selectedColor?this.primaryColor:this.secondaryColor)}previewLine(e,t){if(!this.tempLine||!this.project)return;this.tempCtx.clearRect(0,0,this.project.width,this.project.height);this.drawBresenhamLine(this.tempLine.startX,this.tempLine.startY,e,t,this.tempCtx,this.tempColor,!0),this.ctx.clearRect(0,0,this.project.width,this.project.height),this.render(),this.ctx.drawImage(this.tempCanvas,0,0)}finishLine(e,t,i=!0){if(!this.tempLine||!this.project)return;const s=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx;let a=this.drawBresenhamLine(this.tempLine.startX,this.tempLine.startY,e,t,s,this.tempColor,!0);a=a.filter(e=>e.newColor!=e.oldColor),this.recordDrawOperation(a),this.tempLine=null,this.tempCanvas=null,this.tempCtx=null,this.render()}drawBresenhamLine(e,t,i,s,a,o,n){const r=Math.abs(i-e),l=-Math.abs(s-t),c=e<i?1:-1,h=t<s?1:-1;let d,p=r+l,m=[],u=[];for(;;){if("transparent"===o)if(n&&this.brushSize>1){const i=this.brushSize/2;u=[...u,...this.midpointEllipse(a,e,t,i,i,"transparent",!0)]}else{const i=this.getPixelColorFromCtx(a,e,t);a.clearRect(e,t,1,1),m.push({x:e,y:t,newColor:o,oldColor:i})}else if(n&&this.brushSize>1){const i=this.brushSize/2;u=[...u,...this.midpointEllipse(a,e,t,i,i,o,!0)]}else{const i=this.getPixelColorFromCtx(a,e,t);a.fillStyle=o,a.fillRect(e,t,1,1),m.push({x:e,y:t,newColor:o,oldColor:i})}if(e===i&&t===s)break;d=2*p,d>=l&&(p+=l,e+=c),d<=r&&(p+=r,t+=h)}return[...m,...u]}startRect(e,t){this.tempRect={startX:e,startY:t,currentX:e,currentY:t},this.getTempCanvas()}previewRect(e,t){if(!this.tempRect||!this.project)return;this.tempCtx.clearRect(0,0,this.project.width,this.project.height);let i=e-this.tempRect.startX,s=t-this.tempRect.startY;if(this.currentTool.settings?.perfect?.value){const e=Math.max(Math.abs(i),Math.abs(s));i=i<0?-e:e,s=s<0?-e:e}this.tempRect.currentX=this.tempRect.startX+i,this.tempRect.currentY=this.tempRect.startY+s;const a="primary"===this.selectedColor?this.primaryColor:this.secondaryColor;this.tempCtx.strokeStyle=a,this.tempCtx.lineWidth=1;const o=!0;this.currentTool.settings?.filled?.value?(this.tempCtx.fillStyle=a,this.tempCtx.fillRect(this.tempRect.startX,this.tempRect.startY,i+1,s+1)):(this.drawBresenhamLine(this.tempRect.startX,this.tempRect.startY,this.tempRect.startX+i,this.tempRect.startY,this.tempCtx,a,o),this.drawBresenhamLine(this.tempRect.startX+i,this.tempRect.startY,this.tempRect.startX+i,this.tempRect.startY+s,this.tempCtx,a,o),this.drawBresenhamLine(this.tempRect.startX+i,this.tempRect.startY+s,this.tempRect.startX,this.tempRect.startY+s,this.tempCtx,a,o),this.drawBresenhamLine(this.tempRect.startX,this.tempRect.startY+s,this.tempRect.startX,this.tempRect.startY,this.tempCtx,a,o)),this.ctx.clearRect(0,0,this.project.width,this.project.height),this.render(),this.ctx.drawImage(this.tempCanvas,0,0)}finishRect(e,t){if(!this.tempRect||!this.project)return;const i=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx;let s=this.tempRect.currentX-this.tempRect.startX,a=this.tempRect.currentY-this.tempRect.startY;if(this.currentTool.settings?.perfect?.value){const e=Math.max(Math.abs(s),Math.abs(a));s=s<0?-e:e,a=a<0?-e:e}const o=!0,n="primary"===this.selectedColor?this.primaryColor:this.secondaryColor;if(this.currentTool.settings?.filled?.value){let e=[];for(let t=this.tempRect.startY;t<=this.tempRect.startY+a;t++)for(let a=this.tempRect.startX;a<=this.tempRect.startX+s+1;a++)e.push({x:a,y:t,newColor:n,oldColor:this.getPixelColorFromCtx(i,a,t)});i.fillStyle=n,i.fillRect(this.tempRect.startX,this.tempRect.startY,s,a),this.recordDrawOperation(e.filter(e=>e.newColor!=e.oldColor))}else{let e=[...this.drawBresenhamLine(this.tempRect.startX,this.tempRect.startY,this.tempRect.startX+s,this.tempRect.startY,i,n,o),...this.drawBresenhamLine(this.tempRect.startX+s,this.tempRect.startY,this.tempRect.startX+s,this.tempRect.startY+a,i,n,o),...this.drawBresenhamLine(this.tempRect.startX+s,this.tempRect.startY+a,this.tempRect.startX,this.tempRect.startY+a,i,n,o),...this.drawBresenhamLine(this.tempRect.startX,this.tempRect.startY+a,this.tempRect.startX,this.tempRect.startY,i,n,o)].filter(e=>e.newColor!=e.oldColor);e.length&&this.recordDrawOperation(e)}this.tempRect=null,this.tempCanvas=null,this.tempCtx=null,this.render()}startEllipse(e,t){this.tempEllipse={startX:e,startY:t,currentX:e,currentY:t},this.getTempCanvas()}previewEllipse(e,t){if(!this.tempEllipse||!this.project)return;this.tempCtx.clearRect(0,0,this.project.width,this.project.height);let i=Math.floor(e-this.tempEllipse.startX),s=Math.floor(t-this.tempEllipse.startY);if(this.currentTool.settings?.perfect?.value){const e=Math.max(Math.abs(i),Math.abs(s));i=i<0?-e:e,s=s<0?-e:e}Math.abs(i)<1&&(i=i<0?-1:1),Math.abs(s)<1&&(s=s<0?-1:1),this.tempEllipse.currentX=this.tempEllipse.startX+i,this.tempEllipse.currentY=this.tempEllipse.startY+s;const a="primary"===this.selectedColor?this.primaryColor:this.secondaryColor,o=Math.floor(this.tempEllipse.startX),n=Math.floor(this.tempEllipse.startY);this.currentTool.settings?.filled?.value?this.drawFilledEllipse(this.tempCtx,o,n,i,s,a):this.drawEllipse(this.tempCtx,o,n,i,s,a),this.ctx.clearRect(0,0,this.project.width,this.project.height),this.render(),this.ctx.drawImage(this.tempCanvas,0,0)}finishEllipse(e,t){if(!this.tempEllipse||!this.project)return;const i=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx;let s=Math.floor(this.tempEllipse.currentX-this.tempEllipse.startX),a=Math.floor(this.tempEllipse.currentY-this.tempEllipse.startY);if(this.currentTool.settings?.perfect?.value){const e=Math.max(Math.abs(s),Math.abs(a));s=s<0?-e:e,a=a<0?-e:e}Math.abs(s)<1&&(s=s<0?-1:1),Math.abs(a)<1&&(a=a<0?-1:1);const o="primary"===this.selectedColor?this.primaryColor:this.secondaryColor,n=Math.floor(this.tempEllipse.startX),r=Math.floor(this.tempEllipse.startY);let l=[];l=this.currentTool.settings?.filled?.value?this.drawFilledEllipse(i,n,r,s,a,o):this.drawEllipse(i,n,r,s,a,o),l=l.filter(e=>e.newColor!=e.oldColor),l.length&&this.recordDrawOperation(l),this.tempEllipse=null,this.tempCanvas=null,this.tempCtx=null,this.render()}drawEllipse(e,t,i,s,a,o){const n=Math.floor(t+s/2),r=Math.floor(i+a/2),l=Math.floor(Math.abs(s/2)),c=Math.floor(Math.abs(a/2));return this.brushSize>1?this.midpointEllipseWithBrush(e,n,r,l,c,o,!1):this.midpointEllipse(e,n,r,l,c,o,!1)}drawFilledEllipse(e,t,i,s,a,o){const n=Math.floor(t+s/2),r=Math.floor(i+a/2),l=Math.floor(Math.abs(s/2)),c=Math.floor(Math.abs(a/2));return this.midpointEllipse(e,n,r,l,c,o,!0)}midpointEllipse(e,t,i,s,a,o,n){if(s<=0||a<=0)return[];const r=Math.floor(t),l=Math.floor(i),c=Math.floor(Math.abs(s)),h=Math.floor(Math.abs(a));if(0===c||0===h)return[];let d=[];const p=(t,i)=>{const s=Math.floor(t),a=Math.floor(i);if(s<0||s>=e.width||a<0||a>=e.height)return;const n=this.getPixelColorFromCtx(e,s,a);n!==o&&("transparent"===o?e.clearRect(s,a,1,1):(e.fillStyle=o,e.fillRect(s,a,1,1)),d.push({x:t,y:i,newColor:o,oldColor:n}))};if(n)return this.fillEllipseScanline(e,r,l,c,h,o);let m=0,u=h,g=h*h-c*c*h+Math.floor(.25*c*c),v=2*h*h*m,y=2*c*c*u;for(;v<y;)p(r+m,l+u),p(r-m,l+u),p(r+m,l-u),p(r-m,l-u),m++,v+=2*h*h,g<0?g+=v+h*h:(u--,y-=2*c*c,g+=v-y+h*h);let f=h*h*((m+.5)*(m+.5))+c*c*((u-1)*(u-1))-c*c*h*h;for(;u>=0;)p(r+m,l+u),p(r-m,l+u),p(r+m,l-u),p(r-m,l-u),u--,y-=2*c*c,f>0?f+=c*c-y:(m++,v+=2*h*h,f+=v-y+c*c);return d}midpointEllipseWithBrush(e,t,i,s,a,o,n){if(s<=0||a<=0)return[];const r=Math.floor(t),l=Math.floor(i),c=Math.floor(Math.abs(s)),h=Math.floor(Math.abs(a));if(0===c||0===h)return[];let d=[];const p=(t,i)=>{if(this.brushSize>1)d=[...d,...this.drawBrushCircle(e,t,i,this.brushSize,o)];else{const s=this.getPixelColorFromCtx(e,t,i);s!==o&&("transparent"===o?e.clearRect(t,i,1,1):(e.fillStyle=o,e.fillRect(t,i,1,1)),d.push({x:t,y:i,newColor:o,oldColor:s}))}};if(n)return this.fillEllipseScanline(e,r,l,c,h,o);let m=0,u=h,g=h*h-c*c*h+Math.floor(.25*c*c),v=2*h*h*m,y=2*c*c*u;for(;v<y;)p(r+m,l+u),p(r-m,l+u),p(r+m,l-u),p(r-m,l-u),m++,v+=2*h*h,g<0?g+=v+h*h:(u--,y-=2*c*c,g+=v-y+h*h);let f=h*h*((m+.5)*(m+.5))+c*c*((u-1)*(u-1))-c*c*h*h;for(;u>=0;)p(r+m,l+u),p(r-m,l+u),p(r+m,l-u),p(r-m,l-u),u--,y-=2*c*c,f>0?f+=c*c-y:(m++,v+=2*h*h,f+=v-y+c*c);return d}fillEllipseScanline(e,t,i,s,a,o){if(s<=0||a<=0)return[];let n=[];const r=(t,i)=>{if(t<0||t>=e.width||i<0||i>=e.height)return;const s=this.getPixelColorFromCtx(e,t,i);s!==o&&("transparent"===o?e.clearRect(t,i,1,1):(e.fillStyle=o,e.fillRect(t,i,1,1)),n.push({x:t,y:i,newColor:o,oldColor:s}))},l=s*s,c=a*a,h=2*l,d=2*c;let p=0,m=a,u=0,g=h*m,v=Math.floor(c-l*a+.25*l);for(;u<g;){for(let e=t-p;e<=t+p;e++)r(e,i+m),r(e,i-m);p++,u+=d,v<0?v+=c+u:(m--,g-=h,v+=c+u-g)}let y=Math.floor(c*(p+.5)*(p+.5)+l*(m-1)*(m-1)-l*c);for(;m>=0;){for(let e=t-p;e<=t+p;e++)r(e,i+m),r(e,i-m);m--,g-=h,y>0?y+=l-g:(p++,u+=d,y+=l-g+u)}return n}fillArea(e,t){if(!this.project||e<0||t<0||e>=this.project.width||t>=this.project.height)return;const i=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx,s=i.getImageData(e,t,1,1),a=Array.from(s.data),o="primary"===this.selectedColor?this.primaryColor:this.secondaryColor,n=this.hexToRgb(o);if(n&&n.r===a[0]&&n.g===a[1]&&n.b===a[2]&&255===a[3])return;let r=this.floodFill(i,e,t,a,n);r=r.filter(e=>e.newColor!=e.oldColor),r.length&&this.recordDrawOperation(r),this.render()}floodFill(e,t,i,s,a){const o=this.project.width,n=this.project.height,r=[[t,i]],l=new Set;let c=[];for(;r.length>0;){const[t,i]=r.pop(),h=`${t},${i}`;if(l.has(h)||t<0||t>=o||i<0||i>=n)continue;l.add(h);const d=e.getImageData(t,i,1,1),p=Array.from(d.data);if(this.colorsMatch(p,s)){const s=this.getPixelColorFromCtx(e,t,i);if(a){const o=new Uint8ClampedArray([a.r,a.g,a.b,255]);e.putImageData(new ImageData(o,1,1),t,i),c.push({x:t,y:i,newColor:`rgba(${a.r}, ${a.g}, ${a.b}, 255)`,oldColor:s})}else e.clearRect(t,i,1,1),c.push({x:t,y:i,newColor:"transparent",oldColor:s});r.push([t+1,i],[t-1,i],[t,i+1],[t,i-1])}}return c}colorsMatch(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}pickColor(e,t,i=!0){if(!this.project||e<0||t<0||e>=this.project.width||t>=this.project.height)return;const s=this.project.frames[this.project.currentFrame],a=i=>{const s=i.getImageData(e,t,1,1).data;if(s[3]>0){const e=`#${this.componentToHex(s[0])}${this.componentToHex(s[1])}${this.componentToHex(s[2])}`;return this.setColor(e),!0}return!1};for(let e=s.layers.length-1;e>=0;e--){const t=s.layers[e];if(t.visible){if(a(t.ctx))return}}i&&this.referenceImage&&a(this.ctx)}addTool(e){if(!e.name)throw new Error("Tool must have a name");this.tools[e.name]={name:e.name,displayName:e.displayName||e.name,icon:e.icon,cursor:e.cursor||"default",onDown:e.onDown,onMove:e.onMove,onUp:e.onUp,settings:e.settings||{}};const t=this.createButton(`tool-${e.name}`,e.icon,()=>{this.setTool(e.name),this.toolDropdown.classList.remove("visible")});t.title=e.displayName,this.toolDropdown.appendChild(t)}setTool(e){if(!this.tools[e])throw new Error(`Tool '${e}' not found`);this.currentTool&&this.currentTool.name!==e&&(this.lastTool=this.currentTool.name),this.currentTool=this.tools[e];const t=this.currentToolButton.querySelector(".icon");t&&(t.className=`icon ${this.currentTool.icon}`),this.canvas.style.cursor=this.currentTool.cursor,this.toolSettingsButton.style.display=Object.keys(this.currentTool.settings).length>0?"flex":"none",this.hideToolSettings()}switchLastTool(){this.lastTool&&this.lastTool!==this.currentTool.name&&this.setTool(this.lastTool)}toggleToolDropdown(){if(this.toolDropdown.classList.toggle("visible"),this.toolDropdown.classList.contains("visible")){const e=t=>{this.toolButtonContainer.contains(t.target)||(this.toolDropdown.classList.remove("visible"),document.removeEventListener("click",e))};setTimeout(()=>{document.addEventListener("click",e)},0)}}showToolSettings(){if(!this.currentTool||0===Object.keys(this.currentTool.settings).length)return;this.toolSettingsPopup.innerHTML="";const e=document.createElement("h3");e.textContent=`${this.currentTool.name} Settings`,this.toolSettingsPopup.appendChild(e);for(const[e,t]of Object.entries(this.currentTool.settings)){const i=document.createElement("div");i.className="tool-setting";const s=document.createElement("label");if(s.textContent=e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()),i.appendChild(s),"boolean"===t.type){const s=document.createElement("input");s.type="checkbox",s.checked=t.value,s.addEventListener("change",t=>{this.currentTool.settings[e].value=t.target.checked}),i.appendChild(s)}else if("number"===t.type){const s=document.createElement("input");s.type="number",s.value=t.value,s.min=t.min||0,s.max=t.max||100,s.addEventListener("change",t=>{this.currentTool.settings[e].value=parseFloat(t.target.value)}),i.appendChild(s)}else if("select"===t.type){const s=document.createElement("select");t.options.forEach(e=>{const i=document.createElement("option");i.value=e.value,i.textContent=e.label,e.value===t.value&&(i.selected=!0),s.appendChild(i)}),s.addEventListener("change",t=>{this.currentTool.settings[e].value=t.target.value}),i.appendChild(s)}this.toolSettingsPopup.appendChild(i)}const t=this.toolSettingsButton.getBoundingClientRect();this.toolSettingsPopup.style.position="absolute",this.toolSettingsPopup.style.bottom=window.innerHeight-t.top+10+"px",this.toolSettingsPopup.style.right=window.innerWidth-t.right+"px",this.toolSettingsPopup.style.display="block",setTimeout(()=>{const e=t=>{this.toolSettingsPopup.contains(t.target)||(this.hideToolSettings(),document.removeEventListener("click",e))};document.addEventListener("click",e)},0)}hideToolSettings(){this.toolSettingsPopup.style.display="none"}toggleSelectedColor(){this.selectedColor="primary"===this.selectedColor?"secondary":"primary",this.updateColorIndicator()}updateColorIndicator(){this.colorPrimary.style.backgroundColor=this.primaryColor,this.colorSecondary.style.backgroundColor=this.secondaryColor,this.colorSelector.className="color-selector","secondary"===this.selectedColor&&this.colorSelector.classList.add("secondary"),localStorage.setItem("primaryColor",this.primaryColor),localStorage.setItem("secondaryColor",this.secondaryColor)}showNotification(e,t=3e3){this.notificationElement.innerHTML=e,this.notificationElement.classList.add("visible"),setTimeout(()=>{this.notificationElement.classList.remove("visible")},t)}showOperationMessage(e,t=3e3){this.operationMessageElement.textContent=e,this.operationMessageElement.classList.add("visible"),setTimeout(()=>{this.operationMessageElement.classList.remove("visible")},t)}showPopup(e,t,i=[{text:"OK",action:()=>this.hidePopup()}]){this.popupContent.innerHTML="";const s=document.createElement("div");if(s.className="popup-title",s.textContent=e,this.popupContent.appendChild(s),"string"==typeof t){const e=document.createElement("div");e.innerHTML=t,this.popupContent.appendChild(e)}else this.popupContent.appendChild(t);const a=document.createElement("div");a.className="popup-buttons",this.popupContent.appendChild(a),this.popupButtons=[],i.forEach(e=>{const t=document.createElement("button");t.className=e.class||"confirm",t.textContent=e.text,t.addEventListener("click",e.action),a.appendChild(t),this.popupButtons.push(t)}),this.popupOverlay.classList.add("visible"),this.popupOpen=!0}hidePopup(){this.popupOverlay.classList.remove("visible"),this.popupOpen=!1}hidePopupButtons(){this.popupButtons&&this.popupButtons.forEach(e=>{e.style.display="none"})}showNewProjectDialog(){const e=document.createElement("div");e.innerHTML=`\n      <div style="margin-bottom: 15px;">\n        <label style="display: block; margin-bottom: 5px;">Width:</label>\n        <input type="number" id="new-width" value="${this.defaultWidth}">\n      </div>\n      <div style="margin-bottom: 15px;">\n        <label style="display: block; margin-bottom: 5px;">Height:</label>\n        <input type="number" id="new-height" value="${this.defaultHeight}">\n      </div>\n    `,this.showPopup(__("Nuevo Proyecto||New Project"),e,[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.hidePopup()},{text:__("Crear||Create"),action:()=>{const e=parseInt(document.getElementById("new-width").value),t=parseInt(document.getElementById("new-height").value);e>0&&t>0?(this.newProject(e,t),this.hidePopup()):this.showNotification(__("Dimensiones inválidas||Invalid dimensions"))}}])}showHexColorInputDialog(){const e=document.createElement("div"),t=document.createElement("input");t.type="text",t.value=this.colorPickerPreviewColor,t.placeholder=this.colorPickerPreviewColor,t.addEventListener("keyup",e=>{const s=t.value.trim().split("");"#0123456789abcdefABCDEF".includes(s.pop())?(this.isValidHex(t.value)&&(t.value.startsWith("#")||(t.value="#"+t.value)),i.value=t.value):(s.pop(),t.value=s.join(""),i.value=t.value)}),e.appendChild(t);const i=document.createElement("input");return i.type="color",i.value=this.colorPickerPreviewColor,i.addEventListener("change",()=>{t.value=i.value}),i.style.marginTop="0.3rem",e.appendChild(i),new Promise((i,s)=>{this.showPopup(__("Entrada Hexadecimal||Hex Input"),e,[{text:__("Cancelar"),class:"cancel",action:()=>{this.hidePopup(),s()}},{text:__("Selecionar||Select"),action:()=>{this.isValidHex(t.value)?(this.hidePopup(),i(t.value)):(this.showNotification(__("Expresión hexadecimal inválida||Invalid HEX color expression")),s())}}])})}flipHorizontal(){if(!this.project)return;this.historyManager.startBatch("transform","Flip Horizontal");const e=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx,t=e.getImageData(0,0,this.project.width,this.project.height),i=t,s=i.data;for(let e=0;e<this.project.height;e++)for(let t=0;t<Math.floor(this.project.width/2);t++){const i=4*(e*this.project.width+t),a=4*(e*this.project.width+(this.project.width-t-1));for(let e=0;e<4;e++){const t=s[i+e];s[i+e]=s[a+e],s[a+e]=t}}e.putImageData(i,0,0);const a={type:"transform",description:"Flip Horizontal",frameIndex:this.project.currentFrame,layerIndex:this.project.currentLayer,transformType:"flip_horizontal",transformData:{oldImageData:Array.from(t.data),newImageData:Array.from(e.getImageData(0,0,this.project.width,this.project.height).data)}};this.historyManager.addChange(a),this.historyManager.endBatch(),this.render()}flipVertical(){if(!this.project)return;this.historyManager.startBatch("transform","Flip Vertical");const e=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx,t=e.getImageData(0,0,this.project.width,this.project.height),i=t,s=i.data;for(let e=0;e<Math.floor(this.project.height/2);e++)for(let t=0;t<this.project.width;t++){const i=4*(e*this.project.width+t),a=4*((this.project.height-e-1)*this.project.width+t);for(let e=0;e<4;e++){const t=s[i+e];s[i+e]=s[a+e],s[a+e]=t}}e.putImageData(i,0,0);const a={type:"transform",description:"Flip Vertical",frameIndex:this.project.currentFrame,layerIndex:this.project.currentLayer,transformType:"flip_vertical",transformData:{oldImageData:Array.from(t.data),newImageData:Array.from(e.getImageData(0,0,this.project.width,this.project.height).data)}};this.historyManager.addChange(a),this.historyManager.endBatch(),this.render()}rotate(e){if(!this.project)return;this.historyManager.startBatch("transform",`Rotate ${e}°`);const t=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer],i=t.ctx,s=i.getImageData(0,0,this.project.width,this.project.height),a=s,o=new ImageData(90===e||270===e?this.project.height:this.project.width,90===e||270===e?this.project.width:this.project.height);for(let t=0;t<this.project.height;t++)for(let i=0;i<this.project.width;i++){const s=4*(t*this.project.width+i);let n,r;if(90===e)n=this.project.height-t-1,r=i;else if(180===e)n=this.project.width-i-1,r=this.project.height-t-1;else{if(270!==e)return;n=t,r=this.project.width-i-1}const l=4*(r*o.width+n);for(let e=0;e<4;e++)o.data[l+e]=a.data[s+e]}90!==e&&270!==e||(t.canvas.width=this.project.height,t.canvas.height=this.project.width),i.putImageData(o,0,0);const n={type:"transform",description:`Rotate ${e}°`,frameIndex:this.project.currentFrame,layerIndex:this.project.currentLayer,transformType:`rotate_${e}`,transformData:{oldImageData:Array.from(s.data),newImageData:Array.from(i.getImageData(0,0,t.canvas.width,t.canvas.height).data),oldWidth:this.project.width,oldHeight:this.project.height,newWidth:t.canvas.width,newHeight:t.canvas.height}};if(this.historyManager.addChange(n),this.historyManager.endBatch(),90===e||270===e){const e=this.project.width;this.project.width=this.project.height,this.project.height=e,this.resizeCanvas()}this.render()}toggleTransparency(){this.transparentBackground=!this.transparentBackground,this.render()}invertColors(){if(!this.project)return;this.historyManager.startBatch("color_adjustment","Invert Colors");const e=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx,t=e.getImageData(0,0,this.project.width,this.project.height),i=e.getImageData(0,0,this.project.width,this.project.height),s=i.data;for(let e=0;e<s.length;e+=4)s[e]=255-s[e],s[e+1]=255-s[e+1],s[e+2]=255-s[e+2];e.putImageData(i,0,0);const a={type:"color_adjustment",description:"Invert Colors",frameIndex:this.project.currentFrame,layerIndex:this.project.currentLayer,adjustmentType:"invert",adjustmentData:{oldImageData:Array.from(t.data),newImageData:Array.from(e.getImageData(0,0,this.project.width,this.project.height).data)}};this.historyManager.addChange(a),this.historyManager.endBatch(),this.render()}grayscale(){if(!this.project)return;this.historyManager.startBatch("color_adjustment","Grayscale");const e=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx,t=e.getImageData(0,0,this.project.width,this.project.height),i=t,s=i.data;for(let e=0;e<s.length;e+=4){const t=(s[e]+s[e+1]+s[e+2])/3;s[e]=t,s[e+1]=t,s[e+2]=t}e.putImageData(i,0,0);const a={type:"color_adjustment",description:"Grayscale",frameIndex:this.project.currentFrame,layerIndex:this.project.currentLayer,adjustmentType:"grayscale",adjustmentData:{oldImageData:Array.from(t.data),newImageData:Array.from(e.getImageData(0,0,this.project.width,this.project.height).data)}};this.historyManager.addChange(a),this.historyManager.endBatch(),this.render()}adjustBrightness(e){if(!this.project)return;this.historyManager.startBatch("color_adjustment","Adjust Brightness");const t=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx,i=t.getImageData(0,0,this.project.width,this.project.height),s=i,a=s.data,o=1+e/100;for(let e=0;e<a.length;e+=4)a[e]=Math.min(255,Math.max(0,a[e]*o)),a[e+1]=Math.min(255,Math.max(0,a[e+1]*o)),a[e+2]=Math.min(255,Math.max(0,a[e+2]*o));t.putImageData(s,0,0);const n={type:"color_adjustment",description:"Adjust Brightness",frameIndex:this.project.currentFrame,layerIndex:this.project.currentLayer,adjustmentType:"brightness",adjustmentData:{value:e,oldImageData:Array.from(i.data),newImageData:Array.from(t.getImageData(0,0,this.project.width,this.project.height).data)}};this.historyManager.addChange(n),this.historyManager.endBatch(),this.render()}showBrightnessDialog(){const e=document.createElement("div");e.innerHTML='\n            <div style="margin-bottom: 15px;">\n                <label style="display: block; margin-bottom: 5px;">Brightness (-100 to 100):</label>\n                <input type="range" id="brightness-value" min="-100" max="100" value="0" style="width: 100%;">\n            </div>\n        ',this.showPopup(__("Ajuste de Brillo||Adjust Brightness"),e,[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.hidePopup()},{text:__("Aplicar||Apply"),action:()=>{const e=parseInt(document.getElementById("brightness-value").value);this.adjustBrightness(e),this.hidePopup()}}])}showAboutDialog(){this.showPopup(__("Acerca de Pixelite||About Pixelite"),`\n        <p>Pixelite ${this.version}</p>\n        <p>${__("Un editor de pixel art con soporte de animación||A simple pixel art editor with animation support")}.</p>\n        <p>${__("Creado por||Created by")} <a onclick="openExternalUrl('https://retora.html-5.me')">retora</a>.</p>\n      `)}showManualDialog(){this.showPopup("Manual",__("\n        (El manual no está disponible todavía|Manual is not available yet)\n      "),[{text:__("Cerrar||Close"),action:()=>this.hidePopup()}])}addFrame(){if(!this.project)return;this.historyManager.startBatch("add_frame","Add Frame");const e={layers:[]},t=this.project.frames[this.project.currentFrame];for(let i=0;i<t.layers.length;i++){const s=t.layers[i],a=this.createBlankLayer(this.project.width,this.project.height,s.name);a.visible=s.visible,e.layers.push(a)}const i=this.project.frames.length;this.project.frames.push(e),this.frameTimes.push(this.currentFrameTime),this.project.currentFrame=i;const s={type:"add_frame",description:"Add Frame",index:i,frameTime:this.currentFrameTime,layers:t.layers.map(e=>({name:e.name,visible:e.visible,imageData:Array.from(e.ctx.getImageData(0,0,this.project.width,this.project.height).data)}))};this.historyManager.addChange(s),this.historyManager.endBatch(),this.render()}removeFrame(){if(!this.project||this.project.frames.length<=1)return;this.historyManager.startBatch("remove_frame","Remove Frame");const e=this.project.currentFrame,t=this.project.frames[e],i=this.frameTimes[e];this.project.frames.splice(e,1),this.frameTimes.splice(e,1),this.project.currentFrame=Math.min(e,this.project.frames.length-1);const s={type:"remove_frame",description:"Remove Frame",index:e,frameTime:i,layers:t.layers.map(e=>({name:e.name,visible:e.visible,imageData:Array.from(e.ctx.getImageData(0,0,this.project.width,this.project.height).data)}))};this.historyManager.addChange(s),this.historyManager.endBatch(),this.render()}moveFrame(e,t){if(e===t)return;this.historyManager.startBatch("move_frame","Move Frame");const i=this.project.frames.splice(e,1)[0],s=this.frameTimes.splice(e,1)[0];this.project.frames.splice(t,0,i),this.frameTimes.splice(t,0,s),this.project.currentFrame=t;const a={type:"move_frame",description:"Move Frame",fromIndex:e,toIndex:t};this.historyManager.addChange(a),this.historyManager.endBatch(),this.render()}setFrameTime(e,t){if(!this.project||e<0||e>=this.frameTimes.length)return;const i=this.frameTimes[e];this.frameTimes[e]=t;const s={type:"edit_frame",description:"Change Frame Time",frameIndex:e,property:"time",oldValue:i,newValue:t};this.historyManager.addChange(s)}addLayer(){if(!this.project)return;this.historyManager.startBatch("add_layer","Add Layer");const e=this.project.frames[this.project.currentFrame],t=this.createBlankLayer(this.project.width,this.project.height,`Layer ${e.layers.length+1}`),i=e.layers.length;e.layers.push(t),this.project.currentLayer=i;const s={type:"add_layer",description:"Add Layer",frameIndex:this.project.currentFrame,layerIndex:i,layerData:{name:t.name,visible:t.visible,imageData:Array.from(t.ctx.getImageData(0,0,this.project.width,this.project.height).data)}};this.historyManager.addChange(s),this.historyManager.endBatch(),this.updateLayersUI(),this.render()}removeLayer(){if(!this.project)return;const e=this.project.frames[this.project.currentFrame];if(e.layers.length<=1)return;this.historyManager.startBatch("remove_layer","Remove Layer");const t=this.project.currentLayer,i=e.layers[t];e.layers.splice(t,1),this.project.currentLayer=Math.min(t,e.layers.length-1);const s={type:"remove_layer",description:"Remove Layer",frameIndex:this.project.currentFrame,layerIndex:t,layerData:{name:i.name,visible:i.visible,imageData:Array.from(i.ctx.getImageData(0,0,this.project.width,this.project.height).data)}};this.historyManager.addChange(s),this.historyManager.endBatch(),this.updateLayersUI(),this.render()}setLayerVisibility(e,t,i){if(!this.project||!this.project.frames[e]||!this.project.frames[e].layers[t])return;const s=this.project.frames[e].layers[t],a=s.visible;s.visible=i;const o={type:"change_layer_visibility",description:"Change Layer Visibility",frameIndex:e,layerIndex:t,visible:i,oldVisible:a};this.historyManager.addChange(o),this.render()}moveLayer(e,t,i){if(t===i)return;this.historyManager.startBatch("move_layer","Move Layer");const s=this.project.frames[e],a=s.layers.splice(t,1)[0];s.layers.splice(i,0,a),this.project.currentLayer=i;const o={type:"move_layer",description:"Move Layer",frameIndex:e,fromIndex:t,toIndex:i};this.historyManager.addChange(o),this.historyManager.endBatch(),this.updateLayersUI(),this.render()}createBlankLayer(e,t,i=`Layer ${this.project&&this.project.frames.length?this.project.frames[0].layers.length+1:1}`){const s=document.createElement("canvas");s.width=e,s.height=t;return{canvas:s,ctx:this.getCanvasContext(s),visible:!0,name:i}}updateFramesUI(){if(!this.project)return;this.timelineContent.innerHTML="",this.frameTimes.length!==this.project.frames.length&&(this.frameTimes=new Array(this.project.frames.length).fill(this.currentFrameTime));for(let e=0;e<this.project.frames.length;e++){const t=this.project.frames[e],i=document.createElement("div");i.className="timeline-frame "+(e===this.project.currentFrame?"active":""),i.setAttribute("data-index",e),i.draggable=!0;const s=document.createElement("div");s.className="frame-thumb",i.appendChild(s);const a=document.createElement("canvas");a.width=this.project.width,a.height=this.project.height,a.style.width="auto",a.style.height="60px";const o=this.getCanvasContext(a);for(let e=0;e<t.layers.length;e++)t.layers[e].visible&&o.drawImage(t.layers[e].canvas,0,0,this.project.width,this.project.height,0,0,this.project.width,this.project.height);s.appendChild(a);const n=document.createElement("div");n.className="frame-time",n.textContent=`${this.frameTimes[e].toFixed(2)}ms`,i.appendChild(n);const r=document.createElement("div");r.className="frame-number",r.textContent=e+1,i.appendChild(r),i.addEventListener("dragstart",t=>{t.dataTransfer.setData("text/plain",e.toString()),i.classList.add("dragging")}),i.addEventListener("dragend",()=>{i.classList.remove("dragging")}),i.addEventListener("dragover",e=>{e.preventDefault()}),i.addEventListener("drop",t=>{t.preventDefault();const i=parseInt(t.dataTransfer.getData("text/plain")),s=e;i!==s&&this.moveFrame(i,s)}),n.addEventListener("click",t=>{this.showFrameTimeDialog(e),t.stopPropagation()}),i.addEventListener("click",t=>{this.project.currentFrame=e,this.render(),t.stopPropagation()}),this.setupTimelineSwipe(i,e),this.timelineContent.appendChild(i)}const e=document.createElement("div");e.className="timeline-frame add-button",e.innerHTML=`\n    <div class="add-button-icon">\n      <svg width="24" height="24" viewBox="0 0 24 24">\n        <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>\n      </svg>\n    </div>\n    <span>${__("Añadir||Add")}</span>\n  `,e.addEventListener("click",()=>this.addFrame()),this.timelineContent.appendChild(e),this.updateAnimationPreview()}updateLayersUI(){if(!this.project)return;this.layersContainer.innerHTML="";const e=document.createElement("div");e.className="layer-item add-button",e.innerHTML=`\n      <div class="add-button-icon">\n        <svg width="24" height="24" viewBox="0 0 24 24">\n          <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>\n        </svg>\n      </div>\n      <span>${__("Añadir Capa||Add Layer")}</span>\n    `,e.addEventListener("click",()=>this.addLayer()),this.layersContainer.appendChild(e);const t=this.project.frames[this.project.currentFrame];for(let e=t.layers.length-1;e>=0;e--){const i=t.layers[e],s=document.createElement("div");s.className="layer-item "+(e===this.project.currentLayer?"active":""),s.setAttribute("data-index",e),s.draggable=!0;const a=document.createElement("div");a.className="layer-thumb-container",s.appendChild(a);const o=document.createElement("canvas");o.width=this.project.width,o.height=this.project.height,o.style.width="40px",o.style.height="auto";const n=this.getCanvasContext(o);if(i.canvas&&n.drawImage(i.canvas,0,0,this.project.width,this.project.height,0,0,o.width,o.height),this.hasTransparency(i.canvas)){n.fillStyle="rgba(0, 0, 0, 0.1)";for(let e=0;e<4;e++)for(let t=0;t<4;t++)(t+e)%2==0&&n.fillRect(10*t,10*e,10,10)}a.appendChild(o);const r=document.createElement("div");r.className="layer-info",r.innerHTML=`<span>${i.name}</span>`,s.appendChild(r);const l=document.createElement("div");l.className="layer-actions";const c=document.createElement("button");if(c.className="layer-action visibility",c.innerHTML=i.visible?'<svg width="12" height="12" viewBox="0 0 24 24"><path fill="currentColor" d="M12 9a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5a5 5 0 0 1 5-5a5 5 0 0 1 5 5a5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5z"/></svg>':'<svg width="12" height="12" viewBox="0 0 24 24"><path fill="currentColor" d="M11.83 9L15 12.16V12a3 3 0 0 0-3-3h-.17m-4.3.8l1.55 1.55c-.05.21-.08.42-.08.65a3 3 0 0 0 3 3c.22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53a5 5 0 0 1-5-5c0-.79.2-1.53.53-2.2M2 4.27l2.28 2.28l.45.45C3.08 8.3 1.78 10 1 12c1.73 4.39 6 7.5 11 7.5c1.55 0 3.03-.3 4.38-.84l.43.42L19.73 22 21 20.73 3.27 3 2 4.27z"/></svg>',c.title="Toggle Visibility",c.addEventListener("click",t=>{t.stopPropagation(),this.setLayerVisibility(this.project.currentFrame,e,!i.visible)}),l.appendChild(c),e<t.layers.length-1){const t=document.createElement("button");t.className="layer-action move-up",t.innerHTML='<svg width="12" height="12" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6l1.41 1.41z"/></svg>',t.title="Move Down in Stack",t.addEventListener("click",t=>{t.stopPropagation(),this.moveLayer(this.project.currentFrame,e,e+1)}),l.appendChild(t)}if(e>0){const t=document.createElement("button");t.className="layer-action move-down",t.innerHTML='<svg width="12" height="12" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 8.58L12 13.17l4.59-4.59L18 10l-6 6l-6-6l1.41-1.42z"/></svg>',t.title="Move Up in Stack",t.addEventListener("click",t=>{t.stopPropagation(),this.moveLayer(this.project.currentFrame,e,e-1)}),l.appendChild(t)}const h=document.createElement("button");h.className="layer-action remove",h.innerHTML='<svg width="12" height="12" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41z"/></svg>',h.title="Remove Layer",h.addEventListener("click",t=>{t.stopPropagation(),this.removeLayerWithUndo(e)}),l.appendChild(h),s.appendChild(l),s.addEventListener("dragstart",t=>{t.dataTransfer.setData("text/plain",e.toString()),s.classList.add("dragging")}),s.addEventListener("dragend",()=>{s.classList.remove("dragging")}),s.addEventListener("dragover",e=>{e.preventDefault()}),s.addEventListener("drop",t=>{t.preventDefault();const i=parseInt(t.dataTransfer.getData("text/plain")),s=e;i!==s&&this.moveLayer(this.project.currentFrame,i,s)}),s.addEventListener("click",()=>{this.project.currentLayer=e,this.updateLayersUI()}),this.setupSwipeToDelete(s,e,"layer"),this.layersContainer.appendChild(s)}}removeFrameWithUndo(e){if(this.project.frames.length<=1)return;const t=this.project.frames[e],i=this.frameTimes[e];this.project.frames.splice(e,1),this.frameTimes.splice(e,1),this.project.currentFrame=Math.min(e,this.project.frames.length-1),this.render(),this.showUndoToast(__("Frame Borrado||Frame Deleted"),()=>{this.project.frames.splice(e,0,t),this.frameTimes.splice(e,0,i),this.project.currentFrame=e,this.render()})}removeLayerWithUndo(e){const t=this.project.frames[this.project.currentFrame];if(t.layers.length<=1)return;const i=t.layers[e];t.layers.splice(e,1),this.project.currentLayer=Math.min(e,t.layers.length-1),this.updateLayersUI(),this.render(),this.showUndoToast(__("Capa Borrada||Layer Deleted"),()=>{t.layers.splice(e,0,i),this.project.currentLayer=e,this.updateLayersUI(),this.render()})}setupSwipeToDelete(e,t,i){let s,a,o=!1;e.addEventListener("touchstart",e=>{s=e.touches[0].clientX,a=e.touches[0].clientY,o=!0}),e.addEventListener("touchmove",t=>{if(!o)return;const i=t.touches[0].clientX,n=t.touches[0].clientY,r=i-s,l=n-a;Math.abs(r)>30&&Math.abs(l)<20&&(t.preventDefault(),e.style.transform=`translateX(${r}px)`,e.style.opacity=""+(1-Math.abs(r)/100))}),e.addEventListener("touchend",a=>{if(!o)return;const n=a.changedTouches[0].clientX-s;Math.abs(n)>60&&("frame"===i?this.removeFrameWithUndo(t):this.removeLayerWithUndo(t)),e.style.transform="",e.style.opacity="",o=!1})}showUndoToast(e,t){const i=document.createElement("div");i.className="undo-toast",i.innerHTML=`\n    <span>${e}</span>\n    <button class="undo-button">${__("Deshacer||Undo")}</button>\n  `,document.body.appendChild(i),i.style.bottom="80px",i.style.left="50%",i.style.transform="translateX(-50%)",i.querySelector(".undo-button").addEventListener("click",()=>{t(),i.remove()}),setTimeout(()=>{i.parentNode&&i.remove()},5e3)}setupTimelineSwipe(e,t){let i,s=!1;e.addEventListener("touchstart",e=>{i=e.touches[0].clientY,s=!0}),e.addEventListener("touchmove",t=>{if(!s)return;const a=t.touches[0].clientY-i;a<-30&&(t.preventDefault(),e.style.transform=`translateY(${a}px)`,e.style.opacity=""+(1-Math.abs(a)/100))}),e.addEventListener("touchend",a=>{if(!s)return;a.changedTouches[0].clientY-i<-60&&this.removeFrameWithUndo(t),e.style.transform="",e.style.opacity="",s=!1})}showFrameTimeDialog(e){const t=document.createElement("div");t.innerHTML=`\n    <div style="margin-bottom: 15px;">\n      <label style="display: block; margin-bottom: 5px;">${__("Tiempo del Frame||Frame Time")} (ms):</label>\n      <input type="number" id="frame-time-value" value="${this.frameTimes[e]}" min="1" max="5000" style="width: 100%; padding: 5px;">\n    </div>\n  `,this.showPopup(__("Cambiar Tiempo del Frame||Set Frame Time"),t,[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.hidePopup()},{text:__("Aplicar||Apply"),action:()=>{const t=parseInt(document.getElementById("frame-time-value").value);t>=1&&t<=5e3&&(this.setFrameTime(e,t),this.updateFramesUI(),this.hidePopup())}}])}updateFPS(){const e=parseInt(this.fpsInput.value);if(e>=1&&e<=60){const t=this.animationFPS;this.animationFPS=e,this.currentFrameTime=1e3/e,this.frameTimes.every(e=>e===1e3/t)&&(this.frameTimes=this.frameTimes.map(()=>this.currentFrameTime));const i={type:"change_animation_fps",description:"Change Animation FPS",oldFPS:t,newFPS:e};this.historyManager.addChange(i),this.updateFramesUI(),this.isPlaying&&(this.stopAnimation(),this.startAnimation())}}togglePlayback(){this.isPlaying?this.stopAnimation():this.startAnimation()}togglePlayback(){this.isPlaying?this.stopAnimation():this.startAnimation()}startAnimation(){if(this.project.frames.length<=1)return;this.isPlaying=!0,this.playPauseButton.querySelector(".icon").className="icon icon-pause";let e=this.project.currentFrame,t=Date.now(),i=0;this.animationInterval=setInterval(()=>{const s=Date.now();i+=s-t-i;let a=0,o=e;for(let e=0;e<this.frameTimes.length;e++)if(a+=this.frameTimes[e],i<a){o=e;break}i>=a&&(i=0,o=0,t=Date.now()),o!==e&&(e=o,this.project.currentFrame=e,this.updateFramesUI(),this.updateAnimationPreview(),this.render())},16)}stopAnimation(){this.isPlaying=!1,this.playPauseButton&&(this.playPauseButton.querySelector(".icon").className="icon icon-play"),this.animationInterval&&(clearInterval(this.animationInterval),this.animationInterval=null)}prevFrame(){this.project.frames.length<=1||(this.project.currentFrame=(this.project.currentFrame-1+this.project.frames.length)%this.project.frames.length,this.updateFramesUI(),this.updateAnimationPreview(),this.render())}nextFrame(){this.project.frames.length<=1||(this.project.currentFrame=(this.project.currentFrame+1)%this.project.frames.length,this.updateFramesUI(),this.updateAnimationPreview(),this.render())}updateAnimationPreview(){if(!this.project||!this.animationPreview)return;const e=this.project.frames[this.project.currentFrame];this.animationPreview.width=this.project.width,this.animationPreview.height=this.project.height;const t=this.getCanvasContext(this.animationPreview);t.clearRect(0,0,this.animationPreview.width,this.animationPreview.height),this.transparentBackground||(t.fillStyle=this.secondaryColor,t.fillRect(0,0,this.animationPreview.width,this.animationPreview.height));for(let i=0;i<e.layers.length;i++)e.layers[i].visible&&t.drawImage(e.layers[i].canvas,0,0,this.project.width,this.project.height,0,0,this.animationPreview.width,this.animationPreview.height)}hasTransparency(e){const t=this.getCanvasContext(e).getImageData(0,0,e.width,e.height).data;for(let e=3;e<t.length;e+=4)if(t[e]<255)return!0;return!1}showFPSDialog(){const e=document.createElement("div");e.innerHTML=`\n    <div style="margin-bottom: 15px;">\n      <label style="display: block; margin-bottom: 5px;">${__("Frames Por Segundo||Frames Per Second")}:</label>\n      <input type="number" id="fps-value" value="${this.animationFPS}" min="1" max="60" style="width: 100%; padding: 5px;">\n    </div>\n  `,this.showPopup(__("Cambiar FPS||Set Animation FPS"),e,[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.hidePopup()},{text:__("Aplicar||Apply"),action:()=>{const e=parseInt(document.getElementById("fps-value").value);e>=1&&e<=60&&(this.animationFPS=e,this.fpsInput.value=e,this.currentFrameTime=1e3/e,this.updateFPS(),this.hidePopup())}}])}showCurrentFrameTimeDialog(){this.showFrameTimeDialog(this.project.currentFrame)}initFileHandling(){this.isCordova=void 0!==window.cordova,this.isFilePluginAvailable=this.isCordova&&void 0!==window.File,this.lastSavedPath=null}openFile(){this.getFileBrowser({mode:"open",fileTypes:["pxl","png","jpg","jpeg","pal"],onConfirm:async e=>{try{const t=await this.readFile(e);"pxl"===e.type?this.loadProject(t):"pal"===e.type?(this.parsePalFile(t),this.updatePaletteGrid(),this.showNotification(__(`(Paleta|Palette) ${e.name} (cargada|loaded)`))):this.importImage(t,e.name),this.showNotification(__(`(Archivo|File) ${e.name} (abierto|opened)`)),this.menuPanel.classList.remove("visible")}catch(e){this.showNotification(`Error opening file: ${e.message}`,5e3),console.error(e)}},onError:e=>{this.showNotification(`File error: ${e.message}`,5e3)}}).show()}saveProject(e){this.project&&(this.lastSavedPath?this.saveFile(this.lastSavedPath,"pxl",this.getProjectData()):e||this.saveAs())}saveAs(){this.getFileBrowser({mode:"saveAs",fileTypes:["pxl","png"],defaultType:"pxl",defaultName:this.project.name||"untitled",onConfirm:async e=>{try{if(this.lastSavedPath=e.name,"pxl"===e.type)await this.saveFile(e.name,"pxl",this.getProjectData());else{const t=this.canvas.toDataURL("image/png");await this.saveFile(e.name,"png",t)}this.showNotification(`File saved as ${e.name}`)}catch(e){this.showNotification(`Error saving file: ${e.message}`,5e3),console.error(e)}}}).show()}exportCurrentFrame(){if(!this.project)return;this.getFileBrowser({title:"Export frame",mode:"saveAs",fileTypes:["png"],defaultType:"png",defaultName:`frame_${this.project.currentFrame+1}`,onConfirm:async e=>{try{const t=this.project.frames[this.project.currentFrame],i=this.renderFrameToCanvas(t).toDataURL("image/png");await this.saveFile(e.name,"png",i),this.showNotification(`Frame exported as ${e.name}`)}catch(e){this.showNotification(`Error exporting frame: ${e.message}`,5e3),console.error(e)}}}).show()}exportAnimation(){if(!this.project||this.project.frames.length<=1)return void this.showNotification("Project has only one frame",3e3);this.getFileBrowser({title:"Export animation sheet",mode:"saveAs",fileTypes:["png"],defaultType:"png",defaultName:`animation_${this.project.name||Date.now()}`,onConfirm:async e=>{try{const t=this.createSpriteSheet().toDataURL("image/png");await this.saveFile(e.name,"png",t),this.showNotification(`Animation exported as ${e.name}`)}catch(e){this.showNotification(`Error exporting animation: ${e.message}`,5e3),console.error(e)}}}).show()}async readFile(e){if(e.entry)return this.readCordovaFile(e.entry);if(e.file)return this.readBrowserFile(e.file);throw new Error("Unsupported file source")}async readCordovaFile(e){return new Promise((t,i)=>{e.file(e=>{const s=new FileReader;s.onloadend=()=>t(s.result),s.onerror=()=>i(new Error("Failed to read file")),e.name.endsWith(".pxl")||e.name.endsWith(".anim")||e.name.endsWith(".pal")||e.name.endsWith(".txt")?s.readAsText(e):s.readAsDataURL(e)},e=>{i(new Error(`Could not read file: ${e.code}`))})})}async readBrowserFile(e){return new Promise((t,i)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>i(new Error("Failed to read file")),e.name.endsWith(".pxl")||e.name.endsWith(".anim")||e.name.endsWith(".pal")||e.name.endsWith(".txt")?s.readAsText(e):s.readAsDataURL(e)})}async saveFile(e,t,i){if(this.isCordova&&this.isFilePluginAvailable)try{await this.saveWithCordova(e,t,i)}catch(s){console.error("Cordova save failed, falling back to browser:",s),this.saveWithBrowser(e,t,i)}else this.saveWithBrowser(e,t,i)}async saveWithCordova(e,t,i){return new Promise((s,a)=>{window.requestFileSystem||(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem),window.requestFileSystem?window.requestFileSystem(window.PERSISTENT||1,5242880,o=>{o.root.getFile(this.fileBrowser.workingDirectory+e,{create:!0,exclusive:!1},o=>{o.createWriter(o=>{let n;o.onwriteend=()=>{this.lastSavedPath=e,s()},o.onerror=e=>{a(new Error(`File write error: ${e.code}`))},n="pxl"===t?new Blob([i],{type:"application/json"}):this.dataURLtoBlob(i),o.write(n)},e=>{a(new Error(`Could not create file writer: ${e.code}`))})},e=>{a(new Error(`Could not create file: ${e.code}`))})},e=>{a(new Error(`Could not access file system: ${e.code}`))}):a(new Error("File system API not available"))})}async saveWithBrowser(e,t,i){try{let s;s=i instanceof Blob?i:"pxl"===t?new Blob([i],{type:"application/json"}):"pal"===t?new Blob([i],{type:"text/plain"}):this.dataURLtoBlob(i);const a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(a)},100)}catch(e){console.error("Browser save failed:",e),this.showNotification(__("Error al guardar||Failed to save file"),3e3)}}async exportTimelapse(){if(!this.project||!this.historyManager.history.length)return void this.showNotification(__("No hay suficiente historia para exportar el proceso||Not enough history to export a timelapse!"));const e=document.createElement("div");e.innerHTML=`\n      <div style="margin-bottom: 15px;">\n        <label style="display: block; margin-bottom: 5px;">FPS:</label>\n        <input type="number" id="timelapse-fps" value="${this.timelapseFPS}" min="1" max="60" style="width: 100%; padding: 5px;">\n      </div>\n      <div style="margin-bottom: 15px;">\n        <label style="display: block; margin-bottom: 5px;">${__("Escala||Scale")}:</label>\n        <input type="number" id="timelapse-scale" value="4" min="1" max="10" style="width: 100%; padding: 5px;">\n      </div>\n      <img style="display:none;image-rendering:pixelated;width:100%;height:auto;background-color:#fff;border:1px solid #000" class="timelapse-preview">\n      <div class="timelapse-progress" style="display: none;">\n        <div style="text-align: center; margin-bottom: 5px;">${__("Generando||Generating")} timelapse...</div>\n        <progress value="0" max="100" style="width: 100%;"></progress>\n        <div class="progress-text" style="text-align: center; margin-top: 5px;">0%</div>\n      </div>\n    `;const t=e.querySelector(".timelapse-progress"),i=e.querySelector("progress"),s=e.querySelector(".progress-text");this.showPopup(__("Exportar Timelapse||Export Timelapse"),e,[{text:__("Cancelar||Cancel"),class:"cancel",action:()=>this.hidePopup()},{text:__("Generar||Generate"),action:async()=>{const a=parseInt(document.getElementById("timelapse-fps").value)||30,o=parseInt(document.getElementById("timelapse-scale").value)||4;e.querySelector("div:first-child").style.display="none",e.querySelector("div:nth-child(2)").style.display="none",t.style.display="block",this.hidePopupButtons();try{const t=await this.generateTimelapse(a,o,(t,a)=>{i.value=t,s.textContent=`${t}%`;const o=e.querySelector(".timelapse-preview");o&&a&&(o.style.display="flex",o.src=a)});this.hidePopup(),this.saveTimelapseWithBrowser(t)}catch(e){this.showNotification(`Error generating timelapse: ${e.message}`,5e3)}}}])}async generateTimelapse(e,t,i){return this.historyManager.generateTimelapse(e,t,i)}saveTimelapseWithBrowser(e){this.getFileBrowser({mode:"saveAs",fileTypes:["webm"],defaultType:"webm",defaultName:`timelapse_${this.project.name||"artwork"}_${this.formatDate(new Date)}`,onConfirm:async t=>{try{await this.saveFile(t.name,"webm",e),this.showNotification(__("Timelapse exportado||Timelapse saved successfully"))}catch(e){this.showNotification(`Error saving timelapse: ${e.message}`,5e3)}}}).show()}getFileBrowser(e={}){return this.fileBrowser?this.fileBrowser.updateOptions({onConfirm:e.onConfirm,onCancel:e.onCancel,onError:e.onError,title:e.title||null,fileTypes:e.fileTypes||["pxl","png"],mode:e.mode||"open",defaultType:e.defaultType||"pxl",defaultName:e.defaultName||"untitled"}):(this.fileBrowser=new FileBrowser({container:this.container,onConfirm:e.onConfirm,onCancel:e.onCancel,onError:e.onError,title:e.title||null,fileTypes:e.fileTypes||["pxl","png"],mode:e.mode||"open",defaultType:e.defaultType||"pxl",defaultName:e.defaultName||"untitled"}),this.fileBrowser.currentPath=this.defaultFileBrowserPathUrl),this.fileBrowser}requestStorageQuota(){return new Promise((e,t)=>{window.webkitStorageInfo?window.webkitStorageInfo.requestQuota(window.PERSISTENT,5242880,()=>e(),e=>t(new Error(`Quota request failed: ${e.code}`))):navigator.webkitPersistentStorage?navigator.webkitPersistentStorage.requestQuota(5242880,()=>e(),e=>t(new Error(`Quota request failed: ${e.code}`))):e()})}loadProject(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){throw new Error("Invalid project file format: Not valid JSON")}if(!e||!e.width||!e.height)throw new Error("Invalid project file format: Missing width or height");if(this.project={width:e.width,height:e.height,frames:[],floatingColors:e.floatingColors||0,currentFrame:e.currentFrame||0,currentLayer:e.currentLayer||0,name:e.name||"untitled"},this.frameTimes=e.frameTimes||new Array(e.frames.length).fill(1e3/(e.fps||12)),this.animationFPS=e.fps||12,this.currentFrameTime=1e3/this.animationFPS,e.backgroundColor&&(this.transparentBackground="transparent"===e.backgroundColor,this.transparentBackground||(this.secondaryColor=e.backgroundColor)),!e.frames||!Array.isArray(e.frames))throw new Error("Invalid project file format: Missing or invalid frames array");for(let t=0;t<e.frames.length;t++){const i=e.frames[t],s={layers:[]};i.layers&&Array.isArray(i.layers)||(console.warn(`Frame ${t} has invalid layers array, creating default layer`),i.layers=[{name:"Layer 1",visible:!0,imageData:null}]);for(let e=0;e<i.layers.length;e++){const a=i.layers[e],o=this.createBlankLayer(this.project.width,this.project.height);if(o.name=a.name||`Layer ${e+1}`,o.visible=void 0===a.visible||a.visible,a.imageData&&Array.isArray(a.imageData))try{const e=o.ctx,t=new ImageData(new Uint8ClampedArray(a.imageData),this.project.width,this.project.height);e.putImageData(t,0,0)}catch(i){console.error(`Error loading image data for frame ${t}, layer ${e}:`,i)}s.layers.push(o)}this.project.frames.push(s)}e.history?this.historyManager.deserialize(e.history):this.historyManager.clear(),e.floatingColors&&this.loadFloatingColors(JSON.parse(e.floatingColors)),this.resizeCanvas(),this.resetZoom(),this.updateFramesUI(),this.updateLayersUI(),this.render()}recreateProjectCanvases(){for(let e=0;e<this.project.frames.length;e++){const t=this.project.frames[e];for(let e=0;e<t.layers.length;e++){const i=t.layers[e];i.canvas=document.createElement("canvas"),i.canvas.width=this.project.width,i.canvas.height=this.project.height,i.imageData&&this.drawImageToCanvas(i.canvas,i.imageData)}}}drawImageToCanvas(e,t){return new Promise(i=>{const s=new Image;s.onload=()=>{this.getCanvasContext(e).drawImage(s,0,0),i()},s.src=t})}importImage(e,t="Imported Image"){return new Promise(t=>{const i=new Image;i.onload=()=>{this.newProject(i.width,i.height,i),this.updateLayersUI(),this.updateFramesUI(),this.render(),t()},i.src=e})}getProjectData(){const e={version:this.version,width:this.project.width,height:this.project.height,frames:[],floatingColors:this.getFloatingColorsData(),frameTimes:this.frameTimes,fps:this.animationFPS,backgroundColor:this.transparentBackground?"transparent":this.secondaryColor,createdAt:(new Date).toISOString(),history:this.historyManager.serialize(),currentFrame:this.project.currentFrame,currentLayer:this.project.currentLayer};for(let t=0;t<this.project.frames.length;t++){const i=this.project.frames[t],s={layers:[]};for(let e=0;e<i.layers.length;e++){const t=i.layers[e],a=t.ctx.getImageData(0,0,this.project.width,this.project.height);s.layers.push({name:t.name||`Layer ${e+1}`,visible:void 0===t.visible||t.visible,imageData:Array.from(a.data)})}e.frames.push(s)}return JSON.stringify(e)}compressJSON(e){const t=JSON.stringify(e);let i="",s=1,a=t[0];for(let e=1;e<=t.length;e++){const o=t[e];o===a&&s<255?s++:(i+=s>3?`${String.fromCharCode(s)}${a}`:a.repeat(s),s=1,a=o)}return Object.entries({'{"':"",'"}':"",'":':"",',"':"",',"_':"",true:"",false:"\b",null:"\t","[]":"\n","{}":"\v"}).forEach(([e,t])=>{i=i.split(e).join(t)}),i}decompressJSON(e){let t=e;Object.entries({"":'{"',"":'"}',"":'":',"":',"',"":',"_',"":"true","\b":"false","\t":"null","\n":"[]","\v":"{}"}).forEach(([e,i])=>{t=t.split(e).join(i)});let i="",s=0;for(;s<t.length;)if(""===t[s]&&s+2<t.length){const e=t.charCodeAt(s+1);i+=t[s+2].repeat(e),s+=3}else i+=t[s],s++;return JSON.parse(i)}serializeSnapshot(e){if(!e)return null;const t={frames:[],currentFrame:e.currentFrame,currentLayer:e.currentLayer};for(let i=0;i<e.frames.length;i++){const s=e.frames[i],a={layers:[]};for(let e=0;e<s.layers.length;e++){const t=s.layers[e];a.layers.push({name:t.name,visible:t.visible,imageData:t.imageData?Array.from(t.imageData.data):null})}t.frames.push(a)}return t}deserializeSnapshot(e){if(!e)return null;const t={frames:[],currentFrame:e.currentFrame,currentLayer:e.currentLayer};for(let i=0;i<e.frames.length;i++){const s=e.frames[i],a={layers:[]};for(let e=0;e<s.layers.length;e++){const t=s.layers[e],i=t.imageData?new ImageData(new Uint8ClampedArray(t.imageData),this.project.width,this.project.height):null,o=document.createElement("canvas");o.width=this.project.width,o.height=this.project.height,this.drawImageToCanvas(o,i);const n={name:t.name,visible:t.visible,imageData:i,canvas:o,ctx:this.getCanvasContext(o)};a.layers.push(n)}t.frames.push(a)}return t}renderFrameToCanvas(e){const t=document.createElement("canvas");t.width=this.project.width,t.height=this.project.height;const i=this.getCanvasContext(t);for(let t=0;t<e.layers.length;t++){const s=e.layers[t];s.visible&&i.drawImage(s.canvas,0,0)}return t}createSpriteSheet(){const e=this.project.frames.length,t=Math.ceil(Math.sqrt(e)),i=Math.ceil(e/t),s=document.createElement("canvas");s.width=t*this.project.width,s.height=i*this.project.height;const a=this.getCanvasContext(s);for(let i=0;i<e;i++){const e=i%t,s=Math.floor(i/t),o=this.project.frames[i];for(let t=0;t<o.layers.length;t++){const i=o.layers[t];i.visible&&a.drawImage(i.canvas,e*this.project.width,s*this.project.height)}}return s}dataURLtoBlob(e){try{if(e instanceof Blob)return e;const t=e.split(","),i=t[0].match(/:(.*?);/)[1],s=atob(t[1]),a=new ArrayBuffer(s.length),o=new Uint8Array(a);for(let e=0;e<s.length;e++)o[e]=s.charCodeAt(e);return new Blob([a],{type:i})}catch(e){throw console.error("Error converting data URL to blob:",e),new Error("Invalid data URL format")}}distance(e,t,i,s){var a=e-i,o=t-s;return Math.sqrt(a*a+o*o)}getCurrentLayerContext(){if(!this.project)return null;return this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx}getPixelColor(e,t){if(!this.project||e<0||t<0||e>=this.project.width||t>=this.project.height)return null;const i=this.project.frames[this.project.currentFrame].layers[this.project.currentLayer].ctx;return this.getPixelColorFromCtx(i,e,t)}getPixelColorFromCtx(e,t,i){const s=e.getImageData(t,i,1,1);return 0===s.data[3]?"transparent":`#${this.componentToHex(s.data[0])}${this.componentToHex(s.data[1])}${this.componentToHex(s.data[2])}`}componentToHex(e){const t=e.toString(16);return 1===t.length?"0"+t:t}setColor(e){"primary"===this.selectedColor?this.primaryColor=e:this.secondaryColor=e,this.updateColorIndicator()}formatDate(e){const t=e=>e.toString().padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}_${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}isValidHex(e){return/^#?([a-f\d]{3}|[a-f\d]{6})$/i.test(e)}getColor(){return"primary"==this.selectedColor?this.primaryColor:this.secondaryColor}exitApp(){this.showPopup(__("Cerrar App||Exit App"),__("¿Estás seguro de que quieres irte ahora? Cualquier cambio no guardado se perderá para siempre.||Are you sure you want to leave now? Any unsaved changes will be lost forever."),[{text:"No",class:"cancel",action:()=>this.hidePopup()},{text:__("Sí||Yes"),action:()=>navigator.app.exitApp()}])}}